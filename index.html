<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
<title>XPO ‚Äî Registro de Plataformas (Apple FX)</title>

<!-- Sin dependencias externas para estilos (offline-friendly) -->
<style>
/* ===== Minimal Normalize / Reset (inline) ===== */
*{box-sizing:border-box}html,body{height:100%}body{margin:0}
h1,h2,h3,h4,p{margin:0}button,input,textarea{font:inherit}
img,svg,video{display:block;max-width:100%}

/* ===== Design Tokens (Apple-like) ===== */
:root{
  --accent:#0A84FF;           /* iOS blue */
  --bg:#F5F6F7;
  --panel:#FFFFFF;
  --line:#E6E6EA;
  --text:#111418;
  --muted:#6A6F75;
  --ok:#34C759;
  --warn:#FF9F0A;
  --danger:#FF3B30;
  --radius:18px;
  --shadow-1:0 10px 28px rgba(0,0,0,.06);
  --shadow-2:0 4px 18px rgba(0,0,0,.07);
  --ease-snap:cubic-bezier(.22,1,.36,1);   /* ‚Äúspringy‚Äù */
  --ease-soft:cubic-bezier(.25,.8,.25,1);
  --blur:18px;
  --glass:rgba(255,255,255,.68);
}

/* Dark mode autom√°tico */
@media (prefers-color-scheme: dark){
  :root{
    --bg:#0C0D0F; --panel:#111214; --line:#23252A; --text:#ECEFF4; --muted:#9AA0A6;
    --glass:rgba(20,22,26,.55); --shadow-1:0 10px 30px rgba(0,0,0,.35); --shadow-2:0 6px 22px rgba(0,0,0,.45);
  }
}

/* Motion-safe defaults */
@media (prefers-reduced-motion: reduce){
  *{animation-duration:.001ms !important; animation-iteration-count:1 !important; transition-duration:.001ms !important; scroll-behavior:auto !important}
}

/* ===== Base ===== */
html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizeLegibility}
body{
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display",system-ui,Segoe UI,Roboto,Helvetica,Arial;
  background:radial-gradient(1200px 600px at 10% -10%, rgba(10,132,255,.06), transparent 60%), var(--bg);
  color:var(--text); line-height:1.45; letter-spacing:.01em;
}
input,textarea,button{font-size:16px} /* evita zoom iOS */
button{touch-action:manipulation;-webkit-tap-highlight-color:transparent}

.app{
  max-width:1040px;margin:0 auto;
  padding: calc(18px + env(safe-area-inset-top)) 16px calc(28px + env(safe-area-inset-bottom)) 16px;
}

/* ===== Header ‚Äúglass‚Äù con parallax ===== */
.header{
  position:sticky; top:12px; z-index:10;
  border-radius:22px; padding:22px 20px;
  background:var(--glass);
  border:1px solid rgba(120,120,140,.22);
  backdrop-filter:saturate(1.4) blur(var(--blur));
  box-shadow:var(--shadow-1);
  overflow:hidden; isolation:isolate; transform:translateZ(0);
}
.header::before{
  content:""; position:absolute; inset:0;
  background:linear-gradient(180deg, rgba(10,132,255,.10), transparent 60%);
  pointer-events:none;
}
.brand{display:flex;align-items:center;justify-content:center;gap:10px;font-weight:800;letter-spacing:.12em}
.chip{background:rgba(242,243,244,.8);border:1px solid var(--line);padding:6px 10px;border-radius:10px;font-weight:800}
@media (prefers-color-scheme: dark){ .chip{background:rgba(255,255,255,.06)} }
.headline{margin:8px 0 4px;text-align:center;font-weight:800;font-size:clamp(20px,3.3vw,28px)}
.subtle{text-align:center;color:var(--muted);font-weight:600}

/* Parallax sutil del header (shadow scroll) */
.header[data-depth]{transform:translateZ(0)}
/* se controla por JS: translateY */

/* ===== Card de flujo ===== */
.card{
  background:var(--panel); border:1px solid var(--line); border-radius:var(--radius);
  box-shadow:var(--shadow-2); padding:0; margin:18px 0; overflow:hidden;
  transition:transform .35s var(--ease-soft), box-shadow .35s var(--ease-soft);
}
.card:hover{transform:translateY(-2px); box-shadow:0 10px 32px rgba(0,0,0,.12)}
.card:has(.screen.active:focus-within){outline:2px solid rgba(10,132,255,.18)}

.card-header{
  display:flex;align-items:center;justify-content:space-between;gap:8px;
  padding:14px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#FBFBFD,transparent);
}
@media (prefers-color-scheme: dark){
  .card-header{background:linear-gradient(180deg,rgba(255,255,255,.03),transparent)}
}
.chevron{opacity:.65;user-select:none}
.title-lg{font-weight:800;letter-spacing:.02em}

/* Pantallas con transiciones ‚Äúspringy‚Äù */
.card-content{position:relative;min-height:260px; perspective:1000px}
.screen{
  position:absolute; inset:0; padding:18px 16px;
  display:flex; flex-direction:column; gap:14px; align-items:center; justify-content:center;
  opacity:0; transform:translateX(24px) translateZ(0) scale(.985); pointer-events:none;
  transition:opacity .44s var(--ease-snap), transform .44s var(--ease-snap);
}
.screen.active{opacity:1; transform:none; pointer-events:auto}
.screen.out-left{animation:slideOutL .36s var(--ease-snap)}
.screen.out-right{animation:slideOutR .36s var(--ease-snap)}

@keyframes slideOutL{from{opacity:1;transform:none}to{opacity:0;transform:translateX(-24px) scale(.985)}}
@keyframes slideOutR{from{opacity:1;transform:none}to{opacity:0;transform:translateX(24px) scale(.985)}}

.steps{display:flex;gap:8px;justify-content:center;padding:10px 0 2px}
.dot{width:10px;height:10px;border-radius:999px;background:#D4D6DA;transition:transform .25s var(--ease-snap), background .25s}
.dot.active{background:var(--accent);transform:scale(1.35)}

/* Inputs */
.input,.textarea{
  width:100%;max-width:520px;padding:14px 16px;border-radius:12px;border:1px solid var(--line);background:#fff;
  outline:none;transition:border-color .22s var(--ease-soft), box-shadow .22s var(--ease-soft), transform .12s;
}
.input:focus,.textarea:focus{border-color:var(--accent);box-shadow:0 0 0 8px rgba(10,132,255,.12);transform:translateY(-1px)}
.textarea{min-height:120px;resize:vertical}
@media (prefers-color-scheme: dark){
  .input,.textarea{background:#0F1114;color:var(--text)}
}

/* Botones ‚Äúmagn√©ticos‚Äù */
.row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
.btn{
  position:relative;
  display:inline-flex;align-items:center;justify-content:center;gap:8px;
  padding:12px 18px;border:0;border-radius:12px;font-weight:700;color:#fff;background:#1C1C1E;
  box-shadow:0 1px 0 rgba(0,0,0,.04), 0 8px 20px rgba(0,0,0,.10);
  transition:transform .14s var(--ease-snap), filter .18s var(--ease-soft), box-shadow .2s var(--ease-soft);
  will-change:transform;
}
.btn:active{transform:scale(.985)}
.btn:disabled{opacity:.6;transform:none}
.btn-primary{background:var(--accent)}
.btn-secondary{background:#8E8E93}
.btn-danger{background:var(--danger)}
.btn-cargada{background:var(--danger)}
.btn-vacia{background:var(--ok)}
.btn-averiada{background:var(--warn)}

/* ===== Panels / Stats / Lists ===== */
.panel{
  background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);
  padding:18px;box-shadow:var(--shadow-2);margin:18px 0;
}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
.stat{
  background:linear-gradient(180deg,#FBFBFC,transparent);
  border:1px solid var(--line);border-radius:12px;padding:16px;text-align:center;
  transition:transform .2s var(--ease-snap), box-shadow .2s var(--ease-snap);
}
.stat:hover{transform:translateY(-2px); box-shadow:0 8px 22px rgba(0,0,0,.08)}
.stat .n{display:block;font-size:clamp(24px,4vw,32px);font-weight:800;margin-bottom:2px;color:var(--accent)}
.stat .label{color:var(--muted);font-weight:600}
.lists{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
.list h3{margin:0 0 10px;font-size:16px}
.empty{padding:14px;border:1px dashed var(--line);border-radius:12px;color:var(--muted);text-align:center;font-style:italic}
.card-row{
  background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px 14px;margin-bottom:10px;
  transition:transform .18s var(--ease-snap), box-shadow .18s var(--ease-snap), background .2s;
}
.card-row:hover{transform:translateY(-1px);box-shadow:var(--shadow-2);background:linear-gradient(180deg,#FBFBFC,transparent)}
@media (prefers-color-scheme: dark){
  .card-row{background:#0F1114}
}

/* ===== Helpers ===== */
.kbd{font-weight:700;padding:2px 6px;border-radius:6px;border:1px solid var(--line);background:rgba(0,0,0,.04)}
.hint{color:var(--muted);font-size:12px;text-align:center;margin-top:6px}
@media (max-width:640px){ .row .btn{flex:1 1 100%} }
</style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header" id="glassHeader" data-depth="0.18">
      <div class="brand">
        <div class="chip">CODE</div>
        <div>XPO LOGISTICS</div>
      </div>
      <div class="headline">Registro de Plataformas</div>
      <div class="subtle" id="currentDate"></div>
    </header>

    <!-- Single Card Flow -->
    <section class="card" id="flowCard" aria-live="polite">
      <div class="card-header">
        <div class="chevron" aria-hidden="true">‚ü®</div>
        <div class="title-lg" id="flowTitle">Matr√≠cula</div>
        <div class="chevron" aria-hidden="true">‚ü©</div>
      </div>
      <div class="card-content" id="screens">
        <!-- S1 -->
        <div class="screen active" id="s1" tabindex="-1">
          <h2 style="margin:0;font-weight:800;font-size:18px">Paso 1: Matr√≠cula de la plataforma</h2>
          <input id="matriculaInput" class="input" autocomplete="off" placeholder="Introduce la matr√≠cula" />
          <div class="hint">Consejo: pulsa <span class="kbd">Enter</span> para continuar.</div>
          <button class="btn btn-primary" id="toS2" aria-label="Continuar a Estado">Continuar</button>
        </div>
        <!-- S2 -->
        <div class="screen" id="s2" tabindex="-1">
          <h2 style="margin:0;font-weight:800;font-size:18px">Paso 2: Estado</h2>
          <p class="subtle">Matr√≠cula: <strong id="matriculaDisplay">‚Äî</strong></p>
          <div class="row" role="group" aria-label="Selecciona estado">
            <button class="btn btn-cargada" id="btnCargada">CARGADA</button>
            <button class="btn btn-vacia" id="btnVacia">VAC√çA</button>
            <button class="btn btn-averiada" id="btnAveriada">üõ† AVERIADA</button>
          </div>
          <div class="row">
            <button class="btn btn-secondary" id="back1" aria-label="Volver a matr√≠cula">Volver</button>
          </div>
          <div class="hint">Gesto: desliza <span class="kbd">‚ÜîÔ∏é</span> para navegar pasos.</div>
        </div>
        <!-- S3 -->
        <div class="screen" id="s3" tabindex="-1">
          <h2 style="margin:0;font-weight:800;font-size:18px">Paso 3: Contenido</h2>
          <p class="subtle">Matr√≠cula: <strong id="matriculaDisplay2">‚Äî</strong> ‚Äî Estado: <strong id="estadoDisplay">‚Äî</strong></p>
          <textarea id="contenidoInput" class="textarea" placeholder="Describe el contenido o el problema‚Ä¶"></textarea>
          <div class="row">
            <button class="btn btn-primary" id="btnRegistrar">Registrar</button>
            <button class="btn btn-secondary" id="back2">Volver</button>
          </div>
          <div class="hint">Atajo: <span class="kbd">‚åò/Ctrl</span> + <span class="kbd">Enter</span> para registrar.</div>
        </div>
      </div>
      <div class="steps" aria-hidden="true">
        <div class="dot active" id="d1"></div>
        <div class="dot" id="d2"></div>
        <div class="dot" id="d3"></div>
      </div>
    </section>

    <!-- Summary -->
    <section class="panel">
      <h3 style="text-align:center;margin:0 0 10px;font-size:16px">Resumen del d√≠a</h3>
      <div class="stats">
        <div class="stat"><span class="n" id="cargadasCount">0</span><span class="label">Plataformas cargadas</span></div>
        <div class="stat"><span class="n" id="vaciasCount">0</span><span class="label">Plataformas vac√≠as</span></div>
        <div class="stat"><span class="n" id="averiadasCount">0</span><span class="label">üõ† Averiadas</span></div>
        <div class="stat"><span class="n" id="totalCount">0</span><span class="label">Total</span></div>
      </div>
    </section>

    <!-- Lists -->
    <section class="panel">
      <div class="lists">
        <div class="list">
          <h3>Plataformas cargadas (<span id="cargadasListCount">0</span>)</h3>
          <div id="cargadasList"></div>
        </div>
        <div class="list">
          <h3>Plataformas vac√≠as (<span id="vaciasListCount">0</span>)</h3>
          <div id="vaciasList"></div>
        </div>
        <div class="list">
          <h3>üõ† Plataformas averiadas (<span id="averiadasListCount">0</span>)</h3>
          <div id="averiadasList"></div>
        </div>
      </div>
    </section>

    <!-- Actions -->
    <section class="panel actions" style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
      <button class="btn btn-primary" id="genPdf">üìÑ Generar PDF</button>
      <button class="btn btn-danger" id="clearAll">üóë Limpiar registros</button>
    </section>
  </div>

<!-- jsPDF (mantengo la misma l√≥gica; si necesitas 100% offline, incrustamos el script minificado) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ===== Utilities & State (mantenido + mejoras sutiles) ===== */
const $ = (id)=>document.getElementById(id);
const fmtDateLong = (d=new Date()) => d.toLocaleDateString('es-ES', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
const fmtHour = () => new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit',second:'2-digit'});

let plataformas = [];
let currentMatricula = '';
let currentEstado = '';

const STORAGE_KEY = 'plataformas-global';
function loadData(){ try{ const raw=localStorage.getItem(STORAGE_KEY); plataformas=raw?JSON.parse(raw):[] }catch(e){ plataformas=[] } }
function saveData(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(plataformas)); }catch(e){} }

/* ===== Single Card Flow logic (igual que base) ===== */
let step = 1;
function showStep(next, dir='forward'){
  const cur = $('s'+step);
  const nxt = $('s'+next);
  if(!nxt || cur===nxt) return;
  cur.classList.remove('active');
  cur.classList.add(dir==='forward' ? 'out-left':'out-right');
  setTimeout(()=>{ cur.classList.remove('out-left','out-right') }, 360);

  nxt.classList.add('active');
  $('d1').classList.toggle('active', next===1);
  $('d2').classList.toggle('active', next===2);
  $('d3').classList.toggle('active', next===3);

  $('flowTitle').textContent = next===1 ? 'Matr√≠cula' : next===2 ? 'Estado' : 'Contenido';
  step = next;

  // Auto-focus amigable
  requestAnimationFrame(()=>{ nxt.focus({preventScroll:true}); });
}

function nextFromS1(){
  const m = $('matriculaInput').value.trim().toUpperCase();
  if(!m){ alert('Por favor, introduce una matr√≠cula v√°lida'); haptics(40); return; }
  currentMatricula = m;
  $('matriculaDisplay').textContent = m;
  $('matriculaDisplay2').textContent = m;
  showStep(2,'forward'); haptics(10);
}

function chooseEstado(estado){
  currentEstado = estado;
  $('estadoDisplay').textContent = estado;

  // Ruta r√°pida VAC√çA (misma l√≥gica original)
  if(estado==='VAC√çA'){
    if(!currentMatricula){ alert('Introduce primero una matr√≠cula v√°lida'); showStep(1,'back'); return; }
    const dup = plataformas.some(p => p.matricula===currentMatricula && p.estado==='VAC√çA');
    if(dup){ alert('‚ö†Ô∏è Esta matr√≠cula ya fue registrada como VAC√çA.'); resetFlow(); return; }
    plataformas.push({ id:Date.now(), matricula:currentMatricula, estado, contenido:'', timestamp:fmtHour() });
    saveData(); updateAll(); resetFlow(); haptics(5);
  }else{
    showStep(3,'forward'); haptics(8);
  }
}

function registrar(){
  const contenido = $('contenidoInput').value.trim();
  if(!contenido){ alert('Describe el contenido o el problema'); haptics(40); return; }
  plataformas.push({ id:Date.now(), matricula:currentMatricula, estado:currentEstado, contenido, timestamp:fmtHour() });
  saveData(); updateAll();

  const btn=$('btnRegistrar'); const prev=btn.textContent;
  btn.disabled=true; btn.textContent='Registrando‚Ä¶';
  setTimeout(()=>{ btn.textContent='Registrado ‚úì'; haptics(5);
    setTimeout(()=>{ btn.disabled=false; btn.textContent=prev; resetFlow(); }, 800);
  }, 420);
}

function resetFlow(){
  $('matriculaInput').value=''; $('contenidoInput').value='';
  currentMatricula=''; currentEstado=''; showStep(1,'back');
}

/* ===== UI update (igual que base) ===== */
function updateAll(){
  const cargadas = plataformas.filter(p=>p.estado==='CARGADA');
  const vacias   = plataformas.filter(p=>p.estado==='VAC√çA');
  const averiadas= plataformas.filter(p=>p.estado==='AVERIADA');
  $('cargadasCount').textContent=cargadas.length;
  $('vaciasCount').textContent=vacias.length;
  $('averiadasCount').textContent=averiadas.length;
  $('totalCount').textContent=plataformas.length;
  $('cargadasListCount').textContent=cargadas.length;
  $('vaciasListCount').textContent=vacias.length;
  $('averiadasListCount').textContent=averiadas.length;
  renderList('cargadasList', cargadas, true);
  renderList('vaciasList',   vacias,   false);
  renderList('averiadasList',averiadas,true);
}
function renderList(id, arr, showContent){
  const box=$(id);
  if(!arr.length){ box.innerHTML='<div class="empty">No hay registros</div>'; return; }
  box.innerHTML = arr.map(it=>(
    '<div class="card-row">'+
      '<div class="head" style="display:flex;justify-content:space-between;gap:10px;font-weight:700">'+
        '<span>'+esc(it.matricula)+'</span><span>'+esc(it.timestamp)+'</span></div>'+
      (showContent&&it.contenido?'<div class="body" style="color:#2B2F34;margin-top:6px;white-space:pre-wrap">'+esc(it.contenido)+'</div>':'')+
    '</div>'
  )).join('');
}
const esc = (s)=>String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));

/* ===== PDF export (id√©ntico a tu original) ===== */
function generatePDF(){ /* ‚Äî‚Äî‚Äî bloque copiado 1:1 del original ‚Äî‚Äî‚Äî */
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'mm', format: 'a4' });
  const today = new Date();
  const dateString = today.toLocaleDateString('es-ES', {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
  }).toUpperCase();

  const cargadas = plataformas.filter(p => p.estado === 'CARGADA');
  const vacias = plataformas.filter(p => p.estado === 'VAC√çA');
  const averiadas = plataformas.filter(p => p.estado === 'AVERIADA');

  doc.setFillColor(255,255,255);
  doc.roundedRect(10, 8, 190, 36, 5, 5, 'F');
  doc.setDrawColor(220,220,220);
  doc.roundedRect(10, 8, 190, 36, 5, 5);
  doc.setDrawColor(200,200,200);
  doc.line(10, 44, 200, 44);

  doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.setTextColor(40,40,40);
  doc.text('CODE', 195, 14, { align: 'right' });

  doc.setFont('helvetica','bold'); doc.setFontSize(18);
  const full = 'XPO LOGISTICS'; const xpoPart = 'XPO '; const startX = 105 - (doc.getTextWidth(full) / 2);
  doc.setTextColor(239,68,68); doc.text(xpoPart, startX, 22);
  const nextX = startX + doc.getTextWidth(xpoPart);
  doc.setTextColor(0,0,0); doc.text('LOGISTICS', nextX, 22);

  doc.setFont('helvetica','normal'); doc.setFontSize(8); doc.setTextColor(120,120,130);
  doc.text(dateString, 105, 28, { align: 'center' });

  function drawCard(x,y,w,h,bg,num,label,numColor){
      doc.setFillColor(...bg); doc.roundedRect(x,y,w,h,2,2,'F');
      doc.setFont('helvetica','bold'); doc.setFontSize(8); doc.setTextColor(...numColor);
      doc.text(String(num), x+w*0.3, y+h/2+2, { align: 'center' });
      doc.setFont('helvetica','bold'); doc.setFontSize(7); doc.setTextColor(60,60,70);
      doc.text(label, x+w*0.7, y+h/2+2, { align: 'center' });
  }
  const badgeY = 32, badgeWidth = 40, badgeHeight = 8, gap = 8, totalWidth = badgeWidth*3 + gap*2;
  let bx = 105 - totalWidth/2;
  drawCard(bx,badgeY,badgeWidth,badgeHeight,[254,226,226],cargadas.length,'CARGADAS',[180,30,50]); bx+=badgeWidth+gap;
  drawCard(bx,badgeY,badgeWidth,badgeHeight,[237,249,237],vacias.length,'VAC√çAS',[16,185,129]); bx+=badgeWidth+gap;
  drawCard(bx,badgeY,badgeWidth,badgeHeight,[255,245,230],averiadas.length,'AVERIADAS',[200,110,20]);

  let yPosition = 52; const bottomMargin = 260;

  function createTwoColumnTables(leftTitle,leftData,rightTitle,rightData,startY){
      let currentY=startY; const leftX=15; const rightX=110; const columnWidth=85;
      doc.setFont('helvetica','bold'); doc.setFontSize(12);
      if(leftData.length>0) doc.text(leftTitle.toUpperCase(),leftX,currentY);
      if(rightData.length>0) doc.text(rightTitle.toUpperCase(),rightX,currentY);
      currentY+=8;
      if(leftData.length>0){
          doc.setFillColor(245,247,250); doc.rect(leftX,currentY-4,columnWidth,7,'F');
          doc.setFont('helvetica','bold'); doc.setFontSize(9);
          doc.text('MATRICULA',leftX+2,currentY); doc.text('CONTENIDO',leftX+35,currentY);
      }
      if(rightData.length>0){
          doc.setFillColor(245,247,250); doc.rect(rightX,currentY-4,columnWidth,7,'F');
          doc.setFont('helvetica','bold'); doc.setFontSize(9);
          doc.text('MATRICULA',rightX+2,currentY);
      }
      currentY+=8; doc.setFont('helvetica','normal'); doc.setFontSize(8);
      const maxRows=Math.max(leftData.length,rightData.length);
      for(let i=0;i<maxRows;i++){
          if(i%2===0){
              if(leftData[i]){doc.setFillColor(252,253,255);doc.rect(leftX,currentY-3,columnWidth,6,'F');}
              if(rightData[i]){doc.setFillColor(252,253,255);doc.rect(rightX,currentY-3,columnWidth,6,'F');}
          }
          if(leftData[i]){
              doc.text(leftData[i].matricula.toUpperCase(),leftX+2,currentY);
              if(leftData[i].contenido){
                  const lines=doc.splitTextToSize(leftData[i].contenido.toUpperCase(),45);
                  doc.text(lines,leftX+35,currentY);
                  if(lines.length>1) currentY+=(lines.length-1)*3;
              }
          }
          if(rightData[i]){ doc.text(rightData[i].matricula.toUpperCase(),rightX+2,currentY); }
          currentY+=6;
          if(currentY>bottomMargin){ doc.addPage(); currentY=30; }
      }
      return currentY+10;
  }
  function createSingleTable(title,data,startY){
      let currentY=startY; if(data.length===0) return currentY;
      doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.text(title.toUpperCase(),15,currentY); currentY+=8;
      doc.setFillColor(245,247,250); doc.rect(15,currentY-4,180,7,'F');
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.text('MATRICULA',17,currentY); doc.text('DESCRIPCION',70,currentY); currentY+=8;
      doc.setFont('helvetica','normal'); doc.setFontSize(8);
      data.forEach((platform,index)=>{
          if(index%2===0){doc.setFillColor(252,253,255);doc.rect(15,currentY-3,180,6,'F');}
          doc.text(platform.matricula.toUpperCase(),17,currentY);
          if(platform.contenido){
              const lines=doc.splitTextToSize(platform.contenido.toUpperCase(),120);
              doc.text(lines,70,currentY);
              if(lines.length>1) currentY+=(lines.length-1)*3;
          }
          currentY+=6;
          if(currentY>bottomMargin){ doc.addPage(); currentY=30; }
      });
      return currentY+10;
  }
  if(cargadas.length>0||vacias.length>0){
      yPosition=createTwoColumnTables('PLATAFORMAS CARGADAS '+cargadas.length,cargadas,'PLATAFORMAS VAC√çAS '+vacias.length,vacias,yPosition);
  }
  if(averiadas.length>0){ yPosition=createSingleTable('PLATAFORMAS AVERIADAS ('+averiadas.length+')',averiadas,yPosition); }
  const pageCount=doc.internal.getNumberOfPages();
  for(let i=1;i<=pageCount;i++){
      doc.setPage(i); doc.setFont('helvetica','normal'); doc.setFontSize(8); doc.setTextColor(100,100,110);
      doc.text('¬© 2025 XPO LOGISTICS ‚Äì Informe interno',20,285);
      doc.setTextColor(60,90,180);
      doc.textWithLink('https://vbenyx.github.io/XPO-LOGISTICS/', 105, 285, { url: 'https://vbenyx.github.io/XPO-LOGISTICS/', align: 'center' });
      doc.setTextColor(100,100,110); doc.text('P√°gina '+i+' de '+pageCount,190,285,{align:'right'});
  }
  const exportDateForName = new Date().toLocaleDateString('es-ES', { day:'2-digit', month:'2-digit', year:'numeric' }).replace(/\//g,'-');
  doc.save(`reporte_plataformas_${exportDateForName}.pdf`);
}

/* ===== Gestos, teclado y ‚Äúmagnetismo‚Äù (Apple vibes) ===== */
// Gestos de swipe en la card
let touchStartX = null;
$('flowCard').addEventListener('touchstart', (e)=>{ touchStartX = e.changedTouches[0].clientX; }, {passive:true});
$('flowCard').addEventListener('touchend', (e)=>{
  if(touchStartX===null) return;
  const dx = e.changedTouches[0].clientX - touchStartX;
  if(Math.abs(dx) > 60){
    if(dx<0 && step<3) showStep(step+1,'forward');
    if(dx>0 && step>1) showStep(step-1,'back');
    haptics(5);
  }
  touchStartX=null;
}, {passive:true});

// Parallax ligero del header
const header = $('glassHeader');
let lastY = 0;
document.addEventListener('scroll', ()=>{
  const y = Math.min(60, window.scrollY);
  // mezcla de translate y sombra perceptual
  header.style.transform = `translateY(${y*0.18}px)`;
  lastY = y;
}, {passive:true});

// Atajos teclado
document.addEventListener('keydown',(e)=>{
  if(e.key==='Enter' && step===1){ nextFromS1(); }
  else if((e.key==='Enter' && (e.metaKey||e.ctrlKey) && step===3)){ registrar(); }
  else if(e.key==='Escape'){ if(step>1) showStep(step-1,'back'); }
});

// Bot√≥n magn√©tico (seguimiento del cursor)
document.querySelectorAll('.btn').forEach(btn=>{
  btn.addEventListener('mousemove', e=>{
    const r = btn.getBoundingClientRect();
    const x = e.clientX - r.left - r.width/2;
    const y = e.clientY - r.top - r.height/2;
    btn.style.transform = `translate(${x*0.05}px, ${y*0.05}px) scale(1.02)`;
  });
  btn.addEventListener('mouseleave', ()=>{ btn.style.transform=''; });
});

/* ===== Haptics suavizados (vibrate si est√° disponible) ===== */
function haptics(ms=8){ if(navigator.vibrate) try{ navigator.vibrate(ms); }catch(_){} }

/* ===== Init ===== */
window.addEventListener('DOMContentLoaded', () => {
  $('currentDate').textContent = fmtDateLong().toUpperCase();
  loadData(); updateAll();

  $('toS2').addEventListener('click', nextFromS1);
  $('back1').addEventListener('click', ()=>showStep(1,'back'));
  $('back2').addEventListener('click', ()=>showStep(2,'back'));
  $('btnCargada').addEventListener('click', ()=>chooseEstado('CARGADA'));
  $('btnVacia').addEventListener('click',   ()=>chooseEstado('VAC√çA'));
  $('btnAveriada').addEventListener('click',()=>chooseEstado('AVERIADA'));
  $('btnRegistrar').addEventListener('click', registrar);

  $('genPdf').addEventListener('click', generatePDF);
  $('clearAll').addEventListener('click', ()=>{
    if(!plataformas.length){ alert('No hay registros para limpiar'); return; }
    if(confirm('¬øSeguro que quieres eliminar todos los registros?')){
      plataformas=[]; saveData(); updateAll(); resetFlow();
    }
  });

  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden') saveData(); });
  window.addEventListener('beforeunload', saveData);
});
</script>
</body>
</html>