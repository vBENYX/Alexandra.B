<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1.0" />
  <title>XPO Logistics ‚Äì Registro de Plataformas</title>

  <!-- Fuente -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>

  <style>
    :root{
      --primary:#2563eb;
      --primary-dark:#1d4ed8;
      --text:#1f2937;
      --muted:#64748b;
      --bg:#f8fafc;
      --card:#ffffff;
      --border:#e2e8f0;
      --red:#ef4444;
      --green:#10b981;
      --amber:#f59e0b;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,-apple-system,"Segoe UI",sans-serif;background:var(--bg);color:var(--text);line-height:1.5}
    .app{max-width:960px;margin:0 auto;padding:20px}
    .header{
      text-align:center;margin-bottom:24px;padding:20px;
      background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);
      border-radius:16px;color:#fff
    }
    .logo-small{font-weight:800;letter-spacing:2px;margin-bottom:4px}
    .header h1{font-size:1.7rem}

    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.03);padding:22px}
    .grid{display:grid;gap:20px}
    @media (min-width: 880px){ .grid-3{grid-template-columns:1fr 1fr 1fr} }

    /* Paso */
    .form h2{text-align:center;margin-bottom:14px}
    .input,.textarea{
      width:100%;padding:14px;border:2px solid var(--border);border-radius:10px;font-size:1rem;background:#fff
    }
    .input:focus,.textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    .textarea{min-height:100px;resize:vertical}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:12px 18px;border-radius:10px;border:none;cursor:pointer;font-weight:600;color:#fff;background:#111827
    }
    .btn:disabled{opacity:.6;cursor:default}
    .btn-primary{background:var(--primary)}
    .btn-primary:hover{background:var(--primary-dark)}
    .btn-secondary{background:#475569}
    .btn-cargada{background:var(--red)}
    .btn-vacia{background:var(--green)}
    .btn-averiada{background:var(--amber)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > .btn{flex:1}

    /* Progreso */
    .progress{display:flex;justify-content:center;gap:10px;margin-bottom:14px}
    .dot{width:10px;height:10px;border-radius:50%;background:#d1d5db}
    .dot.active{background:var(--primary)}

    /* Resumen */
    .summary h3{text-align:center;margin-bottom:12px}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
    .stat{text-align:center;border:1px solid var(--border);border-radius:10px;background:#f8fafc;padding:16px}
    .stat-number{font-size:1.6rem;font-weight:800;color:var(--primary)}

    /* Listas */
    .list h3{margin-bottom:10px;border-bottom:2px solid var(--border);padding-bottom:8px}
    .platforms{display:flex;flex-direction:column;gap:10px}
    .platform{
      background:#fff;border:1px solid var(--border);border-radius:10px;padding:12px
    }
    .platform .head{display:flex;justify-content:space-between;font-weight:600}
    .empty{font-style:italic;color:var(--muted);text-align:center;padding:10px}

    /* Bot√≥n flotante */
    .fab{
      position:fixed;right:16px;bottom:16px;border:none;border-radius:22px;background:var(--primary);
      color:#fff;padding:10px 14px;display:flex;align-items:center;gap:8px;box-shadow:0 8px 20px rgba(37,99,235,.25);cursor:pointer
    }
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="logo-small">XPO LOGISTICS</div>
      <h1>Registro de Plataformas</h1>
    </header>

    <!-- PASOS -->
    <section class="card">
      <div class="progress" aria-label="Progreso">
        <span id="dot1" class="dot active"></span>
        <span id="dot2" class="dot"></span>
        <span id="dot3" class="dot"></span>
      </div>

      <div id="step1" class="form">
        <h2>Paso 1: Matr√≠cula de la Plataforma</h2>
        <input id="matriculaInput" class="input" placeholder="Introduce la matr√≠cula" autocomplete="off" />
        <div style="margin-top:12px;text-align:center">
          <button class="btn btn-primary" id="btnContinuar">Continuar</button>
        </div>
      </div>

      <div id="step2" class="form hidden">
        <h2>Paso 2: Estado de la Plataforma</h2>
        <p style="text-align:center;color:var(--muted)">Matr√≠cula: <strong id="matriculaDisplay">‚Äî</strong></p>
        <div class="row" style="margin-top:12px">
          <button class="btn btn-cargada"  data-estado="CARGADA">CARGADA</button>
          <button class="btn btn-vacia"     data-estado="VAC√çA">VAC√çA</button>
          <button class="btn btn-averiada"  data-estado="AVERIADA">Averiada</button>
        </div>
        <div style="margin-top:12px">
          <button class="btn btn-secondary" id="btnVolver1">Volver</button>
        </div>
      </div>

      <div id="step3" class="form hidden">
        <h2>Paso 3: Contenido de la Plataforma</h2>
        <p style="text-align:center;color:var(--muted)">
          Matr√≠cula: <strong id="matriculaDisplay2">‚Äî</strong> ¬∑
          Estado: <strong id="estadoDisplay">‚Äî</strong>
        </p>
        <textarea id="contenidoInput" class="textarea" placeholder="Describe qu√© contiene o el problema..."></textarea>
        <div class="row" style="margin-top:12px">
          <button class="btn btn-primary" id="btnRegistrar">Registrar</button>
          <button class="btn btn-secondary" id="btnVolver2">Volver</button>
        </div>
      </div>
    </section>

    <!-- RESUMEN -->
    <section class="card" style="margin-top:20px">
      <div class="summary">
        <h3>Resumen del d√≠a</h3>
        <div class="stats">
          <div class="stat"><div id="cargadasCount"  class="stat-number">0</div><div>Plataformas cargadas</div></div>
          <div class="stat"><div id="vaciasCount"    class="stat-number">0</div><div>Plataformas vac√≠as</div></div>
          <div class="stat"><div id="averiadasCount" class="stat-number">0</div><div>üõ† Averiadas</div></div>
          <div class="stat"><div id="totalCount"     class="stat-number">0</div><div>Total</div></div>
        </div>
      </div>
    </section>

    <!-- LISTAS -->
    <section class="grid grid-3" style="margin-top:20px">
      <div class="card list">
        <h3>Plataformas cargadas (<span id="cargadasListCount">0</span>)</h3>
        <div id="cargadasList" class="platforms"></div>
      </div>
      <div class="card list">
        <h3>Plataformas vac√≠as (<span id="vaciasListCount">0</span>)</h3>
        <div id="vaciasList" class="platforms"></div>
      </div>
      <div class="card list">
        <h3>üõ† Plataformas averiadas (<span id="averiadasListCount">0</span>)</h3>
        <div id="averiadasList" class="platforms"></div>
      </div>
    </section>

    <!-- ACCIONES -->
    <section class="card" style="margin-top:20px">
      <div class="row" style="justify-content:center">
        <button class="btn btn-primary" id="btnPDF">üìÑ Generar PDF</button>
        <button class="btn" style="background:#ef4444" id="btnClear">üóë Limpiar Registros</button>
      </div>
    </section>
  </div>

  <!-- Bot√≥n flotante PDF -->
  <button class="fab" id="fabPDF" title="Generar PDF">üìÑ PDF</button>

  <script>
    // ====== Estado y almacenamiento ======
    const STORAGE_KEY = 'plataformas';
    let plataformas = [];
    let currentStep = 1;
    let currentMatricula = '';
    let currentEstado = '';

    const $ = (id) => document.getElementById(id);
    const dots = [$('dot1'), $('dot2'), $('dot3')];

    function loadData(){
      try { plataformas = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
      catch { plataformas = []; }
    }
    function saveData(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(plataformas));
    }

    // ====== Navegaci√≥n de pasos ======
    function goTo(step){
      for (let i=1;i<=3;i++) $('step'+i).classList.add('hidden');
      $('step'+step).classList.remove('hidden');
      dots.forEach(d=>d.classList.remove('active'));
      dots[step-1].classList.add('active');
      currentStep = step;
    }

    // ====== UI / Resumen ======
    function updateDisplay(){
      const cargadas  = plataformas.filter(p=>p.estado==='CARGADA');
      const vacias    = plataformas.filter(p=>p.estado==='VAC√çA');
      const averiadas = plataformas.filter(p=>p.estado==='AVERIADA');

      $('cargadasCount').textContent  = cargadas.length;
      $('vaciasCount').textContent    = vacias.length;
      $('averiadasCount').textContent = averiadas.length;
      $('totalCount').textContent     = plataformas.length;

      $('cargadasListCount').textContent  = cargadas.length;
      $('vaciasListCount').textContent    = vacias.length;
      $('averiadasListCount').textContent = averiadas.length;

      renderList('cargadasList',  cargadas,  true);
      renderList('vaciasList',    vacias,    false);
      renderList('averiadasList', averiadas, true);
    }

    function renderList(listId, arr, showContent){
      const el = $(listId);
      if (arr.length === 0){
        el.innerHTML = '<div class="empty">No hay registros</div>';
        return;
      }
      el.innerHTML = arr.map(p=>(
        `<div class="platform">
           <div class="head">
             <span>${p.matricula}</span>
             <span>${p.timestamp}</span>
           </div>
           ${showContent && p.contenido ? `<div style="margin-top:6px">${escapeHTML(p.contenido)}</div>` : ``}
         </div>`
      )).join('');
    }

    function escapeHTML(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // ====== Acciones ======
    function nextStep(){
      const value = $('matriculaInput').value.trim();
      if(!value){ alert('Por favor, introduce una matr√≠cula v√°lida'); return; }
      currentMatricula = value.toUpperCase();
      $('matriculaDisplay').textContent  = currentMatricula;
      $('matriculaDisplay2').textContent = currentMatricula;
      goTo(2);
    }

    function chooseEstado(estado){
      currentEstado = estado;
      $('estadoDisplay').textContent = estado;

      // Si es VAC√çA, registro directo
      if (estado === 'VAC√çA'){
        const exists = plataformas.some(p=>p.matricula===currentMatricula && p.estado==='VAC√çA');
        if (exists){ alert('Esta matr√≠cula ya est√° registrada como VAC√çA.'); resetForm(); return; }
        addPlataforma({ contenido: '' });
        resetForm();
      } else {
        goTo(3);
      }
    }

    function addPlataforma({contenido}){
      plataformas.push({
        id: Date.now(),
        matricula: currentMatricula,
        estado: currentEstado,
        contenido: contenido || '',
        timestamp: new Date().toLocaleTimeString('es-ES')
      });
      saveData();
      updateDisplay();
    }

    function registrar(){
      const contenido = $('contenidoInput').value.trim();
      if(!contenido){ alert('Describe el contenido o el problema'); return; }
      addPlataforma({ contenido });
      resetForm();
    }

    function resetForm(){
      currentMatricula = '';
      currentEstado = '';
      $('matriculaInput').value = '';
      $('contenidoInput').value = '';
      goTo(1);
    }

    function clearAll(){
      if(!confirm('¬øLimpiar todos los registros?')) return;
      plataformas = [];
      saveData();
      updateDisplay();
      resetForm();
    }

    // ====== PDF ======
    function generatePDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'mm', format:'a4' });
      const today = new Date();
      const dateStr = today.toLocaleDateString('es-ES',{weekday:'long',year:'numeric',month:'long',day:'numeric'}).toUpperCase();

      const cargadas  = plataformas.filter(p=>p.estado==='CARGADA');
      const vacias    = plataformas.filter(p=>p.estado==='VAC√çA');
      const averiadas = plataformas.filter(p=>p.estado==='AVERIADA');

      // Header
      doc.setFont('helvetica','bold'); doc.setFontSize(16);
      doc.text('XPO LOGISTICS ‚Äì REGISTRO DE PLATAFORMAS', 105, 16, {align:'center'});
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      doc.text(dateStr, 105, 23, {align:'center'});

      // Resumen
      doc.setFont('helvetica','bold'); doc.setFontSize(12);
      doc.text('RESUMEN', 15, 35);
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      doc.text(`Cargadas: ${cargadas.length}`, 15, 42);
      doc.text(`Vac√≠as: ${vacias.length}`,   60, 42);
      doc.text(`Averiadas: ${averiadas.length}`, 105, 42);
      doc.text(`Total: ${plataformas.length}`, 150, 42);

      let y = 55;

      // Tabla helper
      function table(title, cols, rows){
        if (rows.length === 0) return;
        doc.setFont('helvetica','bold'); doc.setFontSize(12);
        doc.text(title, 15, y); y += 6;

        // head
        doc.setFont('helvetica','bold'); doc.setFontSize(9);
        let x = 15;
        cols.forEach(c => { doc.text(c.label, x, y); x += c.w; });
        y += 5;
        doc.setFont('helvetica','normal');

        rows.forEach(r=>{
          x = 15;
          cols.forEach(c=>{
            let t = (r[c.key] || '').toString().toUpperCase();
            if (c.key === 'contenido') {
              const lines = doc.splitTextToSize(t, c.w - 2);
              lines.forEach((ln, i) => { doc.text(ln, x, y + i*4); });
              y += Math.max(6, lines.length*4);
              x += c.w;
            } else {
              doc.text(t, x, y); x += c.w;
            }
          });
          y += 4;
          if (y > 270){ doc.addPage(); y = 20; }
        });
        y += 4;
      }

      table('PLATAFORMAS CARGADAS', [
        {label:'MATR√çCULA', key:'matricula', w:40},
        {label:'CONTENIDO', key:'contenido', w:120},
        {label:'HORA',      key:'timestamp', w:25},
      ], cargadas);

      table('PLATAFORMAS VAC√çAS', [
        {label:'MATR√çCULA', key:'matricula', w:60},
        {label:'HORA',      key:'timestamp', w:25},
      ], vacias);

      table('PLATAFORMAS AVERIADAS', [
        {label:'MATR√çCULA', key:'matricula', w:40},
        {label:'DESCRIPCI√ìN', key:'contenido', w:120},
        {label:'HORA',      key:'timestamp', w:25},
      ], averiadas);

      const fileDate = today.toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'numeric'}).replace(/\//g,'-');
      doc.save(`reporte_plataformas_${fileDate}.pdf`);
    }

    // ====== Listeners ======
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      updateDisplay();
      goTo(1);

      $('btnContinuar').addEventListener('click', nextStep);
      $('btnVolver1').addEventListener('click', () => goTo(1));
      $('btnVolver2').addEventListener('click', () => goTo(2));
      $('btnRegistrar').addEventListener('click', registrar);
      $('btnPDF').addEventListener('click', generatePDF);
      $('fabPDF').addEventListener('click', generatePDF);
      $('btnClear').addEventListener('click', clearAll);

      // botones estado
      document.querySelectorAll('#step2 [data-estado]').forEach(btn=>{
        btn.addEventListener('click', () => chooseEstado(btn.dataset.estado));
      });

      // Enter en paso 1
      $('matriculaInput').addEventListener('keydown', e=>{
        if (e.key === 'Enter') nextStep();
      });

      // guardado defensivo
      document.addEventListener('visibilitychange', () => { if (document.visibilityState==='hidden') saveData(); });
      window.addEventListener('beforeunload', saveData);
    });
  </script>
</body>
</html>