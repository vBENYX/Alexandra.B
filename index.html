<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>XPO — Registro de Plataformas (Estilo Apple Pro)</title>

<!-- Normalize for consistent base -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
<!-- jsPDF (para exportación) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- D3.js (para el gráfico de distribución) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<!-- Firebase Imports (Required boilerplate) -->
<script type="module">
  // Importaciones de Firebase (Mandatorio para el entorno)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Variables globales (Acceso simulado)
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  // Configuración de Logging para Debugging
  setLogLevel('debug'); 

  // Inicialización y Autenticación
  let app, db, auth, userId = null;
  
  if (Object.keys(firebaseConfig).length > 0) {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userId = user.uid;
        console.log("Firebase Auth Ready. User ID:", userId);
      } else if (initialAuthToken) {
        try {
          await signInWithCustomToken(auth, initialAuthToken);
        } catch (error) {
          console.error("Error signing in with custom token:", error);
          await signInAnonymously(auth);
        }
      } else {
        await signInAnonymously(auth);
      }
    });
  } else {
    // Generar un ID temporal si no hay config de Firebase
    userId = 'guest-' + crypto.randomUUID();
    console.warn("Firebase config missing. Running in local simulation mode.");
  }
</script>

<style>
  /* * ESTILOS APPLE/iOS PRO
   * Diseño minimalista y limpio, corrección de flujo de pasos.
   */
  :root{
    --accent:#0A84FF; /* Azul de acento (iOS Blue) */
    --bg:#F2F2F7; /* Fondo de sistema claro */
    --panel:#FFFFFF; /* Tarjetas y paneles */
    --line:#E5E5EA; /* Línea de separación, más sutil */
    --text:#1C1C1E; /* Texto principal (Dark Charcoal) */
    --muted:#8E8E93; /* Texto secundario/sutil */
    
    /* Colores de estado */
    --color-cargada:#FF3B30; /* Rojo */
    --color-vacia:#34C759; /* Verde */
    --color-averiada:#FF9F0A; /* Naranja */
    
    --radius:16px; /* Radio grande para tarjetas */
    --radius-sm:10px; /* Radio pequeño para inputs/botones */

    /* Sombras suaves de estilo Apple */
    --shadow-main:0 12px 30px rgba(0,0,0,.08), 0 4px 8px rgba(0,0,0,.05);
    --shadow-card:0 4px 15px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizeLegibility}
  body{
    margin:0;
    /* Fuente por defecto de iOS/macOS */
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
    line-height:1.4;
  }
  input,textarea,button{font-size:16px;font-family:inherit;} 
  button{touch-action:manipulation;-webkit-tap-highlight-color:transparent}

  .app{
    max-width:980px;margin:0 auto;
    padding: calc(24px + env(safe-area-inset-top)) 16px calc(28px + env(safe-area-inset-bottom)) 16px;
  }

  /* Header - Minimalista y centrado */
  .header{
    background:var(--panel);
    border-radius:var(--radius);
    padding:24px 20px;
    box-shadow:var(--shadow-main);
    text-align:center;
  }
  .brand{
    display:flex;align-items:center;justify-content:center;gap:6px;
    font-weight:700;letter-spacing:.05em;font-size:12px;color:var(--muted);
  }
  .headline{
    margin:6px 0 4px;
    font-weight:800;
    font-size:clamp(24px,3.5vw,36px);
    line-height:1.1;
  }
  .subtle{color:var(--muted);font-weight:500;font-size:14px;}

  /* Single Card Flow (Flujo de la Matrícula) */
  .card{
    background:var(--panel);border-radius:var(--radius);
    box-shadow:var(--shadow-card);padding:0;margin:24px auto;
    overflow:hidden;max-width:560px;
  }
  .card-header{
    display:flex;align-items:center;justify-content:center;
    padding:16px 16px;border-bottom:1px solid var(--line);background:var(--panel);
  }
  .title-lg{font-weight:700;letter-spacing:.01em;font-size:1.1em;}
  
  /* Contenedor del flujo de pasos - Min-height para asegurar espacio */
  .card-content{
    position:relative;
    min-height:350px; 
  }
  
  /* Contenido de los pasos */
  .screen{
    position:absolute;inset:0;
    padding:32px 24px 70px; /* CLAVE: 70px de padding inferior para los dots + espacio */
    display:flex;flex-direction:column;gap:18px;
    align-items:flex-start;justify-content:center; 
    opacity:0;transform:translateX(100%); /* Base: Todos a la derecha por defecto */
    pointer-events:none;
    z-index: 5; 
    transition:transform .5s cubic-bezier(.25, 1, .5, 1), opacity .3s;
  }
  /* Estado Activo: Mueve al centro y lo hace visible */
  .screen.active{opacity:1;transform:none;pointer-events:auto;z-index:10;} 
  
  /* Animaciones de cambio de pantalla (iOS style: slide) */
  /* out-left: mueve del centro al -100% (sale por la izquierda) */
  .screen.out-left{transform:translateX(-100%);opacity:0;z-index:5;}
  /* out-right: mueve del centro al 100% (sale por la derecha) */
  .screen.out-right{transform:translateX(100%);opacity:0;z-index:5;}

  /* Clave para la transición de regreso: Inicializa la pantalla entrante a la izquierda */
  .screen.initial-left { transform: translateX(-100%); }

  /* Estilos para los títulos dentro del step */
  .step-header{width: 100%;margin-bottom: 20px;text-align: left; padding: 0 0;}
  .step-header h2{
    margin:0 0 4px;font-weight:700;font-size:22px;color: var(--text);
  }
  .step-header .subtle-info{
    text-align:left;color:var(--muted);font-weight:400;font-size:15px;
  }

  /* Indicadores de paso (dots) - CLAVE: Posicionamiento absoluto al fondo del card-content */
  .steps{
    display:flex;gap:10px;justify-content:center;
    position:absolute;bottom:20px;left:0;right:0;
    z-index:15; /* Asegurar que los dots siempre estén encima */
  }
  .dot{width:8px;height:8px;border-radius:999px;background:var(--line);transition:.3s ease-out;position:relative}
  .dot.active{background:var(--accent);transform:scale(1.25);}
  .dot::after{
    content:'';position:absolute;inset:-6px;border-radius:50%;
    box-shadow:0 0 0 0 rgba(10,132,255,.4);
    transition:box-shadow .4s ease-out;
  }
  .dot.active::after{
    box-shadow:0 0 0 2px rgba(10,132,255,.1);
  }


  /* Inputs estilo campo de texto relleno */
  .input,.textarea{
    width:100%;padding:14px 16px;border-radius:var(--radius-sm);border:1px solid var(--line);background:var(--bg);
    outline:none;transition:border-color .22s, background .22s, transform .12s;
    font-weight:500;
  }
  .input:focus,.textarea:focus{border-color:var(--accent);background:#fff;transform:none;}
  .textarea{min-height:100px;resize:vertical}
  
  .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;width:100%;max-width:520px;}
  
  /* Botones estilo iOS (rellenos, redondeados y con microanimación de presión) */
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    padding:14px 22px;
    border:0;border-radius:var(--radius-sm);font-weight:700;
    box-shadow:0 2px 4px rgba(0,0,0,.1); 
    transition:transform .1s ease-out, opacity .2s;
    user-select: none;
    cursor:pointer;
  }
  .btn:active{transform:scale(.98);box-shadow:0 1px 2px rgba(0,0,0,.15);} 
  .btn:disabled{opacity:.5;transform:none;box-shadow:none;}

  .btn-primary{background:var(--accent); color:#fff;}
  .btn-secondary{background:var(--line); color:var(--text); font-weight:600;}
  .btn-danger{background:var(--color-cargada); color:#fff;}
  
  /* Botones de estado (Paso 2) - Estilo iOS Segmented Control Simplificado */
  .btn-status {
      flex: 1 1 30%; 
      min-height: 80px;
      font-size: 16px;
      font-weight: 600;
      background: var(--panel); 
      color: var(--muted); /* Texto gris sutil por defecto */
      border: 1px solid var(--line);
      box-shadow:none;
      transition: all 0.2s ease-out;
      position: relative;
  }

  .btn-status.selected{
      border-color:var(--accent);
      color: var(--accent); /* Texto azul cuando seleccionado */
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(0,0,0,.04); /* Sombra muy sutil */
  }
  
  /* Stats - Diseño de tarjeta flotante */
  .panel{
    background:var(--panel);border-radius:var(--radius);
    padding:18px;box-shadow:var(--shadow-card);margin:24px 0;
  }
  .stats{
    display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
    gap:10px;padding:0 4px;
  }
  .stat{
    background:#fff;border:1px solid var(--line);border-radius:var(--radius-sm);
    padding:12px;text-align:left; 
    transition:transform .2s;
    overflow:hidden;
  }
  .stat .n{
    display:block;
    font-size:clamp(26px,3vw,38px);
    font-weight:800;margin-bottom:0;
    line-height:1.1;
  }
  @keyframes countPop {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
    100% { transform: scale(1); opacity: 1; }
  }
  .stat .n.pop{ animation:countPop .2s ease-out; }

  .stat .label{color:var(--muted);font-weight:600;font-size:12px;line-height:1.2;margin-top:2px;}
  
  /* Lists - Diseño limpio y con botón de eliminación */
  .lists-container{
      display:grid;grid-template-columns:1fr;gap:20px;
  }
  .lists h3{
    margin:0 0 10px;font-size:16px;font-weight:700;
    border-left:4px solid var(--accent);padding-left:12px;
  }
  .empty{padding:14px;border:1px dashed var(--line);border-radius:var(--radius-sm);color:var(--muted);text-align:center;font-style:italic}
  
  .card-row{
    background:#fff;border-radius:var(--radius-sm);
    padding:12px 14px;margin-bottom:10px;
    box-shadow:0 1px 3px rgba(0,0,0,.08); 
    transition:transform .18s, box-shadow .18s, opacity .3s, margin-left .3s;
    position:relative;
    border-left: 4px solid var(--accent); 
  }
  .card-row:active{transform:scale(.995);box-shadow:0 1px 2px rgba(0,0,0,.08);}
  
  .card-row.fade-out{
    opacity: 0;
    margin-left: -5%;
    transform: scale(0.95);
  }

  .head{display:flex;justify-content:space-between;gap:10px;font-weight:600;color:var(--text);align-items:center;}
  .body{color:#2B2F34;margin-top:6px;white-space:pre-wrap;font-size:14px;line-height:1.3;}
  .actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}

  /* Botón de eliminar registro (SVG más limpio) */
  .delete-btn{
    background:none;border:none;color:var(--muted);font-size:18px;line-height:1;
    cursor:pointer;opacity:.8;padding: 4px 0 4px 8px; margin-left: 8px;
    transition:color .2s;
  }
  .delete-btn:hover{color:var(--color-cargada);}
  .delete-btn svg { width: 14px; height: 14px; display: block; fill: currentColor;}

  /* Modal Estilo iOS: fondo desenfocado */
  #customModal{
    position:fixed;inset:0;
    background:rgba(0,0,0,.15); 
    backdrop-filter:blur(5px); 
    display:none;align-items:center;justify-content:center;z-index:100;
    opacity:0;
    transition:opacity .3s ease-out;
  }
  #customModal.show{opacity:1;}
  #modalContent{
    background:var(--panel);border-radius:24px;
    padding:24px;width:90%;max-width:340px;text-align:center;
    box-shadow:var(--shadow-main);
    transform:scale(1.05);opacity:0;
    transition:transform .3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity .3s;
  }
  #customModal.show #modalContent{transform:scale(1);opacity:1;}

  @media (max-width:768px){
    .stats{grid-template-columns:repeat(2,1fr);}
    .lists-container{grid-template-columns:1fr;}
    .stat{text-align:center;} 
    .stat .n{display:inline-block; margin-right: 8px;}
  }
  @media (max-width:640px){
    .row .btn{flex:1 1 100%;}
    .row .btn-status{flex:1 1 auto; min-height: 60px; font-size: 14px; padding: 10px;} 
    .row {gap: 8px;} 
  }
</style>
</head>
<body>
  <div class="app">
    <!-- Header (Tarjeta Flotante) -->
    <header class="header">
      <div class="brand">
        <span style="color:var(--text); font-weight:900;">XPO</span>
        <span style="font-weight:500;">LOGISTICS</span>
      </div>
      <div class="headline">Registro de Plataformas</div>
      <div class="subtle" id="currentDate"></div>
    </header>

    <!-- Single Card Flow (Flujo de Matrícula) -->
    <section class="card" id="flowCard">
      <div class="card-header">
        <div class="title-lg" id="flowTitle">Matrícula</div>
      </div>
      <div class="card-content" id="screens">
        
        <!-- Indicadores de paso (dots) - CLAVE: Posición absoluta y Z-index alto -->
        <div class="steps" aria-hidden="true">
          <div class="dot active" id="d1"></div>
          <div class="dot" id="d2"></div>
          <div class="dot" id="d3"></div>
        </div>

        <!-- Screen 1: Paso 1 de 3 (Matrícula) -->
        <div class="screen active" id="s1">
          <div class="step-header">
            <h2>Paso 1 de 3: Matrícula</h2>
            <p class="subtle-info">Introduce la matrícula de la plataforma.</p>
          </div>
          <div style="width:100%; max-width:520px;">
            <label for="matriculaInput" style="font-weight:600;display:block;margin-bottom:8px;color:var(--text);text-align:left;">Matrícula del vehículo</label>
            <input id="matriculaInput" class="input" autocomplete="off" placeholder="Ej: M-1234-XPO" style="margin-bottom:20px;" maxlength="15" />
          </div>
          <button class="btn btn-primary" id="toS2" style="width:100%; max-width:520px;">Continuar</button>
        </div>
        
        <!-- Screen 2: Paso 2 de 3 (Estado) -->
        <div class="screen" id="s2" style="align-items:center;">
          <div class="step-header" style="text-align:center;">
            <h2>Paso 2 de 3: Estado</h2>
            <p class="subtle-info">Matrícula: <strong id="matriculaDisplay" style="color:var(--text)">—</strong></p>
          </div>
          <div class="row" style="gap:16px;">
            <!-- Botones de estado (Sin emojis, estilo Segmented Control) -->
            <button class="btn btn-status" id="btnCargada" data-estado="CARGADA">Cargada</button>
            <button class="btn btn-status" id="btnVacia" data-estado="VACÍA">Vacía</button>
            <button class="btn btn-status" id="btnAveriada" data-estado="AVERIADA">Averiada</button>
          </div>
          <div class="row" style="margin-top:16px;">
            <button class="btn btn-secondary" id="back1">Volver</button>
          </div>
        </div>

        <!-- Screen 3: Paso 3 de 3 (Contenido) -->
        <div class="screen" id="s3">
          <div class="step-header">
            <h2>Paso 3 de 3: Descripción</h2>
            <p class="subtle-info">Matrícula: <strong id="matriculaDisplay2" style="color:var(--text)">—</strong> — Estado: <strong id="estadoDisplay" style="color:var(--text)">—</strong></p>
          </div>
          <textarea id="contenidoInput" class="textarea" placeholder="Describe el contenido o el problema (máx. 250 caracteres)..."></textarea>
          <div class="row">
            <!-- Botones principales, colocados encima de los dots gracias al padding-bottom de .screen -->
            <button class="btn btn-primary" id="btnRegistrar">Registrar</button>
            <button class="btn btn-secondary" id="back2">Volver</button>
          </div>
        </div>
      </div>
      
    </section>

    <!-- Summary (Contadores Dinámicos - Estilo Flotante) -->
    <section class="panel">
      <h3 style="text-align:center;margin:0 0 10px;font-size:18px;font-weight:700;">Resumen del día</h3>
      <div class="stats">
        <div class="stat" data-color="var(--color-cargada)">
            <span class="n" id="cargadasCount">0</span>
            <span class="label">Cargadas</span>
        </div>
        <div class="stat" data-color="var(--color-vacia)">
            <span class="n" id="vaciasCount">0</span>
            <span class="label">Vacías</span>
        </div>
        <div class="stat" data-color="var(--color-averiada)">
            <span class="n" id="averiadasCount">0</span>
            <span class="label">Averiadas</span>
        </div>
        <div class="stat" data-color="var(--accent)">
            <span class="n" id="totalCount">0</span>
            <span class="label">Total registrado</span>
        </div>
      </div>
    </section>
    
    <!-- Chart and Lists (Mejora Gráfica y Utilidad) -->
    <section class="panel">
      <h3 style="text-align:center;margin:0 0 10px;font-size:18px;font-weight:700;">Distribución y Registros</h3>
      
      <!-- Gráfico de Distribución (Donut Chart) -->
      <div id="chartContainer" style="display: flex; justify-content: center; height: 180px; margin-bottom: 20px;">
        <svg id="donutChart"></svg>
      </div>

      <!-- Búsqueda -->
      <div style="margin-bottom: 20px;">
        <input id="searchInput" class="input" placeholder="Buscar por matrícula..." />
      </div>

      <!-- Lists (Contenedores) -->
      <div class="lists-container">
        <div class="list">
          <h3 style="border-left-color:var(--color-cargada);">Plataformas cargadas (<span id="cargadasListCount">0</span>)</h3>
          <div id="cargadasList"></div>
        </div>
        <div class="list">
          <h3 style="border-left-color:var(--color-vacia);">Plataformas vacías (<span id="vaciasListCount">0</span>)</h3>
          <div id="vaciasList"></div>
        </div>
        <div class="list">
          <h3 style="border-left-color:var(--color-averiada);">Plataformas averiadas (<span id="averiadasListCount">0</span>)</h3>
          <div id="averiadasList"></div>
        </div>
      </div>
    </section>

    <!-- Actions -->
    <section class="panel actions">
      <button class="btn btn-primary" id="genPdf" style="max-width:280px;">Generar Reporte PDF</button>
      <button class="btn btn-secondary" id="clearAll" style="background:#fff; color:var(--color-cargada); border:1px solid var(--color-cargada);">Limpiar todos los registros</button>
    </section>
  </div>
  
<!-- Custom Modal (Estilo iOS con Blur) -->
<div id="customModal">
    <div id="modalContent">
        <h4 id="modalTitle"></h4>
        <p id="modalBody" style="color:var(--text);"></p>
        <div id="modalButtons" class="row" style="gap:10px;justify-content:stretch;">
            <!-- Buttons go here -->
        </div>
    </div>
</div>

<script>
  // Global Firebase/App variables (Placeholder for required Firebase structure)
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  // Global variables
  let plataformas = [];
  let currentMatricula = '';
  let currentEstado = '';
  let filteredMatricula = ''; // Nuevo estado para la búsqueda
  let step = 1; // El estado de paso actual

  // ===== Utilities & State =====
  const $ = (id)=>document.getElementById(id);
  const $$ = (selector)=>document.querySelectorAll(selector);
  const fmtDateLong = (d=new Date()) => d.toLocaleDateString('es-ES', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
  const fmtHour = () => new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const esc = (s)=>String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&quot;',"'":'&#039;'}[m]));
  
  const STORAGE_KEY = 'plataformas-xpo-pro-apple';
  function loadData(){ 
    try{ 
      const raw=localStorage.getItem(STORAGE_KEY); 
      plataformas=raw?JSON.parse(raw):[];
    }catch(e){ 
      console.error("Error al cargar datos:", e);
      plataformas=[] 
    } 
  }
  function saveData(){ 
    try{ 
      localStorage.setItem(STORAGE_KEY, JSON.stringify(plataformas)); 
    }catch(e){
      console.error("Error al guardar datos:", e);
    } 
  }
  function isToday(timestamp) {
    const today = new Date().toDateString();
    const date = new Date(timestamp).toDateString();
    return today === date;
  }

  // Custom Modal implementation (iOS style)
  const modal = $('customModal');
  const modalTitle = $('modalTitle');
  const modalBody = $('modalBody');
  const modalButtons = $('modalButtons');

  /**
   * Muestra un modal personalizado con estilo iOS.
   */
  function showMessage(title, message, type='alert', onConfirm=null) {
      modalTitle.textContent = title;
      modalBody.innerHTML = message;
      modalButtons.innerHTML = '';
      
      modal.style.display = 'flex'; 
      setTimeout(() => modal.classList.add('show'), 10); 

      const close = () => { modal.classList.remove('show'); };

      if (type === 'alert') {
          const btn = document.createElement('button');
          btn.className = 'btn btn-primary';
          btn.textContent = 'Aceptar';
          btn.style.flex = '1 1 100%';
          btn.onclick = close;
          modalButtons.appendChild(btn);
      } else if (type === 'confirm' && onConfirm) {
          const cancelBtn = document.createElement('button');
          cancelBtn.className = 'btn btn-secondary';
          cancelBtn.textContent = 'Cancelar';
          cancelBtn.style.flex = '1';
          cancelBtn.onclick = close;

          const confirmBtn = document.createElement('button');
          confirmBtn.className = 'btn btn-danger';
          confirmBtn.textContent = 'Confirmar';
          confirmBtn.style.flex = '1';
          confirmBtn.onclick = () => { onConfirm(); close(); };

          modalButtons.appendChild(cancelBtn);
          modalButtons.appendChild(confirmBtn);
      }
  }
  
  modal.addEventListener('transitionend', (e) => {
      if (e.target === modal && !modal.classList.contains('show')) {
          modal.style.display = 'none';
      }
  });


  // ===== Single Card Flow logic (CORREGIDO Y REFORZADO) =====
  
  /**
   * Controla la transición visual entre pasos (S1, S2, S3).
   * @param {number} next - El número de paso de destino (1, 2, o 3).
   * @param {string} dir - La dirección de la transición ('forward' o 'back').
   */
  function showStep(next, dir='forward'){
    const cur = $('s'+step);
    const nxt = $('s'+next);
    const oldStep = step;

    if(!nxt || cur===nxt) {
        console.warn('showStep abortada: Destino no existe o es el mismo paso.', {next, step});
        return;
    }

    console.log(`Transición de S${oldStep} a S${next} (${dir})`);

    // 1. Prepara la pantalla entrante (nxt) para la transición
    if (dir === 'back') {
      // Si volvemos, la pantalla entrante debe iniciar fuera por la izquierda.
      nxt.classList.add('initial-left'); 
    } else {
      // Si avanzamos, la pantalla entrante ya está por defecto a la derecha (transform: translateX(100%))
      nxt.classList.remove('initial-left'); 
    }

    // 2. Mueve la pantalla actual (cur) fuera y desactívala
    cur.classList.remove('active');
    // Aplica la clase de salida (out-left si avanza, out-right si vuelve)
    cur.classList.add(dir==='forward' ? 'out-left' : 'out-right'); 
    
    // 3. Actualiza el estado interno inmediatamente (CRÍTICO)
    step = next;

    // 4. Activa la pantalla entrante (nxt)
    // Esto inicia la transición de su posición inicial (left/right) a transform: none (centro)
    // El 'active' debe aplicarse inmediatamente para que el navegador lo detecte como cambio de estado.
    nxt.classList.add('active');
    
    // 5. Limpia clases de transición en ambas pantallas después de un breve momento
    // El setTimeout es crucial para que el navegador primero aplique las clases de posición,
    // inicie la transición, y luego se limpien las clases auxiliares.
    setTimeout(()=>{ 
      nxt.classList.remove('initial-left', 'out-left', 'out-right'); 
      cur.classList.remove('initial-left', 'out-left', 'out-right'); 
    }, 550); // Ligeramente mayor que la duración de la transición CSS (0.5s)

    // 6. Actualiza dots & title
    $$('.dot').forEach((dot, index) => {
        dot.classList.toggle('active', index === next - 1);
    });
    $('flowTitle').textContent = next===1 ? 'Matrícula' : next===2 ? 'Estado' : 'Descripción';
  }

  function nextFromS1(){
    const m = $('matriculaInput').value.trim().toUpperCase();
    if(m.length < 4){ 
      showMessage('Error de Entrada', 'Por favor, introduce una matrícula válida (mínimo 4 caracteres).'); 
      return; 
    }
    currentMatricula = m;
    $('matriculaDisplay').textContent = m;
    $('matriculaDisplay2').textContent = m;
    
    // Si la validación es correcta, avanza al paso 2
    showStep(2,'forward');
    // Reiniciar selección de estado
    $$('.btn-status').forEach(btn => btn.classList.remove('selected'));
    currentEstado = '';
  }

  function selectEstado(estado){
    // 1. Limpiar selección y establecer nueva
    $$('.btn-status').forEach(btn => {
        btn.classList.remove('selected');
        // Reset visual feedback for VACÍA button
        if(btn.dataset.estado === 'VACÍA'){
            btn.textContent = 'Vacía';
            btn.style.color = 'var(--muted)';
            btn.style.borderColor = 'var(--line)';
        }
    });
    
    const btn = document.querySelector(`[data-estado="${estado}"]`);
    btn.classList.add('selected');

    currentEstado = estado;
    $('estadoDisplay').textContent = estado;
    
    // 2. Comportamiento según el estado
    if(estado==='VACÍA'){
      if(!currentMatricula){ showMessage('Error', 'Error interno de Matrícula.'); resetFlow(); return; }
      
      const dup = plataformas.some(p => p.matricula===currentMatricula && p.estado==='VACÍA' && isToday(p.id));
      if(dup){ 
        showMessage('Registro Duplicado', `Esta matrícula ya fue registrada como **VACÍA** hoy.`, 'alert'); 
        btn.classList.remove('selected');
        currentEstado = ''; // Limpiar estado ya que no se registró
        return; 
      }
      
      // Registrar inmediatamente VACÍA
      plataformas.push({ id:Date.now(), matricula:currentMatricula, estado, contenido:'Vacía', timestamp:fmtHour() });
      saveData(); 
      updateAll(true); 
      
      // Feedback visual
      const prev=btn.textContent;
      btn.textContent='Registrado';
      btn.style.color = 'var(--color-vacia)';
      btn.style.borderColor = 'var(--color-vacia)';
      
      setTimeout(()=>{ 
        btn.textContent=prev; 
        btn.style.color = 'var(--muted)'; // Volver al color sutil por defecto
        btn.style.borderColor = 'var(--line)'; // Volver al borde sutil
        resetFlow(); 
      }, 1000);

    }else{
      // Para CARGADA o AVERIADA, continuar al paso 3
      showStep(3,'forward');
      $('contenidoInput').focus();
    }
  }

  function registrar(){
    const contenido = $('contenidoInput').value.trim();
    if(contenido.length < 5){ showMessage('Falta Descripción', 'Describe el contenido o el problema con un mínimo de 5 caracteres.'); return; }
    
    // Re-check for duplication logic 
    const dup = plataformas.some(p => 
        p.matricula === currentMatricula && 
        p.estado === currentEstado && 
        p.contenido === contenido &&
        isToday(p.id)
    );

    if (dup) {
        showMessage('Registro Duplicado', `Ya has registrado la matrícula **${currentMatricula}** como **${currentEstado}** con esa misma descripción hoy.`, 'alert');
        return;
    }


    plataformas.push({ id:Date.now(), matricula:currentMatricula, estado:currentEstado, contenido, timestamp:fmtHour() });
    saveData(); 
    updateAll(true);
    
    // Feedback visual de iOS
    const btn=$('btnRegistrar'); const prev=btn.textContent;
    btn.disabled=true; 
    btn.textContent='Registrado';

    setTimeout(()=>{ 
      btn.textContent=prev; 
      btn.disabled=false; 
      resetFlow(); 
    }, 1200);
  }

  function resetFlow(){
    $('matriculaInput').value=''; 
    $('contenidoInput').value='';
    currentMatricula=''; 
    currentEstado=''; 
    $$('.btn-status').forEach(btn => btn.classList.remove('selected'));
    showStep(1,'back');
    $('matriculaInput').focus();
  }
  
  /**
   * Elimina un registro con animación.
   */
  function deleteRegistro(id) {
      // Usar confirmación tipo iOS
      showMessage(
          'Eliminar Registro',
          `¿Deseas eliminar el registro con ID **${id}**?`,
          'confirm',
          ()=>{
              const row = document.querySelector(`.card-row[data-id="${id}"]`);
              if (row) {
                  row.classList.add('fade-out'); // Inicia animación
                  setTimeout(() => {
                      plataformas = plataformas.filter(p => p.id !== id);
                      saveData();
                      updateAll(true); 
                  }, 300); 
              }
          }
      );
  }


  // ===== UI update (Contadores Dinámicos y Gráfico) =====
  function updateAll(animate=false){
    // Filtrar solo registros de hoy para el resumen
    const todaysPlatforms = plataformas.filter(p => isToday(p.id));

    const cargadas = todaysPlatforms.filter(p=>p.estado==='CARGADA');
    const vacias   = todaysPlatforms.filter(p=>p.estado==='VACÍA');
    const averiadas= todaysPlatforms.filter(p=>p.estado==='AVERIADA');
    
    // Obtener colores del CSS (necesario ya que son variables)
    const getCssColor = (prop) => getComputedStyle(document.documentElement).getPropertyValue(prop).trim();
    const red = getCssColor('--color-cargada');
    const green = getCssColor('--color-vacia');
    const yellow = getCssColor('--color-averiada');
    const accent = getCssColor('--accent');

    // Función de actualización de contador con microanimación
    const updateCount = (id, value, color) => {
        const elem = $(id);
        if (elem.textContent !== String(value) && animate) {
            elem.classList.add('pop');
            setTimeout(() => elem.classList.remove('pop'), 250);
        }
        elem.textContent = value;
        elem.style.color = color;
    };
    
    updateCount('cargadasCount', cargadas.length, red);
    updateCount('vaciasCount', vacias.length, green);
    updateCount('averiadasCount', averiadas.length, yellow);
    updateCount('totalCount', todaysPlatforms.length, accent);
    
    $('cargadasListCount').textContent=cargadas.length;
    $('vaciasListCount').textContent=vacias.length;
    $('averiadasListCount').textContent=averiadas.length;
    
    // Renderizado de listas (aplicando filtro de búsqueda)
    const filteredCargadas = cargadas.filter(p => p.matricula.includes(filteredMatricula));
    const filteredVacias = vacias.filter(p => p.matricula.includes(filteredMatricula));
    const filteredAveriadas = averiadas.filter(p => p.matricula.includes(filteredMatricula));

    renderList('cargadasList', filteredCargadas, true, red);
    renderList('vaciasList',   filteredVacias,   false, green);
    renderList('averiadasList',filteredAveriadas,true, yellow);
    
    // Actualizar gráfico de distribución
    updateChart(todaysPlatforms);
  }
  
  function renderList(id, arr, showContent, color){
    const box=$(id);
    if(!arr.length){ 
        box.innerHTML='<div class="empty">No hay registros hoy</div>'; 
        return; 
    }
    
    box.innerHTML = arr.map(it=>(
      '<div class="card-row" data-id="'+it.id+'" style="border-left: 4px solid '+color+';">'+
        '<div class="head"><span>'+esc(it.matricula)+'</span>'+
        '<div style="display:flex;align-items:center;">'+
        '<span style="color:var(--muted);font-weight:500;font-size:12px;">'+esc(it.timestamp)+'</span>'+
        '<button class="delete-btn" onclick="deleteRegistro('+it.id+')">'+
            '<svg viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>'+
            '<path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4h1.07l.951 7.135a.5.5 0 0 0 .992.001L8 10l.969 1.136a.5.5 0 0 0 .992-.001L10.812 4h1.07L13 13.5A2.5 2.5 0 0 1 10.5 16h-5A2.5 2.5 0 0 1 3 13.5L4.118 4zM4.5 2a.5.5 0 0 0 0 1h7a.5.5 0 0 0 0-1h-7z"/></svg>'+
        '</button>'+
        '</div>'+
        '</div>'+
        (showContent&&it.contenido&&it.contenido!=='Vacía'?'<div class="body">'+esc(it.contenido)+'</div>':'')+
      '</div>'
    )).join('');
  }

  // ===== D3.js Donut Chart Logic =====
  function getCssColor(prop) {
      return getComputedStyle(document.documentElement).getPropertyValue(prop).trim();
  }

  function updateChart(data) {
    const total = data.length;
    
    const chartData = [
        { status: 'Cargadas', count: data.filter(p => p.estado === 'CARGADA').length, color: getCssColor('--color-cargada') },
        { status: 'Vacías', count: data.filter(p => p.estado === 'VACÍA').length, color: getCssColor('--color-vacia') },
        { status: 'Averiadas', count: data.filter(p => p.estado === 'AVERIADA').length, color: getCssColor('--color-averiada') }
    ].filter(d => d.count > 0);

    const container = d3.select("#chartContainer");
    const svg = d3.select("#donutChart");
    svg.selectAll("*").remove(); // Limpiar gráfico anterior
    container.select(".legend").remove(); // Limpiar leyenda anterior

    const width = 180, height = 180;
    
    if (total === 0) {
      svg.attr("width", width)
         .attr("height", height)
         .append("text")
        .attr("x", width/2)
        .attr("y", height/2)
        .attr("dominant-baseline", "middle")
        .attr("text-anchor", "middle")
        .attr("font-size", "14px")
        .attr("fill", getCssColor('--muted'))
        .text("No hay datos para el gráfico");
      return;
    }

    const radius = Math.min(width, height) / 2;
    const innerRadius = radius * 0.7; // Para el efecto Donut
    
    svg.attr("width", width)
       .attr("height", height)
       .attr("viewBox", `0 0 ${width} ${height}`);

    const g = svg.append("g")
       .attr("transform", `translate(${width / 2}, ${height / 2})`);

    const pie = d3.pie()
        .sort(null)
        .value(d => d.count);

    const arc = d3.arc()
        .innerRadius(innerRadius)
        .outerRadius(radius);

    // Creación de arcos
    const arcs = g.selectAll(".arc")
        .data(pie(chartData))
        .enter().append("g")
        .attr("class", "arc");

    arcs.append("path")
        .attr("d", arc)
        .attr("fill", d => d.data.color)
        .attr("stroke", getCssColor('--panel'))
        .attr("stroke-width", 2)
        .transition()
        .duration(700)
        .attrTween("d", function(d) {
            const i = d3.interpolate(d.startAngle, d.endAngle);
            return function(t) {
                d.endAngle = i(t);
                return arc(d);
            }
        });

    // Texto central (Total)
    g.append("text")
        .attr("text-anchor", "middle")
        .attr("dominant-baseline", "middle")
        .attr("font-size", "30px")
        .attr("font-weight", "800")
        .attr("fill", getCssColor('--text'))
        .text(total);

    g.append("text")
        .attr("text-anchor", "middle")
        .attr("dominant-baseline", "middle")
        .attr("font-size", "10px")
        .attr("font-weight", "600")
        .attr("fill", getCssColor('--muted'))
        .attr("y", 15)
        .text("TOTAL");

    // Leyenda (fuera del gráfico) - Se utiliza un div separado
    const legend = container
        .append("div")
        .attr("class", "legend")
        .style("margin-left", "20px")
        .style("align-self", "center")
        .style("display", "flex")
        .style("flex-direction", "column")
        .style("justify-content", "center");

    legend.selectAll(".legend-item")
        .data(chartData)
        .enter()
        .append("div")
        .attr("class", "legend-item")
        .style("display", "flex")
        .style("align-items", "center")
        .style("margin-bottom", "4px")
        .style("width", "120px") // Fija el ancho para evitar CLS
        .html(d => {
            const percent = total > 0 ? (d.count / total * 100).toFixed(0) : 0;
            return `<div style="width:10px; height:10px; border-radius:50%; background:${d.color}; margin-right:8px;"></div>
                    <span style="font-size:12px; font-weight: 500; color: ${getCssColor('--text')}">${d.status.toUpperCase()}</span>
                    <span style="font-size:12px; font-weight: 600; color: ${d.color}; margin-left: auto;">(${percent}%)</span>`;
        });
  }

  // ===== PDF Export (Con colores Apple/iOS) =====
  function generatePDF() {
      // Logic from previous version (omitted for brevity, assume working)
      // The jspdf library is loaded via script tag at the top.
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'mm', format: 'a4' });
      const today = new Date();
      const dateString = today.toLocaleDateString('es-ES', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
      }).toUpperCase();

      const todaysPlatforms = plataformas.filter(p => isToday(p.id));
      const cargadas = todaysPlatforms.filter(p => p.estado === 'CARGADA');
      const vacias = todaysPlatforms.filter(p => p.estado === 'VACÍA');
      const averiadas = todaysPlatforms.filter(p => p.estado === 'AVERIADA');
      
      // Colores ajustados a las variables CSS (deben ser RGB para jsPDF)
      const XPO_BLUE = [10, 132, 255]; 
      const RED_STATUS = [255, 59, 48];
      const GREEN_STATUS = [52, 199, 89];
      const YELLOW_STATUS = [255, 159, 10];
      const GRAY_TEXT = [142, 142, 147];
      const DARK_TEXT = [28, 28, 30];

      // ==== HEADER PRONUNCIADO ====
      doc.setFillColor(255,255,255);
      doc.roundedRect(10, 8, 190, 38, 5, 5, 'F');
      doc.setDrawColor(220,220,220);

      // CODE (arriba derecha - XPO LOGISTICS)
      doc.setFont('helvetica','bold');
      doc.setFontSize(11);
      doc.setTextColor(...DARK_TEXT); 
      doc.text('XPO LOGISTICS', 195, 14, { align: 'right' });

      // Título Principal
      doc.setFont('helvetica','bold');
      doc.setFontSize(22);
      const full = 'REGISTRO DE PLATAFORMAS';
      doc.setTextColor(...DARK_TEXT);
      doc.text(full, 105, 24, { align: 'center' });

      // Fecha ligera
      doc.setFont('helvetica','normal');
      doc.setFontSize(10);
      doc.setTextColor(...GRAY_TEXT);
      doc.text(dateString, 105, 30, { align: 'center' });

      // ==== BADGES ====
      function drawCard(x,y,w,h,num,label,numColor){
          doc.setFillColor(255,255,255);
          doc.roundedRect(x,y,w,h,2,2,'F');
          doc.setDrawColor(230,230,235);
          doc.roundedRect(x,y,w,h,2,2,'S');

          doc.setFont('helvetica','bold');
          doc.setFontSize(14);
          doc.setTextColor(numColor[0],numColor[1],numColor[2]);
          doc.text(String(num), x+w*0.25, y+h/2+1, { align: 'center' });
          doc.setFont('helvetica','normal');
          doc.setFontSize(8);
          doc.setTextColor(...DARK_TEXT);
          doc.text(label, x+w*0.7, y+h/2+1, { align: 'center' });
      }

      const badgeY = 38;
      const badgeWidth = 45;
      const badgeHeight = 10;
      const gap = 6;
      const totalWidth = badgeWidth*4 + gap*3; 
      let bx = 105 - totalWidth/2;

      // Badges with subtle colors
      drawCard(bx,badgeY,badgeWidth,badgeHeight,cargadas.length,'CARGADAS',RED_STATUS);
      bx+=badgeWidth+gap;
      drawCard(bx,badgeWidth,badgeHeight,badgeHeight,vacias.length,'VACÍAS',GREEN_STATUS);
      bx+=badgeWidth+gap;
      drawCard(bx,badgeY,badgeWidth,badgeHeight,averiadas.length,'AVERIADAS',YELLOW_STATUS);
      bx+=badgeWidth+gap;
      drawCard(bx,badgeY,badgeWidth,badgeHeight,todaysPlatforms.length,'TOTAL',XPO_BLUE);


      let yPosition = 58; 
      const bottomMargin = 270;

      // ==== TABLAS ====
      function createTable(title, data, startY, showContent = true) {
          let currentY = startY;
          if (data.length === 0) return currentY;

          doc.setFont('helvetica', 'bold');
          doc.setFontSize(14);
          doc.setTextColor(...DARK_TEXT);
          doc.text(title.toUpperCase() + ' (' + data.length + ')', 15, currentY);
          currentY += 8;

          // Header row
          doc.setFillColor(248, 248, 250);
          doc.rect(15, currentY - 5, 180, 8, 'F');
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(10);
          doc.setTextColor(...DARK_TEXT);
          doc.text('MATRICULA', 17, currentY);
          doc.text('HORA', 55, currentY);
          if (showContent) {
              doc.text('DESCRIPCION', 90, currentY);
          }
          currentY += 8;

          doc.setFont('helvetica', 'normal');
          doc.setFontSize(9);
          doc.setTextColor(...DARK_TEXT);

          data.forEach((platform) => {
              // Line separator
              doc.setDrawColor(240, 240, 245);
              doc.line(15, currentY - 3, 195, currentY - 3);

              doc.text(platform.matricula.toUpperCase(), 17, currentY + 2);
              doc.text(platform.timestamp, 55, currentY + 2);
              
              if (showContent && platform.contenido && platform.contenido !== 'Vacía') {
                  const lines = doc.splitTextToSize(platform.contenido, 100);
                  doc.text(lines, 90, currentY + 2);
                  currentY += (lines.length - 1) * 3;
              }
              currentY += 6;

              if (currentY > bottomMargin) {
                  doc.addPage();
                  currentY = 30; // Reset Y position for new page
              }
          });
          currentY += 6; // Space after table
          return currentY;
      }

      yPosition = createTable('Plataformas Cargadas', cargadas, yPosition, true);
      yPosition = createTable('Plataformas Vacías', vacias, yPosition, false); 
      yPosition = createTable('Plataformas Averíadas', averiadas, yPosition, true);


      // ==== FOOTER (iOS THEME) ====
      const pageCount=doc.internal.getNumberOfPages();
      for(let i=1;i<=pageCount;i++){
          doc.setPage(i);
          doc.setFont('helvetica','normal');
          doc.setFontSize(8);
          doc.setTextColor(100,100,110);
          doc.text('© XPO Logistics. Documento de registro interno.',20,285);
          
          doc.setFont('helvetica','bold');
          doc.setTextColor(...XPO_BLUE);
          doc.text('REPORTE', 105, 285, { align: 'center' });
          
          doc.setFont('helvetica','normal');
          doc.setTextColor(100,100,110);
          doc.text('Página '+i+' de '+pageCount,190,285,{align:'right'});
      }

      
      const exportDateForName = new Date().toLocaleDateString('es-ES', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
      }).replace(/\//g, '-');
      doc.save(`reporte_plataformas_${exportDateForName}_apple.pdf`);
      
  }

  // ===== Init & Listeners =====
  window.addEventListener('DOMContentLoaded', () => {
    $('currentDate').textContent = fmtDateLong().toUpperCase();
    loadData(); updateAll();
    $('matriculaInput').focus(); 

    // Eventos del flujo
    $('toS2').addEventListener('click', nextFromS1);
    $('back1').addEventListener('click', ()=>showStep(1,'back'));
    $('back2').addEventListener('click', ()=>showStep(2,'back'));
    
    // Eventos de estado (usa dataset)
    $$('#s2 .btn-status').forEach(btn => {
        btn.addEventListener('click', (e) => selectEstado(e.currentTarget.dataset.estado));
    });

    $('btnRegistrar').addEventListener('click', registrar);
    $('genPdf').addEventListener('click', generatePDF);
    
    // Evento de búsqueda (Filtro por matrícula)
    $('searchInput').addEventListener('input', (e) => {
        filteredMatricula = e.target.value.trim().toUpperCase();
        updateAll(false);
    });

    // Limpiar todos los registros
    $('clearAll').addEventListener('click', ()=>{
      if(!plataformas.length){ showMessage('Sin Registros', 'No hay registros para limpiar', 'alert'); return; }
      
      showMessage(
        'Confirmación Necesaria', 
        '¿Seguro que quieres eliminar **todos** los registros de la aplicación? Esta acción es irreversible.', 
        'confirm', 
        () => {
          plataformas=[]; saveData(); updateAll(true); resetFlow();
        }
      );
    });

    // Asegurar guardado en localStorage
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden') saveData(); });
    window.addEventListener('beforeunload', saveData);
  });
</script>
</body>
</html>

