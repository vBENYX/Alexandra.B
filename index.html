<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CODE XPO | Registro Táctil de Matrículas</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Variables y Reset para Móviles (iOS Theme) */
        :root {
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-red: #FF3B30;
            --ios-yellow: #FFCC00;
            --ios-gray-bg: #f2f2f7;
            --ios-card-bg: #ffffff;
            --ios-separator: #d1d1d6;
            --ios-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --transition-duration: 0.35s;
            --text-light-gray: #6d6d71;
            --light-gray-apple: #f9f9f9; 
            --dark-text: #1c1c1e;
        }

        /* Estilo Base: Fondo de iOS y Tipografía SF Pro */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            background-color: var(--ios-gray-bg);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: var(--dark-text);
            overflow-x: hidden;
            /* Añadimos padding superior para dejar espacio al encabezado fijo */
            padding-top: 65px; 
        }
        
        /* ----------------------------------------------- */
        /* --- ENCABEZADO FIJO TIPO IOS LARGE TITLE (NUEVO) --- */
        /* ----------------------------------------------- */
        .header-fixed {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 450px; /* Igual que el contenedor principal */
            padding: 10px 20px;
            z-index: 1000;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            background-color: transparent; /* Inicialmente transparente */
        }
        
        /* Clase añadida por JS cuando se hace scroll */
        .header-fixed.scrolled {
            background-color: var(--ios-card-bg); /* Fondo blanco al hacer scroll */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .logo-container { 
            padding: 0; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: flex-start; 
        }
        
        .logo-main { 
            display: flex; 
            align-items: baseline; 
            gap: 5px; 
        }
        
        .logo-code { 
            font-family: 'Helvetica Neue', sans-serif; 
            font-size: 28px; 
            font-weight: 900; 
            color: var(--dark-text); 
            letter-spacing: -1px; 
            transition: font-size 0.3s ease;
        }
        
        .logo-xpo { 
            font-family: 'Helvetica Neue', sans-serif; 
            font-size: 16px; 
            font-weight: 800; 
            color: var(--ios-red); 
            letter-spacing: 1px; 
            margin-left: 5px; 
            transition: font-size 0.3s ease;
        }
        
        .app-title { 
            font-size: 12px; 
            font-weight: 400; 
            color: var(--text-light-gray); 
            margin-top: 2px;
            transition: opacity 0.3s ease;
        }
        
        /* --- Contenedor Principal --- */
        .container {
            width: 100%;
            max-width: 450px;
            /* Eliminado margin-top, ya que el header es fijo */
            background-color: transparent; 
            box-shadow: none;
            position: relative; 
            height: auto;
            min-height: calc(100vh - 65px); /* Ajustado a la altura de la ventana menos el padding */
            overflow: hidden;
            padding: 0 10px; /* Padding para evitar que el contenido toque los bordes */
        }

        /* --- ESTILOS DE PASOS Y CARDS (Mantenidos) --- */
        .card-section { 
            background-color: var(--ios-card-bg); 
            margin: 10px 0; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: var(--ios-shadow); 
            position: relative; 
        }
        
        .step-content { 
            opacity: 0; 
            transform: scale(0.98); 
            transition: opacity var(--transition-duration) ease-out, transform var(--transition-duration) ease-out; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            box-sizing: border-box; 
            padding: 20px; 
            background-color: var(--ios-card-bg); 
            border-radius: 10px; 
            box-shadow: var(--ios-shadow); 
            display: none; 
        }
        .step-content.active { 
            opacity: 1; 
            transform: scale(1); 
            position: relative; 
            display: block; 
            margin-bottom: 20px; 
        }

        /* Resto de estilos CSS (Botones, Contadores, Historial) se mantienen... */
        input[type="text"] { width: 100%; padding: 15px; margin-bottom: 20px; border: 1px solid var(--ios-separator); border-radius: 10px; box-sizing: border-box; font-size: 18px; background-color: #f9f9f9; transition: border-color 0.2s; -webkit-appearance: none; }
        button { width: 100%; background-color: var(--ios-blue); color: white; padding: 15px 20px; margin: 10px 0; border: none; border-radius: 10px; cursor: pointer; font-size: 18px; font-weight: 600; transition: opacity 0.1s, transform 0.1s, background-color 0.1s; -webkit-appearance: none; }
        button:active { opacity: 0.8; transform: scale(0.99); }
        .btn-confirm-cargada { background-color: var(--ios-green) !important; }
        .btn-confirm-vacia { background-color: var(--ios-yellow) !important; color: #333 !important; } 
        .btn-confirm-averiada { background-color: var(--ios-red) !important; }

        #botonesEstado { display: flex; gap: 5px; margin-bottom: 20px; }
        #botonesEstado button { 
            background-color: #e5e5ea; 
            color: #3c3c43; 
            font-weight: 500; 
            flex-grow: 1; 
            padding: 12px 10px; 
            margin: 0; 
            font-size: 16px; 
        }
        #btnEliminar { background-color: #FF3B30; margin-top: 10px; }
        .volver-button { background-color: transparent !important; color: var(--ios-blue) !important; font-weight: 400 !important; text-align: left; padding-left: 0 !important; margin-top: 20px; width: auto !important; }
        
        /* Contadores */
        #contadores { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; padding: 0; justify-content: space-between; }
        .compact-summary {
            flex: 1 1 48%; min-width: 150px; padding: 10px 12px; border-radius: 12px; background-color: var(--ios-card-bg); box-shadow: var(--ios-shadow); overflow: hidden; position: relative;
            opacity: 0; transform: scale(0.98); transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .compact-summary.visible { opacity: 1; transform: scale(1); }
        .progress-bar-bg { position: absolute; top: 0; left: 0; height: 100%; width: 100%; background-color: var(--ios-gray-bg); opacity: 0.7; z-index: 1; }
        .progress-fill { position: absolute; top: 0; left: 0; height: 100%; width: 0; transition: width 0.7s ease-out; opacity: 0.5; z-index: 2; }
        .summary-content { position: relative; display: flex; flex-direction: column; justify-content: space-between; height: 100%; z-index: 3; }
        .summary-content h4 { margin: 0; font-size: 11px; font-weight: 500; color: var(--text-light-gray); }
        .count-group { display: flex; justify-content: space-between; align-items: baseline; }
        .count-group .count { font-size: 22px; font-weight: 700; line-height: 1.1; }
        .count-group .percent { font-size: 11px; font-weight: 600; color: var(--dark-text); }
        .card-total .count { color: var(--ios-blue); }
        .card-cargada .count { color: var(--ios-green); }
        .card-disponible .count { color: var(--ios-yellow); }
        .card-averiada .count { color: var(--ios-red); }
        .card-total .progress-fill { background-color: var(--ios-blue); }
        .card-cargada .progress-fill { background-color: var(--ios-green); }
        .card-disponible .progress-fill { background-color: var(--ios-yellow); }
        .card-averiada .progress-fill { background-color: var(--ios-red); }

        /* Historial Reciente */
        #historialReciente { list-style: none; padding: 0; margin: 15px 0 0 0; padding-top: 15px; }
        #historialReciente li { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--ios-separator); font-size: 14px; }
        #historialReciente li:last-child { border-bottom: none; }
        .historial-matricula { flex-basis: 40%; font-weight: 500; }
        .historial-estado { font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 12px; flex-basis: 30%; text-align: center; } 
        .historial-time { color: var(--text-light-gray); font-size: 11px; flex-basis: 30%; text-align: right; }
        .estado-Cargada { background-color: #d8f5e2; color: #1e8449; }
        .estado-Vacía { background-color: #fff9e0; color: #b38600; } 
        .estado-Averiada { background-color: #fce8e8; color: #c0392b; }
        #advertenciaDuplicado { background-color: #fce8e8; color: #c0392b; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; display: none; border: 1px solid #f9bdbd; }
        
    </style>
</head>
<body>

<div class="header-fixed" id="fixedHeader">
    <div id="logoHeader" class="logo-container">
        <div class="logo-main">
            <div class="logo-code">CODE</div>
            <div class="logo-xpo">XPO</div>
        </div>
        <div class="app-title">Registro Rápido de Matrículas</div> 
    </div>
</div>

<div class="container">
    
    <div id="paso1" class="step-content active">
        <h3><i class="fas fa-barcode"></i> 1. Ingresar Matrícula</h3>
        <input type="text" id="matriculaInput" placeholder="Matrícula (Escanear o Tipear)" required>
        <button onclick="registrarMatricula()"><i class="fas fa-arrow-right"></i> Continuar</button>
    </div>

    <div id="paso2" class="step-content">
        <h3><i class="fas fa-tag"></i> 2. Estado para <span id="mostrarMatricula"></span></h3>
        
        <div id="advertenciaDuplicado" style="display:none;">
            <i class="fas fa-exclamation-triangle"></i> Esta matrícula ya estaba registrada como **<span id="estadoAnterior"></span>** (<span id="descAnterior"></span>). Al continuar, se actualizará su estado.
        </div>
        
        <div id="botonesEstado">
            <button id="btnCargada" onclick="manejarEstado('cargada')">Cargada</button>
            <button id="btnVacia" onclick="manejarEstado('vacia')">Vacía</button>
            <button id="btnAveriadaState" onclick="manejarEstado('averiada')">Averiada</button>
        </div>

        <div id="cargadaDetalles" style="display:none;">
            <input type="text" id="descCargada" placeholder="Descripción de la carga (Requerido)">
            <button id="btnGuardarCargada" onclick="guardarRegistro('cargada')"><i class="fas fa-check-circle"></i> Registrar Carga</button>
        </div>

        <div id="averiadaDetalles" style="display:none;">
            <input type="text" id="descAveriada" placeholder="Descripción de la avería (Requerido)">
            <button id="btnGuardarAveriada" onclick="guardarRegistro('averiada')"><i class="fas fa-check-circle"></i> Registrar Avería</button>
        </div>

        <button class="volver-button" onclick="mostrarPaso1(true)"><i class="fas fa-chevron-left"></i> Volver</button>
    </div>
    
    <div id="reportes" class="card-section">
        <h3><i class="fas fa-chart-bar"></i> Resumen de Flota</h3>
        
        <div id="contadores">
            <div id="cardTotal" class="compact-summary card-total">
                <div class="progress-bar-bg"></div>
                <div class="summary-content">
                    <h4>TOTAL FLOTA</h4>
                    <div class="count-group">
                        <span class="count" id="countTotal">0</span>
                        <span class="percent">100%</span>
                    </div>
                </div>
            </div>

            <div id="cardCargada" class="compact-summary card-cargada">
                <div class="progress-bar-bg"></div>
                <div class="progress-fill" id="fillCargada"></div>
                <div class="summary-content">
                    <h4>CARGADAS</h4>
                    <div class="count-group">
                        <span class="count" id="countCargada">0</span>
                        <span class="percent" id="percentCargada">0%</span>
                    </div>
                </div>
            </div>

            <div id="cardDisponible" class="compact-summary card-disponible">
                <div class="progress-bar-bg"></div>
                <div class="progress-fill" id="fillDisponible"></div>
                <div class="summary-content">
                    <h4>VACÍAS</h4>
                    <div class="count-group">
                        <span class="count" id="countDisponible">0</span>
                        <span class="percent" id="percentDisponible">0%</span>
                    </div>
                </div>
            </div>

            <div id="cardAveriada" class="compact-summary card-averiada">
                <div class="progress-bar-bg"></div>
                <div class="progress-fill" id="fillAveriada"></div>
                <div class="summary-content">
                    <h4>AVERIADAS</h4>
                    <div class="count-group">
                        <span class="count" id="countAveriada">0</span>
                        <span class="percent" id="percentAveriada">0%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <button onclick="exportarPDF()" style="background-color:#34c759; margin-top: 25px;">
            <i class="fas fa-file-pdf"></i> Exportar a PDF (Informe Ejecutivo)
        </button>
        
        <h4><i class="fas fa-history"></i> Últimos 5 Movimientos</h4>
        <ul id="historialReciente">
            </ul>
        
        <button id="btnEliminar" onclick="confirmarLimpiarRegistros()">
            <i class="fas fa-trash-alt"></i> Eliminar Todos los Registros
        </button>
    </div>

</div>

<script>
    let matriculaActual = "";
    let registroDuplicado = null; 

    // --- FUNCIONES DE UTILIDAD ---
    function guardarRegistros(registros) {
        localStorage.setItem('registrosMatriculas', JSON.stringify(registros));
        actualizarContadores();
        actualizarHistorialReciente();
    }

    function cargarRegistros() {
        return JSON.parse(localStorage.getItem('registrosMatriculas') || '[]');
    }

    function mostrarConfirmacion(mensaje, icono = "fas fa-check-circle") {
        console.log(`[Notificación] `); 
    }

    // --- GESTIÓN DE PANTALLAS (TRANSICIÓN DE DESVANECIMIENTO) ---
    function mostrarPaso(pasoId) {
        const currentActive = document.querySelector('.step-content.active');
        const targetPaso = document.getElementById(pasoId);
        
        document.getElementById('advertenciaDuplicado').style.display = 'none';

        if (currentActive && currentActive.id !== targetPaso.id) {
            
            // 1. Ocultar el paso actual con transición
            currentActive.classList.remove('active');
            currentActive.style.opacity = 0;
            currentActive.style.transform = 'scale(0.98)';
            
            // Esperar a que la transición termine (0.35s) y luego hacer display: none y liberar el espacio (position: relative)
            setTimeout(() => { 
                currentActive.style.display = 'none'; 
                currentActive.style.position = 'absolute'; 

                // 2. Mostrar el nuevo paso
                targetPaso.style.display = 'block';
                targetPaso.style.position = 'relative'; 

                // Le damos un pequeño retraso para asegurar que el display:block se ejecute antes de la transición
                setTimeout(() => {
                    targetPaso.classList.add('active');
                    targetPaso.style.opacity = 1;
                    targetPaso.style.transform = 'scale(1)';
                }, 50); 
            }, 350); 
        } else if (!currentActive) {
            // Inicialización (si no hay paso activo)
            targetPaso.style.display = 'block';
            targetPaso.style.position = 'relative';
            setTimeout(() => {
                targetPaso.classList.add('active');
                targetPaso.style.opacity = 1;
                targetPaso.style.transform = 'scale(1)';
            }, 50);
        }
    }

    function mostrarPaso1(isBackward = false) {
        mostrarPaso('paso1'); 
        matriculaActual = "";
        registroDuplicado = null;
        document.getElementById('matriculaInput').value = '';
        document.getElementById('descCargada').value = '';
        document.getElementById('descAveriada').value = '';
        document.getElementById('matriculaInput').focus();
    }

    // --- LÓGICA CLAVE: REGISTRO ---
    function registrarMatricula() {
        matriculaActual = document.getElementById('matriculaInput').value.toUpperCase().trim();
        if (!matriculaActual) {
            mostrarConfirmacion("Ingrese la matrícula.", "fas fa-exclamation-triangle");
            return;
        }
        
        const registros = cargarRegistros();
        const existente = registros.find(reg => reg.matricula === matriculaActual);
        
        registroDuplicado = existente;

        mostrarPaso('paso2'); 
        document.getElementById('mostrarMatricula').textContent = matriculaActual;
        document.getElementById('cargadaDetalles').style.display = 'none';
        document.getElementById('averiadaDetalles').style.display = 'none';
        
        if (existente) {
            const advertenciaDiv = document.getElementById('advertenciaDuplicado');
            document.getElementById('estadoAnterior').textContent = existente.estado;
            document.getElementById('descAnterior').textContent = existente.descripcion;
            advertenciaDiv.style.display = 'block';
            
            if (existente.estado === 'Cargada') manejarEstado('cargada');
            else if (existente.estado === 'Disponible' || existente.estado === 'Vacía') manejarEstado('vacia');
            else if (existente.estado === 'Averiada') manejarEstado('averiada');
            
        } else {
            document.getElementById('advertenciaDuplicado').style.display = 'none';
        }
    }

    function manejarEstado(estado) {
        document.getElementById('cargadaDetalles').style.display = 'none';
        document.getElementById('averiadaDetalles').style.display = 'none';

        if (estado === 'cargada') {
            document.getElementById('cargadaDetalles').style.display = 'block';
            document.getElementById('descCargada').focus();
            if (registroDuplicado && registroDuplicado.estado === 'Cargada') {
                 document.getElementById('descCargada').value = registroDuplicado.descripcion;
            }
        } else if (estado === 'averiada') {
            document.getElementById('averiadaDetalles').style.display = 'block';
            document.getElementById('descAveriada').focus();
            if (registroDuplicado && registroDuplicado.estado === 'Averiada') {
                 document.getElementById('descAveriada').value = registroDuplicado.descripcion;
            }
        } else if (estado === 'vacia') { 
            guardarRegistro('vacia', 'Lista para cargar');
        }
    }
    
    function microInteraccionBoton(buttonElement, estado) {
        const originalText = buttonElement.innerHTML;
        
        let confirmText = '';
        let confirmClass = '';
        
        if (estado === 'Cargada') {
            confirmText = '<i class="fas fa-check"></i> ¡Cargada!';
            confirmClass = 'btn-confirm-cargada';
        } else if (estado === 'Vacía') {
            confirmText = '<i class="fas fa-check"></i> ¡Vacía!';
            confirmClass = 'btn-confirm-vacia';
        } else if (estado === 'Averiada') {
            confirmText = '<i class="fas fa-times-circle"></i> ¡Avería!';
            confirmClass = 'btn-confirm-averiada';
        }

        buttonElement.innerHTML = confirmText;
        buttonElement.classList.add(confirmClass);
        buttonElement.disabled = true; 

        setTimeout(() => {
            buttonElement.innerHTML = originalText;
            buttonElement.classList.remove(confirmClass);
            buttonElement.disabled = false; 

            mostrarConfirmacion(`¡ registrada!`);
            mostrarPaso1(true); 
        }, 500); 
    }


    function guardarRegistro(estado, descripcionManual = '') {
        let descripcion = descripcionManual;
        let btnElement = null;

        if (estado === 'cargada') {
            descripcion = document.getElementById('descCargada').value;
            btnElement = document.getElementById('btnGuardarCargada');
            estado = 'Cargada'; 
        } else if (estado === 'averiada') {
            descripcion = document.getElementById('descAveriada').value;
            btnElement = document.getElementById('btnGuardarAveriada');
            estado = 'Averiada'; 
        } else if (estado === 'vacia') {
             descripcion = 'Lista para cargar';
             btnElement = document.getElementById('btnVacia');
             estado = 'Vacía'; 
        }

        if ((estado === 'Cargada' || estado === 'Averiada') && !descripcion.trim()) {
            mostrarConfirmacion(`Necesita descripción de .`, "fas fa-exclamation-triangle");
            return;
        }

        const registro = {
            matricula: matriculaActual,
            estado: estado,
            descripcion: descripcion.trim() || 'N/A',
            fecha: new Date().toLocaleString()
        };

        let registros = cargarRegistros();
        
        registros = registros.filter(reg => reg.matricula !== matriculaActual);
        registros.push(registro);
        guardarRegistros(registros);

        if (btnElement) {
            microInteraccionBoton(btnElement, registro.estado);
        }
    }

    // --- CONTADORES Y HISTORIAL (Mantenidos) ---
    function actualizarHistorialReciente() {
        const registros = cargarRegistros().reverse();
        const ul = document.getElementById('historialReciente');
        ul.innerHTML = ''; 
        
        if (registros.length === 0) {
            ul.innerHTML = '<li style="justify-content:center; color: var(--text-light-gray); border-bottom: none;">Aún no hay movimientos registrados.</li>';
            return;
        }

        const ultimosRegistros = registros.slice(0, 5);
        
        ultimosRegistros.forEach(reg => {
            const partesFecha = reg.fecha.split(', ');
            const hora = partesFecha.length > 1 ? partesFecha[1] : partesFecha[0];

            const estadoDisplay = (reg.estado === 'Disponible' || reg.estado === 'Vacía') ? 'Vacía' : reg.estado;
            const estadoClass = `estado-${estadoDisplay}`;
            
            const li = document.createElement('li');
            li.innerHTML = `
                <span class="historial-matricula">${reg.matricula}</span>
                <span class="historial-estado ${estadoClass}">${estadoDisplay}</span>
                <span class="historial-time">${hora}</span>
            `;
            ul.appendChild(li);
        });
    }

    function actualizarContadores() {
        const registros = cargarRegistros();
        let counts = { Cargada: 0, Disponible: 0, Averiada: 0, Total: registros.length };

        registros.forEach(reg => {
            if (reg.estado === 'Cargada') counts.Cargada++;
            else if (reg.estado === 'Disponible' || reg.estado === 'Vacía') counts.Disponible++; 
            else if (reg.estado === 'Averiada') counts.Averiada++;
        });

        const totalFlota = counts.Total;
        
        document.getElementById('countTotal').textContent = counts.Total;
        document.getElementById('countCargada').textContent = counts.Cargada;
        document.getElementById('countDisponible').textContent = counts.Disponible; 
        document.getElementById('countAveriada').textContent = counts.Averiada;

        const updateCompactCard = (state, count) => {
            const percentValue = totalFlota > 0 ? Math.round((count / totalFlota) * 100) : 0;
            const percentText = `${percentValue}%`;
            
            const percentElement = document.getElementById(`percent${state}`);
            if(percentElement) percentElement.textContent = percentText;
            
            const fillElement = document.getElementById(`fill${state}`);
            if(fillElement) fillElement.style.width = percentText;
        };

        updateCompactCard('Cargada', counts.Cargada);
        updateCompactCard('Disponible', counts.Disponible); 
        updateCompactCard('Averiada', counts.Averiada);
        
        const cardIds = ['cardTotal', 'cardCargada', 'cardDisponible', 'cardAveriada'];
        cardIds.forEach((id, index) => {
            const item = document.getElementById(id);
            if (!item.classList.contains('visible')) {
                setTimeout(() => {
                    item.classList.add('visible');
                }, 50 + index * 50); 
            }
        });
    }

    // --- FUNCIÓN DE PARALLAX (Sombra Dinámica en Header) ---
    function handleScroll() {
        const header = document.getElementById('fixedHeader');
        const scrollPosition = window.scrollY;
        
        // Aplica la clase 'scrolled' si el scroll supera un umbral pequeño (por ejemplo, 10px)
        if (scrollPosition > 10) {
            header.classList.add('scrolled');
        } else {
            header.classList.remove('scrolled');
        }
    }

    // --- LIMPIAR REGISTROS (Mantenidos) ---
    function confirmarLimpiarRegistros() {
        if (confirm("¿Estás seguro de que quieres ELIMINAR TODOS los registros? Esta acción no se puede deshacer.")) {
            limpiarRegistros();
        }
    }

    function limpiarRegistros() {
        localStorage.removeItem('registrosMatriculas');
        actualizarContadores();
        actualizarHistorialReciente();
        mostrarConfirmacion("Registros eliminados.", "fas fa-trash-alt");
    }

    // -----------------------------------------------------
    // --- FUNCIÓN EXPORTAR A PDF MODIFICADA ---
    // -----------------------------------------------------
    function exportarPDF() {
        const registros = cargarRegistros();
        if (registros.length === 0) {
            mostrarConfirmacion("No hay registros para exportar.", "fas fa-info-circle");
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4'); 
        const margin = 15; // Margen en mm
        let yPos = 15;
        const pageWidth = doc.internal.pageSize.width; 
        
        const registrosCargadas = registros
            .filter(reg => reg.estado === 'Cargada')
            .map(reg => [reg.matricula.toUpperCase(), reg.descripcion.toUpperCase()]); 
        
        const registrosDisponibles = registros
            .filter(reg => reg.estado === 'Disponible' || reg.estado === 'Vacía')
            .map(reg => [reg.matricula.toUpperCase()]);
        
        const registrosAveriadas = registros
            .filter(reg => reg.estado === 'Averiada')
            .map(reg => [reg.matricula.toUpperCase(), reg.descripcion.toUpperCase()]);
            
        const counts = {
            Cargada: registrosCargadas.length,
            Disponible: registrosDisponibles.length,
            Averiada: registrosAveriadas.length,
            Total: registros.length
        };
        
        // --- COLORES ---
        const COLOR_TEXTO_OSCURO = [30, 30, 30];
        const COLOR_TEXTO_MUTED = [75, 85, 99];
        const COLOR_ACCENT = [239, 68, 68]; // Rojo XPO
        const COLOR_CARD_BG = [255, 255, 255];
        const COLOR_HEADER_BG = [248, 250, 252]; 
        const COLOR_SEPARATOR = [243, 244, 246];

        // --- CABECERA (Pulida y Sin Esquinas) ---
        doc.setFillColor(COLOR_CARD_BG[0], COLOR_CARD_BG[1], COLOR_CARD_BG[2]);
        // Usamos solo el rectángulo redondeado con relleno, sin bordes para un acabado más limpio
        doc.roundedRect(margin - 1, yPos - 5, pageWidth - margin * 2 + 2, 30, 5, 5, 'F'); 
        
        // Texto CODE
        doc.setFont("helvetica", "normal");
        doc.setFontSize(8);
        doc.setTextColor(31, 41, 55); 
        doc.text("CODE", pageWidth - margin - 2, yPos, { align: 'right' }); 
        
        // XPO LOGISTICS
        doc.setFontSize(16);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(COLOR_ACCENT[0], COLOR_ACCENT[1], COLOR_ACCENT[2]);
        doc.text("XPO", pageWidth / 2, yPos + 2, { align: 'center' }); 
        
        doc.setFontSize(10);
        doc.setTextColor(COLOR_TEXTO_OSCURO[0], COLOR_TEXTO_OSCURO[1], COLOR_TEXTO_OSCURO[2]);
        doc.text("LOGISTICS", pageWidth / 2, yPos + 6.5, { align: 'center' });
        
        // Título Reporte
        doc.setFontSize(11);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(COLOR_TEXTO_OSCURO[0], COLOR_TEXTO_OSCURO[1], COLOR_TEXTO_OSCURO[2]);
        doc.text("REPORTE DIARIO DE PLATAFORMAS", pageWidth / 2, yPos + 14, { align: 'center' }); 

        // Fecha
        const currentDate = new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }).toUpperCase();
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        doc.setTextColor(COLOR_TEXTO_MUTED[0], COLOR_TEXTO_MUTED[1], COLOR_TEXTO_MUTED[2]);
        doc.text(currentDate, pageWidth / 2, yPos + 18, { align: 'center' });
        
        yPos += 30 + 10; // Salto después de la cabecera
        
        // --- TABLAS DE DOS COLUMNAS ---
        const tableMarginX = 5; 
        const halfWidth = (pageWidth - margin * 2 - tableMarginX) / 2;
        let startYDoubleColumn = yPos;
        
        const styles = { 
            fontSize: 9, 
            cellPadding: 2, 
            valign: 'middle', 
            font: "helvetica", 
            textColor: [51, 51, 51], 
            lineColor: COLOR_SEPARATOR, 
            lineWidth: { top: 0, right: 0, bottom: 0.1, left: 0 }, 
            fontStyle: 'normal' 
        };
        const headStyles = { 
            fillColor: COLOR_HEADER_BG, 
            textColor: [55, 65, 81], 
            fontStyle: 'bold', 
            lineWidth: { top: 0.1, right: 0, bottom: 0.1, left: 0 }, 
            cellPadding: 3 
        };
        const alternateRowStyles = { fillColor: [252, 252, 252] };

        // 1. Cargadas (Columna Izquierda)
        doc.setFontSize(10);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(COLOR_TEXTO_OSCURO[0], COLOR_TEXTO_OSCURO[1], COLOR_TEXTO_OSCURO[2]);
        doc.text(`PLATAFORMAS CARGADAS (${counts.Cargada})`, margin, startYDoubleColumn); 
        startYDoubleColumn += 2;
        
        doc.autoTable({
            head: [['MATRICULA', 'CONTENIDO']],
            body: registrosCargadas.length > 0 ? registrosCargadas : [['', 'No hay plataformas cargadas']],
            startY: startYDoubleColumn + 2,
            margin: { left: margin, right: pageWidth - (margin + halfWidth) }, 
            tableWidth: halfWidth,
            styles: styles,
            headStyles: headStyles,
            alternateRowStyles: alternateRowStyles, 
            columnStyles: {
                // MATRICULA ajustada
                0: { cellWidth: 25 }, 
                // CONTENIDO con encabezado alineado a la derecha
                1: { cellWidth: 'auto', headStyles: { halign: 'right' } } 
            },
            bodyStyles: { fontStyle: registrosCargadas.length === 0 ? 'italic' : 'normal', textColor: registrosCargadas.length === 0 ? COLOR_TEXTO_MUTED : [51, 51, 51] }
        });
        let finalYCargadas = doc.autoTable.previous.finalY;

        // 2. Vacías (Columna Derecha)
        const xPosVacias = margin + halfWidth + tableMarginX;
        startYDoubleColumn = yPos; 
        doc.setFontSize(10);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(COLOR_TEXTO_OSCURO[0], COLOR_TEXTO_OSCURO[1], COLOR_TEXTO_OSCURO[2]);
        doc.text(`PLATAFORMAS VACIAS (${counts.Disponible})`, xPosVacias, startYDoubleColumn); 
        startYDoubleColumn += 2;
        
        doc.autoTable({
            head: [['MATRICULA']],
            body: registrosDisponibles.length > 0 ? registrosDisponibles : [['No hay plataformas vacías']],
            startY: startYDoubleColumn + 2, 
            margin: { left: xPosVacias, right: margin }, 
            tableWidth: halfWidth,
            styles: styles,
            headStyles: headStyles,
            alternateRowStyles: alternateRowStyles, 
            columnStyles: {
                // MATRICULA ajustada para usar todo el ancho disponible
                0: { cellWidth: 'auto' } 
            },
            bodyStyles: { fontStyle: registrosDisponibles.length === 0 ? 'italic' : 'normal', textColor: registrosDisponibles.length === 0 ? COLOR_TEXTO_MUTED : [51, 51, 51] }
        });
        let finalYDisponibles = doc.autoTable.previous.finalY;

        let finalY = Math.max(finalYCargadas, finalYDisponibles); 
        
        
        // 3. Averías (Sección completa)
        if (registrosAveriadas.length > 0) {
            
            if (finalY + 20 > doc.internal.pageSize.height - margin) {
                doc.addPage();
                finalY = margin;
            } else {
                 finalY += 10; 
            }

            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(COLOR_TEXTO_OSCURO[0], COLOR_TEXTO_OSCURO[1], COLOR_TEXTO_OSCURO[2]);
            doc.text(`PLATAFORMAS AVERIADAS (${counts.Averiada})`, margin, finalY + 5); 
            
            doc.autoTable({
                head: [['MATRICULA', 'DESCRIPCION DE AVERÍA']],
                body: registrosAveriadas,
                startY: finalY + 10,
                margin: { left: margin, right: margin },
                styles: styles,
                headStyles: headStyles,
                alternateRowStyles: alternateRowStyles, 
                columnStyles: {
                    // MATRICULA ajustada
                    0: { cellWidth: 30 }, 
                    1: { cellWidth: 'auto' }
                }
            });
        }

        // --- PIE DE PÁGINA ---
        const pageCount = doc.internal.getNumberOfPages();
        for(let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            
            // Línea separadora
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.1);
            doc.line(margin, doc.internal.pageSize.height - 10, pageWidth - margin, doc.internal.pageSize.height - 10);
            
            doc.setFontSize(8);
            doc.setTextColor(COLOR_TEXTO_MUTED[0], COLOR_TEXTO_MUTED[1], COLOR_TEXTO_MUTED[2]);
            doc.setFont("helvetica", "normal");

            // Izquierda
            doc.text(`GENERADO POR XPO LOGISTICS`, margin, doc.internal.pageSize.height - 5);
            
            // Centro (Link)
            doc.setTextColor(37, 99, 235); // Color azul del link
            doc.text(`AppCode.com`, pageWidth / 2, doc.internal.pageSize.height - 5, { align: 'center' });
            
            // Derecha (Paginación)
            doc.setTextColor(COLOR_TEXTO_MUTED[0], COLOR_TEXTO_MUTED[1], COLOR_TEXTO_MUTED[2]);
            doc.text(`PÁGINA ${i} DE ${pageCount}`, pageWidth - margin, doc.internal.pageSize.height - 5, { align: 'right' });
        }

        doc.save("Reporte_XPO_Diario_Plataformas.pdf");
        mostrarConfirmacion("PDF exportado correctamente.", "fas fa-file-pdf");
    }

    // --- LÓGICA DE ANIMACIÓN OPTIMIZADA (Mantenida) ---
    function animarLogo() {
        // Esta función podría ser usada para la animación inicial, pero ya no afecta el header-fixed de la misma manera.
        const logoCode = document.querySelector('.logo-code');
        const logoXPO = document.querySelector('.logo-xpo');

        logoCode.style.opacity = '0';
        logoXPO.style.opacity = '0';
        logoXPO.style.transform = 'translateY(10px)';

        if (!localStorage.getItem('logoAnimado')) {
             setTimeout(() => {
                logoCode.style.opacity = '1';
             }, 50);

             setTimeout(() => {
                logoXPO.style.opacity = '1';
                logoXPO.style.transform = 'translateY(0)';
             }, 350); 
             
             localStorage.setItem('logoAnimado', 'true');
        } else {
            logoCode.style.opacity = '1';
            logoXPO.style.opacity = '1';
            logoXPO.style.transform = 'translateY(0)';
        }
    }


    // --- INICIALIZACIÓN ---
    document.addEventListener('DOMContentLoaded', () => {
        animarLogo();
        actualizarContadores();
        actualizarHistorialReciente(); 
        
        document.getElementById('paso1').style.display = 'block';
        document.getElementById('paso1').style.position = 'relative'; 
        document.getElementById('paso1').classList.add('active');
        document.getElementById('matriculaInput').focus();
        
        // --- ACTIVAR EL MANEJO DE SCROLL PARA EL EFECTO DINÁMICO ---
        window.addEventListener('scroll', handleScroll);
        // Llamar una vez al inicio para el caso de recargas con scroll ya aplicado
        handleScroll(); 
    });
</script>

</body>
</html>
