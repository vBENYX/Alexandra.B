<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Registro Táctil de Matrículas</title>
    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Variables y Reset para Móviles (iOS Theme) */
        :root {
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-red: #FF3B30;
            --ios-yellow: #FFCC00;
            --ios-gray-bg: #f2f2f7;
            --ios-card-bg: #ffffff;
            --ios-separator: #d1d1d6;
            --ios-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --transition-duration: 0.35s;
        }

        /* Estilo Base: Fondo de iOS y Tipografía SF Pro */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            background-color: var(--ios-gray-bg);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: #1c1c1e;
            overflow-x: hidden;
        }
        
        /* Contenedor Principal */
        .container {
            width: 100%;
            max-width: 450px;
            margin-top: 15px;
            background-color: transparent; 
            box-shadow: none;
            position: relative;
            height: auto;
            min-height: 600px;
            overflow: hidden;
        }

        /* Encabezado Principal */
        h1 {
            font-size: 28px;
            font-weight: 700;
            padding: 15px 20px;
            margin: 0;
            color: #1c1c1e;
        }

        /* Estructura de Tarjetas */
        .card-section {
            background-color: var(--ios-card-bg);
            margin: 10px 0;
            padding: 20px;
            border-radius: 10px;
            box-shadow: var(--ios-shadow);
        }

        /* Transiciones de Pasos (Slide Horizontal) */
        .step-content {
            opacity: 0;
            transform: translateX(100%); 
            transition: opacity var(--transition-duration) ease-out, transform var(--transition-duration) ease-out;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box;
            padding: 20px;
            background-color: var(--ios-card-bg);
            border-radius: 10px;
            box-shadow: var(--ios-shadow);
        }
        
        .step-content.active {
            opacity: 1;
            transform: translateX(0);
            position: relative;
            display: block;
            margin-bottom: 20px;
        }
        
        .step-content.backward {
            transform: translateX(-100%);
        }

        /* Campos de Entrada */
        input[type="text"] {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--ios-separator);
            border-radius: 10px;
            box-sizing: border-box;
            font-size: 18px;
            background-color: #f9f9f9;
            transition: border-color 0.2s;
            -webkit-appearance: none;
        }

        input[type="text"]:focus {
            border-color: var(--ios-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
            outline: none;
            background-color: var(--ios-card-bg);
        }
        
        /* Botones Principales */
        button {
            width: 100%;
            background-color: var(--ios-blue);
            color: white;
            padding: 15px 20px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: opacity 0.1s, transform 0.1s;
            -webkit-appearance: none;
        }

        button:active {
            opacity: 0.8;
            transform: scale(0.99);
        }
        
        /* Botones de Estado */
        #botonesEstado {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
        }

        #botonesEstado button {
            background-color: #e5e5ea;
            color: #3c3c43;
            font-weight: 500;
            flex-grow: 1;
            padding: 12px 10px;
            margin: 0;
            font-size: 16px;
        }
        
        #botonesEstado button:active {
            transform: scale(1);
        }

        /* Contadores (Micrográficos) */
        #contadores {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 15px;
            gap: 10px;
        }

        .contador-item {
            background-color: #f9f9fb;
            padding: 12px 8px;
            border-radius: 8px;
            text-align: center;
            min-width: 45%;
            flex-grow: 1;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        
        .contador-item.visible {
             opacity: 1;
             transform: translateY(0);
        }

        .contador-item h4 {
            margin: 0 0 5px 0;
            font-size: 0.9em;
            color: var(--text-light-gray);
            font-weight: 400;
        }

        .contador-item .count {
            font-size: 1.8em;
            font-weight: 600;
        }

        /* Colores Específicos */
        .cargada .count { color: var(--ios-green); } 
        .disponible .count { color: var(--ios-yellow); } 
        .averiada .count { color: var(--ios-red); } 
        .total .count { color: var(--ios-blue); }
        
        /* Botón de Eliminación (Rojo) */
        #btnEliminar {
            background-color: #FF3B30;
            margin-top: 10px;
        }
        #btnEliminar:hover {
            background-color: #cc2e26;
        }
        
    </style>
</head>
<body>
<div style="max-width:450px; width:100%;">
    <h1>Registro Rápido de Matrículas</h1>
</div>

<div class="container">
    
    <div id="paso1" class="step-content active">
        <h3><i class="fas fa-barcode"></i> 1. Ingresar Matrícula</h3>
        <input type="text" id="matriculaInput" placeholder="Matrícula (Escanear o Tipear)" required>
        <button onclick="registrarMatricula()"><i class="fas fa-arrow-right"></i> Continuar</button>
    </div>

    <div id="paso2" class="step-content">
        <h3><i class="fas fa-tag"></i> 2. Estado para <span id="mostrarMatricula"></span></h3>
        
        <div id="botonesEstado">
            <button onclick="manejarEstado('cargada')">Cargada</button>
            <button onclick="manejarEstado('disponible')">Disponible</button>
            <button onclick="manejarEstado('averiada')">Averiada</button>
        </div>

        <div id="cargadaDetalles" style="display:none;">
            <input type="text" id="descCargada" placeholder="Descripción de la carga (Requerido)">
            <button onclick="guardarRegistro('cargada')"><i class="fas fa-check-circle"></i> Registrar Carga</button>
        </div>

        <div id="averiadaDetalles" style="display:none;">
            <input type="text" id="descAveriada" placeholder="Descripción de la avería (Requerido)">
            <button onclick="guardarRegistro('averiada')"><i class="fas fa-check-circle"></i> Registrar Avería</button>
        </div>

        <button class="volver-button" onclick="mostrarPaso1(true)"><i class="fas fa-chevron-left"></i> Volver</button>
    </div>
    
    <div id="reportes" class="card-section" style="margin-top: 0;">
        <h3><i class="fas fa-chart-bar"></i> Resumen de Registros</h3>
        
        <div id="contadores">
            <div class="contador-item cargada">
                <h4>Cargadas</h4>
                <div class="count" id="countCargada">0</div>
            </div>
            <div class="contador-item disponible">
                <h4>Disponibles</h4>
                <div class="count" id="countDisponible">0</div>
            </div>
            <div class="contador-item averiada">
                <h4>Averiadas</h4>
                <div class="count" id="countAveriada">0</div>
            </div>
            <div class="contador-item total">
                <h4>TOTAL</h4>
                <div class="count" id="countTotal">0</div>
            </div>
        </div>
        
        <button onclick="exportarPDF()" style="background-color:#34c759; margin-top: 25px;">
            <i class="fas fa-file-pdf"></i> Exportar a PDF (Pages Moderno)
        </button>
        
        <button id="btnEliminar" onclick="confirmarLimpiarRegistros()">
            <i class="fas fa-trash-alt"></i> Eliminar Todos los Registros
        </button>
    </div>

</div>

<div id="confirmationMessage" class="confirmation-message">
    <i class="fas fa-check-circle"></i> Registrado con éxito
</div>


<script>
    let matriculaActual = "";

    // --- FUNCIONES DE UTILIDAD ---
    function guardarRegistros(registros) {
        localStorage.setItem('registrosMatriculas', JSON.stringify(registros));
        actualizarContadores();
    }

    function cargarRegistros() {
        return JSON.parse(localStorage.getItem('registrosMatriculas') || '[]');
    }

    function mostrarConfirmacion(mensaje = "Registrado con éxito", icono = "fas fa-check-circle") {
        const confirmMsg = document.getElementById('confirmationMessage');
        confirmMsg.innerHTML = `<i class="${icono}"></i> ${mensaje}`;
        confirmMsg.classList.add('show');
        setTimeout(() => {
            confirmMsg.classList.remove('show');
        }, 1500);
    }

    // --- GESTIÓN DE PANTALLAS (Transiciones) ---
    function mostrarPaso(pasoId, backward = false) {
        const currentActive = document.querySelector('.step-content.active');
        const targetPaso = document.getElementById(pasoId);

        if (currentActive) {
             if (currentActive.id !== targetPaso.id) {
                currentActive.classList.remove('active');
                if (backward) {
                    currentActive.style.transform = 'translateX(100%)';
                } else {
                    currentActive.style.transform = 'translateX(-100%)';
                }
                currentActive.style.opacity = 0;
                setTimeout(() => { currentActive.style.display = 'none'; }, 350); 
             }
        }
        
        targetPaso.style.display = 'block';
        if (backward) {
            targetPaso.style.transform = 'translateX(-100%)';
        } else {
            targetPaso.style.transform = 'translateX(100%)';
        }
        targetPaso.style.opacity = 0;
        
        setTimeout(() => {
            targetPaso.classList.add('active');
            targetPaso.style.transform = 'translateX(0)';
            targetPaso.style.opacity = 1;
        }, 50); 
    }

    function mostrarPaso1(isBackward = false) {
        mostrarPaso('paso1', isBackward);
        matriculaActual = "";
        document.getElementById('matriculaInput').value = '';
        document.getElementById('descCargada').value = '';
        document.getElementById('descAveriada').value = '';
        document.getElementById('matriculaInput').focus();
    }

    function registrarMatricula() {
        matriculaActual = document.getElementById('matriculaInput').value.toUpperCase().trim();
        if (matriculaActual) {
            mostrarPaso('paso2', false); 
            document.getElementById('mostrarMatricula').textContent = matriculaActual;
            document.getElementById('cargadaDetalles').style.display = 'none';
            document.getElementById('averiadaDetalles').style.display = 'none';
        } else {
            mostrarConfirmacion("Ingrese la matrícula.", "fas fa-exclamation-triangle");
        }
    }

    function manejarEstado(estado) {
        document.getElementById('cargadaDetalles').style.display = 'none';
        document.getElementById('averiadaDetalles').style.display = 'none';

        if (estado === 'cargada') {
            document.getElementById('cargadaDetalles').style.display = 'block';
            document.getElementById('descCargada').focus();
        } else if (estado === 'averiada') {
            document.getElementById('averiadaDetalles').style.display = 'block';
            document.getElementById('descAveriada').focus();
        } else if (estado === 'disponible') {
            guardarRegistro('disponible', 'Lista para cargar');
        }
    }

    function guardarRegistro(estado, descripcionManual = '') {
        let descripcion = descripcionManual;

        if (estado === 'cargada') {
            descripcion = document.getElementById('descCargada').value;
        } else if (estado === 'averiada') {
            descripcion = document.getElementById('descAveriada').value;
        }

        if ((estado === 'cargada' || estado === 'averiada') && !descripcion.trim()) {
            mostrarConfirmacion(`Necesita descripción de ${estado}.`, "fas fa-exclamation-triangle");
            return;
        }

        const registro = {
            matricula: matriculaActual,
            estado: estado.charAt(0).toUpperCase() + estado.slice(1),
            descripcion: descripcion.trim() || 'N/A',
            fecha: new Date().toLocaleString()
        };

        let registros = cargarRegistros();
        registros.push(registro);
        guardarRegistros(registros);

        mostrarConfirmacion(`¡${registro.estado} registrada!`);
        mostrarPaso1(true); 
    }

    // --- CONTADORES (Actualizado) ---
    function actualizarContadores() {
        const registros = cargarRegistros();
        let counts = { Cargada: 0, Disponible: 0, Averiada: 0, Total: registros.length };

        registros.forEach(reg => {
            if (reg.estado === 'Cargada') counts.Cargada++;
            else if (reg.estado === 'Disponible') counts.Disponible++; 
            else if (reg.estado === 'Averiada') counts.Averiada++;
        });

        document.getElementById('countCargada').textContent = counts.Cargada;
        document.getElementById('countDisponible').textContent = counts.Disponible; 
        document.getElementById('countAveriada').textContent = counts.Averiada;
        document.getElementById('countTotal').textContent = counts.Total;
        
        document.querySelectorAll('.contador-item').forEach((item, index) => {
            item.classList.remove('visible'); 
            setTimeout(() => {
                item.classList.add('visible');
            }, 50 + index * 50); 
        });
    }

    // --- LIMPIAR REGISTROS ---
    function confirmarLimpiarRegistros() {
        if (confirm("¿Estás seguro de que quieres ELIMINAR TODOS los registros? Esta acción no se puede deshacer.")) {
            limpiarRegistros();
        }
    }

    function limpiarRegistros() {
        localStorage.removeItem('registrosMatriculas');
        actualizarContadores();
        mostrarConfirmacion("Registros eliminados.", "fas fa-trash-alt");
    }

    // --- EXPORTACIÓN A PDF (Pages Moderno, Minimalista, 3D Sutil) ---
    function exportarPDF() {
        const registros = cargarRegistros();
        if (registros.length === 0) {
            mostrarConfirmacion("No hay registros para exportar.", "fas fa-info-circle");
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const margin = 10;
        let yPos = 20; 
        
        // Cargar datos
        const registrosCargadas = registros
            .filter(reg => reg.estado === 'Cargada')
            .map(reg => [reg.matricula, reg.descripcion]); 
        
        const registrosDisponibles = registros
            .filter(reg => reg.estado === 'Disponible')
            .map(reg => [reg.matricula]);
        
        const registrosAveriadas = registros
            .filter(reg => reg.estado === 'Averiada')
            .map(reg => [reg.matricula, reg.descripcion]);
            
        // Contadores para el PDF
        const countCargada = registrosCargadas.length;
        const countDisponible = registrosDisponibles.length;
        const countAveriada = registrosAveriadas.length;
        const countTotal = registros.length;


        // 2. Título Principal (iOS Bold)
        doc.setFont("helvetica", "bold");
        doc.setFontSize(24);
        doc.text("Reporte de Movimientos", margin, yPos);
        yPos += 10;

        // 3. Contadores Sutiles y Compactos (Estilo Ficha)
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        
        const summaryText = 
            `Total: ${countTotal} | Cargadas: ${countCargada} | Disponibles: ${countDisponible} | Averiadas: ${countAveriada}`;
            
        doc.setTextColor(100, 100, 100); // Gris claro sutil
        doc.text(summaryText, margin, yPos);
        yPos += 10;
        doc.setTextColor(51, 51, 51); // Volver a texto oscuro para las tablas

        // --- Estilos de Tabla Avanzados (Minimalista, 3D Sutil) ---
        const tableWidth = (doc.internal.pageSize.width / 2) - (margin * 1.5);
        const styles = {
            fontSize: 7, 
            cellPadding: 2, // Ligeramente más padding para que se vea limpio
            valign: 'middle',
            font: "helvetica",
            textColor: [51, 51, 51],
            lineColor: [240, 240, 240], // Líneas casi invisibles
            lineWidth: 0.1
        };

        // Estilos de Encabezado (Gris Muy Suave con Borde Fuerte para 3D)
        const headStyles = {
            fillColor: [247, 247, 247], // Fondo gris muy pálido
            textColor: [51, 51, 51], // Texto oscuro sutil
            fontStyle: 'bold',
            lineColor: [180, 180, 180], // Línea de separación sutil
            lineWidth: { top: 0, right: 0, bottom: 0.5, left: 0 }, // Borde inferior más grueso (efecto 3D)
            cellPadding: 3.5 // Más padding vertical en el header
        };
        
        const startYGeneral = yPos + 5; // Separación del texto del contador

        // --- Columna Izquierda: CARGADAS ---
        doc.setFontSize(12);
        doc.setFont("helvetica", "bold");
        doc.text("Cargas Activas", margin, startYGeneral);

        doc.autoTable({
            head: [['Matrícula', 'Carga']],
            body: registrosCargadas,
            startY: startYGeneral + 3,
            margin: { left: margin, right: doc.internal.pageSize.width / 2 },
            tableWidth: tableWidth,
            styles: styles,
            headStyles: headStyles,
            alternateRowStyles: { fillColor: [255, 255, 255] }, // Fondo blanco para filas alternas (maximalista minimalista)
        });
        let finalYCargadas = doc.autoTable.previous.finalY;

        // --- Columna Derecha: DISPONIBLES ---
        doc.setFontSize(12);
        doc.setFont("helvetica", "bold");
        doc.text("Disponibles", doc.internal.pageSize.width / 2 + margin / 2, startYGeneral);
        
        doc.autoTable({
            head: [['Matrícula']],
            body: registrosDisponibles,
            startY: startYGeneral + 3,
            margin: { left: doc.internal.pageSize.width / 2 + margin / 2, right: margin },
            tableWidth: tableWidth,
            styles: styles,
            headStyles: headStyles,
            alternateRowStyles: { fillColor: [255, 255, 255] }, 
        });
        let finalYDisponibles = doc.autoTable.previous.finalY;

        // --- Tabla Averiadas (Abajo) ---
        let finalY = Math.max(finalYCargadas, finalYDisponibles);
        
        if (registrosAveriadas.length > 0) {
            
            if (finalY + 30 > doc.internal.pageSize.height - margin) {
                doc.addPage();
                finalY = margin + 10;
            }

            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("Matrículas Averiadas", margin, finalY + 10);
            
            // Estilo para averiadas (sutil tono gris/beige cálido)
            const averiadaHeadStyles = JSON.parse(JSON.stringify(headStyles)); // Clonar
            averiadaHeadStyles.fillColor = [252, 252, 252]; 
            
            doc.autoTable({
                head: [['Matrícula', 'Avería']],
                body: registrosAveriadas,
                startY: finalY + 15,
                margin: { left: margin, right: margin },
                styles: styles,
                headStyles: averiadaHeadStyles,
                alternateRowStyles: { fillColor: [255, 255, 255] }, 
            });
        }
        
        // --- Pie de página (Número de página) ---
        const pageCount = doc.internal.getNumberOfPages();
        for(let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(7);
            doc.text(`Página ${i} de ${pageCount}`, doc.internal.pageSize.width - margin, doc.internal.pageSize.height - 5, { align: 'right' });
        }

        // 4. Guardar el PDF
        doc.save("Reporte_Pages_Moderno.pdf");
        mostrarConfirmacion("PDF exportado con estilo Pages Moderno.", "fas fa-file-pdf");
    }

    // --- INICIALIZACIÓN ---
    document.addEventListener('DOMContentLoaded', () => {
        actualizarContadores();
        
        document.getElementById('paso1').style.display = 'block';
        document.getElementById('paso2').style.display = 'none';
        
        document.getElementById('paso1').style.transform = 'translateX(0)';
        document.getElementById('paso1').style.opacity = 1;
        
        document.getElementById('matriculaInput').focus();
    });
</script>

</body>
</html>
