<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
<title>XPO — Registro de Plataformas (Apple FX)</title>

<style>
/* ===== Reset mínimo ===== */
*{box-sizing:border-box}html,body{height:100%}body{margin:0}
h1,h2,h3,h4,p{margin:0}button,input,textarea,select{font:inherit}
img,svg,video{display:block;max-width:100%}

/* ===== Tokens (sin modo oscuro) ===== */
:root{
  --accent:#0A84FF;
  --bg:#F5F6F7;
  --panel:#FFFFFF;
  --line:#E6E6EA;
  --text:#111418;
  --muted:#6A6F75;
  --radius:18px;
  --shadow-1:0 10px 28px rgba(0,0,0,.06);
  --shadow-2:0 4px 18px rgba(0,0,0,.07);
  --ease-snap:cubic-bezier(.22,1,.36,1);
  --ease-soft:cubic-bezier(.25,.8,.25,1);
  --blur:18px;
  --glass:rgba(255,255,255,.68);
}

@media (prefers-reduced-motion: reduce){
  *{animation-duration:.001ms !important; animation-iteration-count:1 !important; transition-duration:.001ms !important; scroll-behavior:auto !important}
}

/* ===== Base ===== */
html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizeLegibility}
body{
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display",system-ui,Segoe UI,Roboto,Helvetica,Arial;
  background:radial-gradient(1200px 600px at 10% -10%, rgba(10,132,255,.06), transparent 60%), var(--bg);
  color:var(--text); line-height:1.45; letter-spacing:.01em;
  scroll-behavior:smooth;
}
input,textarea,button,select{font-size:16px}
button{touch-action:manipulation;-webkit-tap-highlight-color:transparent}

.app{max-width:1040px;margin:0 auto;padding: calc(18px + env(safe-area-inset-top)) 16px calc(28px + env(safe-area-inset-bottom)) 16px}

/* ===== Header ===== */
.header{
  position:sticky; top:12px; z-index:10; border-radius:22px; padding:18px 20px;
  background:var(--glass); border:1px solid rgba(120,120,140,.22);
  backdrop-filter:saturate(1.4) blur(var(--blur));
  box-shadow:var(--shadow-1); overflow:hidden; isolation:isolate; transform:translateZ(0);
}
.header::before{content:""; position:absolute; inset:0; background:linear-gradient(180deg, rgba(10,132,255,.10), transparent 60%)}
.brand{display:flex;align-items:center;justify-content:center;gap:10px;font-weight:800;letter-spacing:.12em}

/* Chip CODE con efecto translúcido + shimmer */
.chip{
  position:relative; overflow:hidden;
  background:rgba(255,255,255,.68);
  border:1px solid var(--line);
  padding:6px 10px; border-radius:10px; font-weight:800;
  backdrop-filter:saturate(1.8) blur(8px);
  box-shadow:inset 0 0 0 0.5px rgba(255,255,255,.6);
}
.chip::after{
  content:""; position:absolute; top:-50%; left:-30%; width:60%; height:200%;
  background:linear-gradient(120deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.65) 50%, rgba(255,255,255,0) 100%);
  transform:rotate(12deg);
  animation:shimmer 3.6s infinite linear;
  pointer-events:none;
}
@keyframes shimmer{
  0%{ transform:translateX(-120%) rotate(12deg); }
  100%{ transform:translateX(220%) rotate(12deg); }
}
.headline{margin:6px 0 2px;text-align:center;font-weight:800;font-size:clamp(20px,3.3vw,28px)}

/* ===== Card flujo ===== */
.card{
  background:var(--panel); border:1px solid var(--line); border-radius:var(--radius);
  box-shadow:var(--shadow-2); margin:18px 0; overflow:hidden;
  transition:transform .35s var(--ease-soft), box-shadow .35s var(--ease-soft);
  scroll-margin-top:14px;
}
.card:hover{transform:translateY(-2px); box-shadow:0 10px 32px rgba(0,0,0,.12)}
.card:has(.screen.active:focus-within){outline:2px solid rgba(10,132,255,.18)}
.card-header{
  display:flex;align-items:center;justify-content:space-between;gap:8px;
  padding:12px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#FBFBFD,transparent);
}
.chevron{opacity:.65;user-select:none}
.title-lg{font-weight:800;letter-spacing:.02em}

.card-content{position:relative;min-height:240px; perspective:1000px}
.screen{
  position:absolute; inset:0; padding:18px 16px 18px;
  display:flex; flex-direction:column; gap:12px; align-items:center; justify-content:flex-start;
  opacity:0; transform:translateX(24px) scale(.985); pointer-events:none;
  transition:opacity .44s var(--ease-snap), transform .44s var(--ease-snap);
}
.screen.active{opacity:1; transform:none; pointer-events:auto}
.screen.out-left{animation:slideOutL .36s var(--ease-snap)}
.screen.out-right{animation:slideOutR .36s var(--ease-snap)}
@keyframes slideOutL{from{opacity:1;transform:none}to{opacity:0;transform:translateX(-24px) scale(.985)}}
@keyframes slideOutR{from{opacity:1;transform:none}to{opacity:0;transform:translateX(24px) scale(.985)}}

/* Pasos (puntos) */
.steps{display:flex;gap:8px;justify-content:center;padding:8px 0 10px}
.dot{width:10px;height:10px;border-radius:999px;background:#D4D6DA;transition:transform .25s var(--ease-snap), background .25s}
.dot.active{background:#0A84FF;transform:scale(1.35)}

/* Meta info limpia */
.meta{display:flex; flex-wrap:wrap; align-items:center; justify-content:center; gap:6px 10px; max-width:560px}
.meta .item{color:var(--muted); font-weight:600; white-space:nowrap}
.meta strong{color:var(--text);}

/* Inputs */
.input,.textarea{
  width:100%;max-width:560px;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;
  outline:none;transition:border-color .22s var(--ease-soft), box-shadow .22s var(--ease-soft), transform .12s;
}
.input:focus,.textarea:focus{border-color:var(--accent);box-shadow:0 0 0 8px rgba(10,132,255,.12);transform:translateY(-1px)}
.textarea{min-height:88px;max-height:220px;resize:vertical}
@media (max-width:480px){ .textarea{min-height:72px}}

/* Botones */
.row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;width:100%;max-width:560px}
.btn{
  position:relative; display:inline-flex;align-items:center;justify-content:center;gap:8px;
  padding:11px 14px;border:1px solid var(--line);border-radius:12px;font-weight:700;color:var(--text);background:#F2F3F5;
  box-shadow:0 1px 0 rgba(0,0,0,.04), 0 8px 20px rgba(0,0,0,.06);
  transition:transform .14s var(--ease-snap), box-shadow .2s var(--ease-soft), background .2s, border-color .2s, filter .18s;
  will-change:transform, box-shadow;
  overflow:hidden;
}
.btn:hover{background:#ECEEF2;border-color:#D9DCE1}
.btn:active{transform:scale(.985)}
.btn:disabled{opacity:.6;transform:none}
.btn-primary{background:var(--accent);color:#fff;border-color:transparent}
.btn-primary:hover{filter:brightness(0.98)}
.btn-secondary{background:#E9EAED}

/* Efecto pulsado */
.btn::after{
  content:""; position:absolute; left:var(--px,50%); top:var(--py,50%);
  width:0; height:0; border-radius:999px; opacity:0; pointer-events:none;
  background:rgba(255,255,255,.6); transform:translate(-50%,-50%);
}
.btn.pressed::after{ animation:pressPulse .5s var(--ease-snap) forwards; }
@keyframes pressPulse{
  0%{opacity:.45; width:0; height:0}
  70%{opacity:.15; width:200%; height:200%}
  100%{opacity:0; width:260%; height:260%}
}

/* Botones estado: grid exacto 3 columnas */
.row.states{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:10px;width:100%;max-width:560px}
.row.states .btn{width:100%}

/* ===== Panels / Pills ===== */
.panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow-2);margin:18px 0}

/* Pills progresivas (HTML) */
.pills{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.pill{position:relative; overflow:hidden; border:1px solid var(--line); border-radius:999px; padding:12px 16px;
  background:linear-gradient(180deg,#FBFBFC,transparent); box-shadow:0 2px 12px rgba(0,0,0,.04)}
.pill::before{content:""; position:absolute; inset:0; width:var(--fill,0%); background:linear-gradient(90deg, rgba(10,132,255,.18), rgba(10,132,255,.32)); transition:width .8s var(--ease-snap)}
.pill-inner{position:relative; display:flex; align-items:center; justify-content:space-between; gap:10px; z-index:1}
.pill .label{font-weight:800; letter-spacing:.02em}
.pill .val{font-weight:800; min-width:2.5ch; text-align:right; color:var(--accent)}

/* ===== Registros compactos ===== */
.compact{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow-2);}
.compact-header{
  position:sticky; top:12px; z-index:5; /* queda visible al hacer scroll */
  padding:10px; border-bottom:1px solid var(--line); background:linear-gradient(180deg,#FBFBFD,transparent);
  display:flex; gap:8px; justify-content:center; flex-wrap:wrap;
  border-top-left-radius:var(--radius); border-top-right-radius:var(--radius);
}
.segment{display:inline-flex; background:#F3F4F6; border:1px solid var(--line); border-radius:999px; padding:4px}
.segment button{
  border:0; background:transparent; padding:8px 12px; border-radius:999px; font-weight:700; color:#4B5563;
}
.segment button.active{background:#FFFFFF; border:1px solid var(--line); color:var(--text)}
.segment .badge{font-weight:800; margin-left:6px; color:#0A84FF}
.compact-body{max-height:52vh; overflow:auto; padding:12px}
.record{
  border:1px solid var(--line); border-radius:12px; padding:12px 12px; margin-bottom:10px; background:#fff;
  display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center;
}
.record .meta{justify-content:flex-start}
.actions{display:flex; gap:6px}
.action-btn{border:1px solid var(--line); background:#F2F3F5; padding:8px 10px; border-radius:10px; font-weight:700}
.action-btn:hover{background:#ECEEF2}

/* Modal edición */
.modal{
  position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:30;
  background:rgba(0,0,0,.18);
}
.modal.open{display:flex}
.modal-card{
  width:min(96vw,560px); background:#fff; border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow-1);
  padding:16px; display:flex; flex-direction:column; gap:10px;
}
.modal-title{font-weight:800; font-size:18px}
.modal-row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
.modal-actions{display:flex; gap:10px; justify-content:flex-end}
select{padding:12px 14px; border-radius:12px; border:1px solid var(--line); background:#fff}

.kbd{font-weight:700;padding:2px 6px;border-radius:6px;border:1px solid var(--line);background:rgba(0,0,0,.04)}
@media (max-width:640px){ .row .btn{flex:1 1 100%} .modal-row{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header" id="glassHeader" data-depth="0.18">
      <div class="brand">
        <div class="chip">CODE</div>
        <div>XPO LOGISTICS</div>
      </div>
      <div class="headline">Registro de Plataformas</div>
    </header>

    <!-- Card de flujo -->
    <section class="card" id="flowCard" aria-live="polite">
      <div class="card-header">
        <div class="chevron" aria-hidden="true">⟨</div>
        <div class="title-lg" id="flowTitle">Matrícula</div>
        <div class="chevron" aria-hidden="true">⟩</div>
      </div>

      <div class="card-content" id="screens">
        <!-- S1 -->
        <div class="screen active" id="s1" tabindex="-1">
          <input id="matriculaInput" class="input" autocomplete="off" placeholder="Introduce la matrícula" />
          <div class="row">
            <button class="btn btn-primary" id="toS2" aria-label="Continuar a Estado">Continuar</button>
          </div>
        </div>

        <!-- S2 -->
        <div class="screen" id="s2" tabindex="-1">
          <div class="meta" aria-live="polite">
            <div class="item">Matrícula:</div>
            <div class="item"><strong id="matriculaDisplay">—</strong></div>
          </div>
          <div class="row states" role="group" aria-label="Selecciona estado">
            <button class="btn" id="btnCargada">CARGADA</button>
            <button class="btn" id="btnVacia">VACÍA</button>
            <button class="btn" id="btnAveriada">AVERIADA</button>
          </div>
          <div class="row">
            <button class="btn btn-secondary" id="back1" aria-label="Volver a matrícula">Volver</button>
          </div>
        </div>

        <!-- S3 -->
        <div class="screen" id="s3" tabindex="-1">
          <div class="meta" aria-live="polite">
            <div class="item">Matrícula:</div>
            <div class="item"><strong id="matriculaDisplay2">—</strong></div>
            <div class="item">—</div>
            <div class="item">Estado:</div>
            <div class="item"><strong id="estadoDisplay">—</strong></div>
          </div>
          <textarea id="contenidoInput" class="textarea" placeholder="Describe el contenido o el problema…"></textarea>
          <div class="row">
            <button class="btn btn-primary" id="btnRegistrar">Registrar</button>
            <button class="btn btn-secondary" id="back2">Volver</button>
          </div>
        </div>
      </div>

      <div class="steps" aria-hidden="true">
        <div class="dot active" id="d1"></div>
        <div class="dot" id="d2"></div>
        <div class="dot" id="d3"></div>
      </div>
    </section>

    <!-- Resumen -->
    <section class="panel">
      <h3 style="text-align:center;margin:0 0 10px;font-size:16px">Resumen del día</h3>
      <div class="pills" id="pillsWrap">
        <div class="pill" id="pillCargadas" style="--fill:0%">
          <div class="pill-inner">
            <span class="label">Plataformas cargadas</span>
            <span class="val" id="cargadasCount">0</span>
          </div>
        </div>
        <div class="pill" id="pillVacias" style="--fill:0%">
          <div class="pill-inner">
            <span class="label">Plataformas vacías</span>
            <span class="val" id="vaciasCount">0</span>
          </div>
        </div>
        <div class="pill" id="pillAveriadas" style="--fill:0%">
          <div class="pill-inner">
            <span class="label">Averiadas</span>
            <span class="val" id="averiadasCount">0</span>
          </div>
        </div>
        <div class="pill" id="pillTotal" style="--fill:0%">
          <div class="pill-inner">
            <span class="label">Total</span>
            <span class="val" id="totalCount">0</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Registros compactos con menú fijo -->
    <section class="compact" id="compactPanel">
      <div class="compact-header">
        <div class="segment" role="tablist" aria-label="Filtrar registros">
          <button class="active" data-tab="TODAS" role="tab" aria-selected="true">Todas <span class="badge" id="bAll">0</span></button>
          <button data-tab="CARGADA" role="tab">Cargadas <span class="badge" id="bCargadas">0</span></button>
          <button data-tab="VACÍA" role="tab">Vacías <span class="badge" id="bVacias">0</span></button>
          <button data-tab="AVERIADA" role="tab">Averiadas <span class="badge" id="bAveriadas">0</span></button>
        </div>
      </div>
      <div class="compact-body" id="recordsContainer">
        <!-- registros renderizados aquí -->
      </div>
    </section>

    <!-- Acciones -->
    <section class="panel actions" style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
      <button class="btn btn-primary" id="genPdf">Generar PDF</button>
      <button class="btn btn-secondary" id="clearAll">Limpiar registros</button>
    </section>
  </div>

<!-- Modal de edición -->
<div class="modal" id="editModal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="modal-title" id="editTitle">Editar registro</div>
    <div class="modal-row">
      <input id="editMatricula" class="input" placeholder="Matrícula" />
      <select id="editEstado">
        <option value="CARGADA">CARGADA</option>
        <option value="VACÍA">VACÍA</option>
        <option value="AVERIADA">AVERIADA</option>
      </select>
    </div>
    <textarea id="editContenido" class="textarea" placeholder="Contenido / problema"></textarea>
    <div class="modal-actions">
      <button class="btn btn-secondary" id="editCancel">Cancelar</button>
      <button class="btn btn-primary" id="editSave">Guardar</button>
    </div>
  </div>
</div>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ===== Utils/State ===== */
const $ = (id)=>document.getElementById(id);
const fmtHour = () => new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
let plataformas = []; let currentMatricula = ''; let currentEstado = '';
let currentTab = 'TODAS';
let editingId = null;

const STORAGE_KEY = 'plataformas-global';
function loadData(){ try{ const raw=localStorage.getItem(STORAGE_KEY); plataformas=raw?JSON.parse(raw):[] }catch(e){ plataformas=[] } }
function saveData(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(plataformas)); }catch(e){} }

/* ===== Mantener tarjeta a la vista ===== */
function keepCardInView(){
  const card = $('flowCard'); if(!card) return;
  const rect = card.getBoundingClientRect();
  if(rect.top < 12 || rect.bottom > (window.innerHeight - 12)){
    card.scrollIntoView({behavior:'smooth', block:'start'});
  }
}

/* ===== Efecto pulsado en botones ===== */
function attachPressedEffect(el){
  el.addEventListener('pointerdown', (ev)=>{
    const r = el.getBoundingClientRect();
    const x = ev.clientX - r.left, y = ev.clientY - r.top;
    el.style.setProperty('--px', x+'px'); el.style.setProperty('--py', y+'px');
    el.classList.add('pressed');
  });
  ['pointerup','pointerleave','pointercancel'].forEach(evt=>{
    el.addEventListener(evt, ()=>setTimeout(()=>el.classList.remove('pressed'), 220));
  });
}

/* ===== Flow ===== */
let step = 1;
function showStep(next, dir='forward'){
  const cur = $('s'+step), nxt = $('s'+next); if(!nxt || cur===nxt) return;
  cur.classList.remove('active'); cur.classList.add(dir==='forward' ? 'out-left':'out-right');
  setTimeout(()=>{ cur.classList.remove('out-left','out-right') }, 360);
  nxt.classList.add('active');
  $('d1').classList.toggle('active', next===1); $('d2').classList.toggle('active', next===2); $('d3').classList.toggle('active', next===3);
  $('flowTitle').textContent = next===1 ? 'Matrícula' : next===2 ? 'Estado' : 'Contenido';
  step = next; requestAnimationFrame(()=>{ nxt.focus({preventScroll:true}); keepCardInView(); });
}
function nextFromS1(){
  const m = $('matriculaInput').value.trim().toUpperCase();
  if(!m){ alert('Por favor, introduce una matrícula válida'); haptics(40); keepCardInView(); return; }
  currentMatricula = m; $('matriculaDisplay').textContent = m; $('matriculaDisplay2').textContent = m;
  showStep(2,'forward'); haptics(10);
}
function chooseEstado(estado){
  currentEstado = estado; $('estadoDisplay').textContent = estado;
  if(estado==='VACÍA'){
    if(!currentMatricula){ alert('Introduce primero una matrícula válida'); showStep(1,'back'); return; }
    const dup = plataformas.some(p => p.matricula===currentMatricula && p.estado==='VACÍA');
    if(dup){ alert('Esta matrícula ya fue registrada como VACÍA.'); resetFlow(); return; }
    plataformas.push({ id:Date.now(), matricula:currentMatricula, estado, contenido:'', timestamp:fmtHour() });
    saveData(); updateAll(); resetFlow(); haptics(5); keepCardInView();
  }else{
    showStep(3,'forward'); haptics(8);
  }
}
function registrar(){
  const contenido = $('contenidoInput').value.trim();
  if(!contenido){ alert('Describe el contenido o el problema'); haptics(40); keepCardInView(); return; }
  plataformas.push({ id:Date.now(), matricula:currentMatricula, estado:currentEstado, contenido, timestamp:fmtHour() });
  saveData(); updateAll();
  const btn=$('btnRegistrar'); const prev=btn.textContent;
  btn.disabled=true; btn.textContent='Registrando…';
  setTimeout(()=>{ btn.textContent='Registrado ✓'; haptics(5);
    setTimeout(()=>{ btn.disabled=false; btn.textContent=prev; resetFlow(); keepCardInView(); }, 700);
  }, 380);
}
function resetFlow(){ $('matriculaInput').value=''; $('contenidoInput').value=''; currentMatricula=''; currentEstado=''; showStep(1,'back'); }

/* ===== Update UI + Pills + Compact List ===== */
function updateAll(){
  const cargadas = plataformas.filter(p=>p.estado==='CARGADA');
  const vacias   = plataformas.filter(p=>p.estado==='VACÍA');
  const averiadas= plataformas.filter(p=>p.estado==='AVERIADA');
  const total = plataformas.length || 1;

  $('cargadasCount').textContent=cargadas.length;
  $('vaciasCount').textContent=vacias.length;
  $('averiadasCount').textContent=averiadas.length;
  $('totalCount').textContent=plataformas.length;

  setFill('pillCargadas', cargadas.length/total*100);
  setFill('pillVacias',   vacias.length/total*100);
  setFill('pillAveriadas',averiadas.length/total*100);
  setFill('pillTotal',    100);

  // Badges del segmento
  $('bAll').textContent = plataformas.length;
  $('bCargadas').textContent = cargadas.length;
  $('bVacias').textContent = vacias.length;
  $('bAveriadas').textContent = averiadas.length;

  renderCompactList();
}
function setFill(pillId, pct){ const el = $(pillId); if(!el) return; requestAnimationFrame(()=>{ el.style.setProperty('--fill', Math.max(0, Math.min(100, pct)).toFixed(0) + '%'); }); }

function renderCompactList(){
  const box = $('recordsContainer');
  const data = currentTab==='TODAS' ? plataformas : plataformas.filter(p=>p.estado===currentTab);
  if(!data.length){ box.innerHTML = '<div class="empty">No hay registros</div>'; return; }
  const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#039;'};
  const esc = (s)=>String(s).replace(/[&<>"']/g, m=>map[m]);
  box.innerHTML = data.map(it=>(
    `<div class="record" data-id="${it.id}">
       <div class="meta">
         <div class="item">Matrícula: <strong>${esc(it.matricula)}</strong></div>
         <div class="item"> — Estado: <strong>${esc(it.estado)}</strong></div>
         <div class="item"> — ${esc(it.timestamp)}</div>
         ${it.contenido?`<div class="item" style="display:block;color:#2B2F34;margin-top:6px;white-space:pre-wrap">${esc(it.contenido)}</div>`:''}
       </div>
       <div class="actions">
         <button class="action-btn" data-action="edit">Editar</button>
         <button class="action-btn" data-action="delete">Eliminar</button>
       </div>
     </div>`
  )).join('');
}

/* ===== Edit/Delete ===== */
function openEditModal(id){
  const it = plataformas.find(p=>p.id===id); if(!it) return;
  editingId = id;
  $('editMatricula').value = it.matricula;
  $('editEstado').value = it.estado;
  $('editContenido').value = it.contenido || '';
  $('editModal').classList.add('open'); $('editModal').setAttribute('aria-hidden','false');
}
function closeEditModal(){
  $('editModal').classList.remove('open'); $('editModal').setAttribute('aria-hidden','true');
  editingId = null;
}
function saveEdit(){
  if(editingId==null) return;
  const idx = plataformas.findIndex(p=>p.id===editingId);
  if(idx<0) return;
  const m = $('editMatricula').value.trim().toUpperCase();
  const e = $('editEstado').value;
  const c = $('editContenido').value.trim();
  if(!m){ alert('La matrícula no puede estar vacía'); return; }
  plataformas[idx].matricula = m;
  plataformas[idx].estado = e;
  plataformas[idx].contenido = c;
  saveData(); updateAll(); closeEditModal();
}
function deleteRecord(id){
  const it = plataformas.find(p=>p.id===id);
  if(!it) return;
  if(!confirm(`¿Eliminar el registro de ${it.matricula}?`)) return;
  plataformas = plataformas.filter(p=>p.id!==id);
  saveData(); updateAll();
}

/* ===== PDF (igual que versión anterior, con badges fijos, 3 en línea) ===== */
function generatePDF(){
  const { jsPDF } = window.jspdf || {};
  if(!jsPDF){ alert('No se pudo cargar jsPDF. Revisa tu conexión.'); return; }
  const doc = new jsPDF({ unit: 'mm', format: 'a4' });
  const TEXT=[17,20,24], MUTED=[106,111,117], LINE=[230,230,234], PANEL=[255,255,255], SOFT=[245,246,247];
  const BADGE_RED=[254,226,226], BADGE_GREEN=[237,249,237], BADGE_ORNG=[255,245,230];

  const cargadas = plataformas.filter(p => p.estado === 'CARGADA');
  const vacias = plataformas.filter(p => p.estado === 'VACÍA');
  const averiadas = plataformas.filter(p => p.estado === 'AVERIADA');

  // Cabecera
  doc.setFillColor(...PANEL); doc.roundedRect(10,8,190,36,5,5,'F');
  doc.setDrawColor(...LINE); doc.roundedRect(10,8,190,36,5,5); doc.setDrawColor(210,210,214); doc.line(10,44,200,44);
  doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.setTextColor(40,40,40); doc.text('CODE', 195, 14, { align: 'right' });
  doc.setFont('helvetica','bold'); doc.setFontSize(18);
  const full = 'XPO LOGISTICS'; const xpoPart = 'XPO '; const startX = 105 - (doc.getTextWidth(full) / 2);
  doc.setTextColor(239,68,68); doc.text(xpoPart, startX, 22);
  const nextX = startX + doc.getTextWidth(xpoPart);
  doc.setTextColor(...TEXT); doc.text('LOGISTICS', nextX, 22);

  function drawBadge(x,y,w,h,bg,label,num,numColor){
    doc.setFillColor(...bg); doc.roundedRect(x,y,w,h, h/2, h/2, 'F');
    doc.setDrawColor(...LINE); doc.roundedRect(x,y,w,h, h/2, h/2);
    doc.setFont('helvetica','bold'); doc.setFontSize(8.5); doc.setTextColor(...TEXT);
    doc.text(label, x+7, y+h/2+2, { align:'left' });
    doc.setTextColor(...numColor); doc.text(String(num), x+w-7, y+h/2+2, { align:'right' });
  }
  const usable = 180, gap = 8, w = (usable - gap*2)/3, h = 10, y = 32; let x = 15;
  drawBadge(x,y,w,h,BADGE_RED,'CARGADAS',cargadas.length,[180,30,50]); x+=w+gap;
  drawBadge(x,y,w,h,BADGE_GREEN,'VACÍAS',vacias.length,[16,185,129]); x+=w+gap;
  drawBadge(x,y,w,h,BADGE_ORNG,'AVERIADAS',averiadas.length,[200,110,20]);

  // Tablas
  let yPosition = 52; const bottomMargin = 260;
  function createTwoColumnTables(leftTitle,leftData,rightTitle,rightData,startY){
      let currentY=startY; const leftX=15; const rightX=110; const columnWidth=85;
      doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.setTextColor(...TEXT);
      if(leftData.length>0) doc.text((leftTitle+' ('+leftData.length+')').toUpperCase(),leftX,currentY);
      if(rightData.length>0) doc.text((rightTitle+' ('+rightData.length+')').toUpperCase(),rightX,currentY);
      currentY+=8;
      if(leftData.length>0){
          doc.setFillColor(...SOFT); doc.rect(leftX,currentY-4,columnWidth,7,'F');
          doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(...MUTED);
          doc.text('MATRÍCULA',leftX+2,currentY); doc.text('CONTENIDO',leftX+35,currentY);
      }
      if(rightData.length>0){
          doc.setFillColor(...SOFT); doc.rect(rightX,currentY-4,columnWidth,7,'F');
          doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(...MUTED);
          doc.text('MATRÍCULA',rightX+2,currentY);
      }
      currentY+=8; doc.setFont('helvetica','normal'); doc.setFontSize(8); doc.setTextColor(...TEXT);
      const maxRows=Math.max(leftData.length,rightData.length);
      for(let i=0;i<maxRows;i++){
          if(i%2===0){
              if(leftData[i]){doc.setFillColor(252,253,255);doc.rect(leftX,currentY-3,columnWidth,6,'F');}
              if(rightData[i]){doc.setFillColor(252,253,255);doc.rect(rightX,currentY-3,columnWidth,6,'F');}
          }
          if(leftData[i]){
              doc.text(leftData[i].matricula.toUpperCase(),leftX+2,currentY);
              if(leftData[i].contenido){
                  const lines=doc.splitTextToSize(leftData[i].contenido.toUpperCase(),45);
                  doc.text(lines,leftX+35,currentY);
                  if(lines.length>1) currentY+=(lines.length-1)*3;
              }
          }
          if(rightData[i]){ doc.text(rightData[i].matricula.toUpperCase(),rightX+2,currentY); }
          currentY+=6;
          if(currentY>bottomMargin){ doc.addPage(); currentY=30; }
      }
      return currentY+10;
  }
  function createSingleTable(title,data,startY){
      let currentY=startY; if(data.length===0) return currentY;
      doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.setTextColor(...TEXT); doc.text((title+' ('+data.length+')').toUpperCase(),15,currentY); currentY+=8;
      doc.setFillColor(...SOFT); doc.rect(15,currentY-4,180,7,'F');
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(...MUTED); doc.text('MATRÍCULA',17,currentY); doc.text('DESCRIPCIÓN',70,currentY); currentY+=8;
      doc.setFont('helvetica','normal'); doc.setFontSize(8); doc.setTextColor(...TEXT);
      data.forEach((platform,index)=>{
          if(index%2===0){doc.setFillColor(252,253,255);doc.rect(15,currentY-3,180,6,'F');}
          doc.text(platform.matricula.toUpperCase(),17,currentY);
          if(platform.contenido){
              const lines=doc.splitTextToSize(platform.contenido.toUpperCase(),120);
              doc.text(lines,70,currentY);
              if(lines.length>1) currentY+=(lines.length-1)*3;
          }
          currentY+=6;
          if(currentY>bottomMargin){ doc.addPage(); currentY=30; }
      });
      return currentY+10;
  }
  if(cargadas.length>0||vacias.length>0){ yPosition=createTwoColumnTables('PLATAFORMAS CARGADAS',cargadas,'PLATAFORMAS VACÍAS',vacias,yPosition); }
  if(averiadas.length>0){ yPosition=createSingleTable('PLATAFORMAS AVERIADAS',averiadas,yPosition); }
  const pageCount=doc.internal.getNumberOfPages();
  for(let i=1;i<=pageCount;i++){
      doc.setPage(i); doc.setFont('helvetica','normal'); doc.setFontSize(8); doc.setTextColor(100,100,110);
      doc.text('© 2025 XPO LOGISTICS – Informe interno',20,285);
      doc.setTextColor(60,90,180);
      doc.textWithLink('https://vbenyx.github.io/XPO-LOGISTICS/', 105, 285, { url: 'https://vbenyx.github.io/XPO-LOGISTICS/', align: 'center' });
      doc.setTextColor(100,100,110); doc.text('Página '+i+' de '+pageCount,190,285,{align:'right'});
  }
  const exportDateForName = new Date().toLocaleDateString('es-ES', { day:'2-digit', month:'2-digit', year:'numeric' }).replace(/\//g,'-');
  doc.save('reporte_plataformas_'+exportDateForName+'.pdf');
}

/* ===== Gestos/Accesos mínimos ===== */
function haptics(ms=8){ if(navigator.vibrate) try{ navigator.vibrate(ms); }catch(_){} }

/* ===== Init ===== */
window.addEventListener('DOMContentLoaded', () => {
  // Flow
  $('toS2').addEventListener('click', nextFromS1);
  $('back1').addEventListener('click', ()=>{ showStep(1,'back'); keepCardInView(); });
  $('back2').addEventListener('click', ()=>{ showStep(2,'back'); keepCardInView(); });
  $('btnCargada').addEventListener('click', ()=>chooseEstado('CARGADA'));
  $('btnVacia').addEventListener('click',   ()=>chooseEstado('VACÍA'));
  $('btnAveriada').addEventListener('click',()=>chooseEstado('AVERIADA'));
  $('btnRegistrar').addEventListener('click', registrar);
  $('genPdf').addEventListener('click', ()=>{ keepCardInView(); generatePDF(); });
  $('clearAll').addEventListener('click', ()=>{
    if(!plataformas.length){ alert('No hay registros para limpiar'); keepCardInView(); return; }
    if(confirm('¿Seguro que quieres eliminar todos los registros?')){ plataformas=[]; saveData(); updateAll(); resetFlow(); keepCardInView(); }
  });

  // Segmented filter
  document.querySelectorAll('.segment button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.segment button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      currentTab = btn.getAttribute('data-tab');
      renderCompactList();
    });
  });

  // Delegación de acciones Edit/Delete
  $('recordsContainer').addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-action]'); if(!btn) return;
    const rec = e.target.closest('.record'); const id = rec ? Number(rec.getAttribute('data-id')) : null;
    if(!id) return;
    const action = btn.getAttribute('data-action');
    if(action==='edit'){ openEditModal(id); }
    else if(action==='delete'){ deleteRecord(id); }
  });

  // Modal edición
  $('editCancel').addEventListener('click', closeEditModal);
  $('editSave').addEventListener('click', saveEdit);
  $('editModal').addEventListener('click', (e)=>{ if(e.target.id==='editModal') closeEditModal(); });

  // Efecto pulsado en todos los botones
  document.querySelectorAll('button').forEach(attachPressedEffect);

  // Datos
  loadData(); updateAll();
});
</script>
</body>
</html>