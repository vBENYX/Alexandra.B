<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MastApp - Debug Cámara</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #000;
            color: #fff;
            text-align: center;
            margin: 0;
            padding: 20px;
        }
        #container {
            position: relative;
            display: inline-block;
        }
        #video {
            width: 100%;
            max-width: 400px;
            border: 2px solid #fff;
            border-radius: 10px;
            display: none;
        }
        #overlayCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 10px;
            pointer-events: none;
        }
        #gallery { display: none; margin-top: 20px; }
        .photo { width: 200px; height: 150px; background: #333; margin: 10px; display: inline-block; border-radius: 5px; overflow: hidden; }
        #status { margin-top: 20px; font-size: 18px; }
        #orgasmCountdown { display: none; font-size: 48px; color: #ff0000; margin: 10px; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        #dirtyTalk { margin-top: 10px; font-size: 14px; color: #ffcc00; font-style: italic; }
        #progressBar { width: 200px; height: 20px; background: #333; border-radius: 10px; margin: 10px auto; overflow: hidden; display: none; }
        #progressFill { height: 100%; background: linear-gradient(to right, #ff0000, #ffcc00); width: 0%; transition: width 0.5s ease; }
        .particle { position: absolute; font-size: 20px; pointer-events: none; animation: floatUp 1s ease-out forwards; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-50px) scale(0.5); } }
        button { background: #ff0000; color: #fff; border: none; padding: 10px 20px; font-size: 16px; border-radius: 5px; cursor: pointer; margin: 10px; }
        button:hover { background: #cc0000; }
        audio { display: none; }
        #debugInfo { color: #ffcc00; font-size: 12px; margin-top: 10px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@nsfwjs/core@2.4.2/dist/index.min.js"></script>
</head>
<body>
    <h1>MastApp: Debug Cámara Mejorado</h1>
    <p>Si no jala, checa console (F12) y permisos.</p>
    
    <div id="container">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="overlayCanvas"></canvas>
    </div>
    <br>
    <button id="startBtn">Iniciar Cámara</button>
    <div id="status">Estado: Esperando...</div>
    <div id="debugInfo"></div>
    <div id="orgasmCountdown"></div>
    <div id="progressBar"><div id="progressFill"></div></div>
    <div id="dirtyTalk"></div>
    
    <div id="gallery">
        <h2>Fotos Dinámicas</h2>
        <div id="photos"></div>
    </div>

    <!-- Audios (mismos) -->
    <audio id="moan1" preload="auto" loop><source src="moan1.mp3" type="audio/mpeg"></audio>
    <audio id="moan2" preload="auto" loop><source src="moan2.mp3" type="audio/mpeg"></audio>
    <audio id="moan3" preload="auto" loop><source src="moan3.mp3" type="audio/mpeg"></audio>
    <audio id="dirty1" preload="auto"><source src="dirty1.mp3" type="audio/mpeg"></audio>
    <audio id="dirty2" preload="auto"><source src="dirty2.mp3" type="audio/mpeg"></audio>
    <audio id="dirty3" preload="auto"><source src="dirty3.mp3" type="audio/mpeg"></audio>
    <audio id="dirty4" preload="auto"><source src="dirty4.mp3" type="audio/mpeg"></audio>
    <audio id="dirty5" preload="auto"><source src="dirty5.mp3" type="audio/mpeg"></audio>

    <script>
        let video = document.getElementById('video');
        let canvas = document.getElementById('overlayCanvas');
        let ctx = canvas.getContext('2d');
        let status = document.getElementById('status');
        let debugInfo = document.getElementById('debugInfo');
        let orgasmCountdown = document.getElementById('orgasmCountdown');
        let progressBar = document.getElementById('progressBar');
        let progressFill = document.getElementById('progressFill');
        let dirtyTalkDiv = document.getElementById('dirtyTalk');
        let gallery = document.getElementById('gallery');
        let photosDiv = document.getElementById('photos');
        let detector;
        let nsfwModel;
        let isNaked = false;
        let penisDetected = false;
        let masturbationSpeed = 0;
        let strokeCount = 0;
        let currentMoanAudio = null;
        let currentDirtyAudio = null;
        let speechSynth = window.speechSynthesis;
        let lastDirtyTime = 0;

        // Predictor vars (abreviados pa' espacio)
        let speedHistory = [];
        let orgasmMode = false;
        let countdownInterval;
        const ACCEL_THRESHOLD = 1.2;
        const HISTORY_SIZE = 10;
        const SAMPLE_INTERVAL = 1000;
        let lastSampleTime = 0;

        // Hand tracking
        let prevHandY = null;
        let handVelocity = 0;
        let direction = 0;
        let strokeThreshold = 20;

        // Bounding box
        let boxX, boxY, boxW, boxH;

        function createParticle(x, y) {
            const particle = document.createElement('div');
            particle.innerHTML = '❤️';
            particle.className = 'particle';
            particle.style.left = x + 'px';
            particle.style.top = y + 'px';
            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), 1000);
        }

        const climaxPhrases = ['¡Estás cerca, no pares!', '¡Ya viene el clímax, acelera!', '¡Siente cómo sube, papi!', '¡Uno más y explotas!'];
        const dirtyPhrases = { low: ['Eres tan sexy...', 'Me excito viéndote.'], medium: ['Me estoy tocando por ti.', 'Ven y hazme tuya.'], high: ['¡Fóllame ya!', 'Más fuerte, no pares.'] };

        const moanAudios = [document.getElementById('moan1'), document.getElementById('moan2'), document.getElementById('moan3')];
        const dirtyAudios = [document.getElementById('dirty1'), document.getElementById('dirty2'), document.getElementById('dirty3'), document.getElementById('dirty4'), document.getElementById('dirty5')].filter(audio => audio.src);

        function initAudio() {
            moanAudios.forEach(audio => { audio.volume = 0; audio.playbackRate = 0.8; });
            dirtyAudios.forEach(audio => { audio.volume = 0; audio.playbackRate = 0.8; });
        }

        function vibrateWithSpeed(speed) {
            if (!navigator.vibrate) return;
            const intensity = Math.floor(speed * 50);
            navigator.vibrate([100, intensity]);
        }

        function triggerOrgasmPredictor() {
            if (orgasmMode) return;
            orgasmMode = true;
            status.textContent += ' | ¡Clímax inminente!';
            let countdown = 10;
            orgasmCountdown.style.display = 'block';
            progressBar.style.display = 'block';
            countdownInterval = setInterval(() => {
                orgasmCountdown.textContent = countdown;
                progressFill.style.width = ((10 - countdown) / 10 * 100) + '%';
                if (countdown <= 5) {
                    if (currentMoanAudio) {
                        currentMoanAudio.volume = 1.0;
                        currentMoanAudio.playbackRate = 2.0;
                    }
                    navigator.vibrate(200);
                    sayDirtyTalk(10);
                }
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    orgasmCountdown.style.display = 'none';
                    progressBar.style.display = 'none';
                    progressFill.style.width = '0%';
                    orgasmMode = false;
                    speedHistory = [];
                    strokeCount = 0;
                    status.textContent = '¡Explosión! Reset pa\' próxima.';
                }
                countdown -= 1;
            }, 1000);
        }

        function sayDirtyTalk(speed) {
            const now = Date.now();
            if (now - lastDirtyTime < 5000 || (currentDirtyAudio && !currentDirtyAudio.ended)) return;
            lastDirtyTime = now;

            let phrases = orgasmMode ? climaxPhrases : (speed <= 3 ? dirtyPhrases.low : speed <= 7 ? dirtyPhrases.medium : dirtyPhrases.high);

            if (dirtyAudios.length > 0 && !currentDirtyAudio) {
                currentDirtyAudio = dirtyAudios[Math.floor(Math.random() * dirtyAudios.length)];
                const volume = 0.7 + (speed / 10) * 0.2;
                const rate = 0.9 + (speed / 10) * 0.3;
                currentDirtyAudio.volume = volume;
                currentDirtyAudio.playbackRate = rate;
                currentDirtyAudio.play().then(() => {
                    dirtyTalkDiv.textContent = '[Voz: Dirty Talk]';
                }).catch(err => {
                    console.log('Error voiced:', err);
                    fallbackTTS(phrases[Math.floor(Math.random() * phrases.length)], speed);
                });
                currentDirtyAudio.onended = () => { currentDirtyAudio = null; dirtyTalkDiv.textContent = ''; };
            } else {
                const phrase = phrases[Math.floor(Math.random() * phrases.length)];
                const utterance = new SpeechSynthesisUtterance(phrase);
                utterance.lang = 'es-ES';
                utterance.pitch = 1.2 + (speed / 10) * 0.5;
                utterance.rate = 0.9 + (speed / 10) * 0.3;
                utterance.volume = 0.7 + (speed / 10) * 0.2;
                utterance.onend = () => { dirtyTalkDiv.textContent = ''; };
                speechSynth.speak(utterance);
                dirtyTalkDiv.textContent = phrase;
            }
        }

        function fallbackTTS(phrase, speed) {
            const utterance = new SpeechSynthesisUtterance(phrase);
            utterance.lang = 'es-ES';
            utterance.pitch = 1.2 + (speed / 10) * 0.5;
            utterance.rate = 0.9 + (speed / 10) * 0.3;
            utterance.volume = 0.7 + (speed / 10) * 0.2;
            utterance.onend = () => { dirtyTalkDiv.textContent = ''; };
            speechSynth.speak(utterance);
            dirtyTalkDiv.textContent = phrase;
        }

        function playMoan(speed) {
            if (currentMoanAudio) {
                currentMoanAudio.pause();
                currentMoanAudio.currentTime = 0;
            }
            currentMoanAudio = moanAudios[Math.floor(Math.random() * moanAudios.length)];
            if (currentMoanAudio) {
                const volume = Math.min(0.8, (speed / 10) * 0.8);
                const rate = 0.8 + (speed / 10) * 1.2;
                currentMoanAudio.volume = volume;
                currentMoanAudio.playbackRate = rate;
                currentMoanAudio.play().catch(err => console.log('Error moan:', err));
            }
        }

        async function detectNudity(poses) {
            if (poses.length === 0) return false;
            const keypoints = poses[0].keypoints;
            const leftShoulder = keypoints.find(kp => kp.name === 'left_shoulder');
            const rightShoulder = keypoints.find(kp => kp.name === 'right_shoulder');
            const leftHip = keypoints.find(kp => kp.name === 'left_hip');
            const rightHip = keypoints.find(kp => kp.name === 'right_hip');
            if (leftShoulder?.score > 0.5 && rightShoulder?.score > 0.5 && leftHip?.score > 0.5 && rightHip?.score > 0.5) {
                const torsoLength = Math.abs(leftHip.y - leftShoulder.y);
                return torsoLength > 100;
            }
            return false;
        }

        async function detectPenis(poses, canvas) {
            if (!nsfwModel || poses.length === 0) return false;
            const keypoints = poses[0].keypoints;
            const leftHip = keypoints.find(kp => kp.name === 'left_hip');
            const rightHip = keypoints.find(kp => kp.name === 'right_hip');
            if (!leftHip || !rightHip || leftHip.score < 0.7 || rightHip.score < 0.7) return false;

            boxX = Math.min(leftHip.x, rightHip.x) - 50;
            boxY = Math.max(leftHip.y, rightHip.y) - 100;
            boxW = Math.abs(leftHip.x - rightHip.x) + 100;
            boxH = 150;

            const croppedCanvas = document.createElement('canvas');
            croppedCanvas.width = boxW;
            croppedCanvas.height = boxH;
            const cropCtx = croppedCanvas.getContext('2d');
            cropCtx.drawImage(canvas, boxX, boxY, boxW, boxH, 0, 0, boxW, boxH);

            const predictions = await nsfwModel.classify(croppedCanvas);
            const pornScore = predictions.find(p => p.className === 'Porn')?.probability || 0;
            return pornScore > 0.7;
        }

        let frameCount = 0;
        function detectSpeedAndStrokes(poses) {
            frameCount++;
            if (frameCount % 5 !== 0) return masturbationSpeed;
            if (poses.length === 0) {
                prevHandY = null;
                if (Date.now() - lastSampleTime > 5000) {
                    speedHistory = [];
                    orgasmMode = false;
                    if (countdownInterval) clearInterval(countdownInterval);
                    orgasmCountdown.style.display = 'none';
                    progressBar.style.display = 'none';
                    progressFill.style.width = '0%';
                }
                return 0;
            }
            const rightWrist = poses[0].keypoints.find(kp => kp.name === 'right_wrist');
            if (!rightWrist || right