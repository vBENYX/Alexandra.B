<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>XPO Logistics ‚Äì Registro de Plataformas</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    /* =======================
       APPLE / VISION PRO THEME
       ======================= */
    :root{
      --bg: #0b0c0f;
      --panel: 255 255 255;               /* panel base (RGB) */
      --ink: #0f172a;
      --ink-2:#334155;
      --brand:#2563eb;                    /* azul acento */
      --green:#10b981;
      --amber:#f59e0b;
      --red:#ef4444;

      --radius-xl: 20px;
      --radius-lg: 16px;
      --radius-md: 12px;
      --shadow-1: 0 10px 30px rgba(0,0,0,.12);
      --shadow-2: 0 20px 60px rgba(0,0,0,.22);
      --blur: blur(14px);
      --ring: 0 0 0 3px rgba(37,99,235,.16);
      --trans: 200ms cubic-bezier(.22,1,.36,1);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --panel: 24 26 31;
        --ink:#e5e7eb;
        --ink-2:#a1a1aa;
        --bg: #0a0b0d;
        --shadow-1: 0 12px 36px rgba(0,0,0,.5);
        --shadow-2: 0 24px 80px rgba(0,0,0,.6);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font: 500 16px/1.5 -apple-system, BlinkMacSystemFont,"SF Pro Text","Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(99,102,241,.14), transparent 50%),
        radial-gradient(1000px 600px at 110% 10%, rgba(37,99,235,.12), transparent 50%),
        #f4f6fb;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    @media (prefers-color-scheme: dark){
      body{
        background:
          radial-gradient(1200px 600px at 20% -10%, rgba(99,102,241,.18), transparent 50%),
          radial-gradient(1000px 600px at 110% 10%, rgba(37,99,235,.18), transparent 50%),
          var(--bg);
      }
    }

    .app{max-width:1100px;margin:0 auto;padding:18px}
    .panel{
      background: rgba(var(--panel)/.78);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      border: 1px solid rgba(255,255,255,.35);
      box-shadow: var(--shadow-1);
      border-radius: var(--radius-xl);
    }

    /* Header */
    .header{
      position: relative;
      padding: 28px 22px;
      display:grid;
      gap:8px;
      place-items:center;
      text-align:center;
      overflow:hidden;
      isolation:isolate;
    }
    .header::before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(600px 160px at 50% 0, rgba(255,255,255,.6), transparent 60%);
      pointer-events:none;
      mix-blend-mode:overlay;
    }
    .wordmark{
      font-weight:800; letter-spacing:2px; text-transform:uppercase;
      display:flex; gap:8px; align-items:center;
      font-size:1rem; opacity:.9;
    }
    .wordmark .xpo{color:var(--red)}
    .header h1{margin:4px 0 2px; font-size: clamp(1.4rem, 2.3vw, 2rem);}
    .header .date{opacity:.7; font-size:.95rem}

    /* Welcome overlay */
    .welcome{
      position: fixed; inset:0; display:grid; place-items:center; z-index:9999;
      background: rgba(var(--panel)/1);
      animation: welcomeOut .6s ease 2.4s forwards;
    }
    @keyframes welcomeOut{to{opacity:0; visibility:hidden}}
    .welcome-inner{
      text-align:center; padding:20px 24px;
    }
    .greeting{
      font-family: "SF Pro Display",-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      font-weight:800; letter-spacing:.5px;
      font-size: clamp(1.7rem, 4vw, 2.6rem);
      background: linear-gradient(90deg,#00C6FF,#3B82F6,#9333EA,#F43F5E,#FF8C00);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      background-size: 400% 400%;
      animation: hue 8s ease infinite;
      margin: 0 0 8px;
    }
    @keyframes hue{
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }

    /* Grid */
    .grid{display:grid; gap:22px; margin-top:22px}
    @media (min-width: 900px){
      .grid{grid-template-columns: 1.1fr .9fr}
    }

    /* Card / sections */
    section.panel{padding:22px}

    /* Stepper */
    .stepper{display:flex; gap:10px; justify-content:center; margin-bottom:18px}
    .dot{width:12px;height:12px;border-radius:50%; background:#0f172a22; transition: transform var(--trans), background var(--trans)}
    .dot.active{background:var(--brand); transform: scale(1.35); box-shadow:0 0 10px rgba(37,99,235,.5)}

    .form{display:grid; gap:16px; max-width:560px; margin:0 auto}
    .input,.textarea{
      width:100%;
      border:1px solid rgba(0,0,0,.08);
      border-radius:14px;
      padding:14px 16px;
      background: rgba(255,255,255,.9);
      transition: box-shadow var(--trans), transform 120ms ease;
      outline:none;
    }
    .input:focus,.textarea:focus{box-shadow:var(--ring)}
    .textarea{min-height:96px; resize:vertical}

    .btn{
      appearance:none; border:0; border-radius:14px; padding:13px 18px;
      font-weight:700; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      transition: transform 120ms ease, filter var(--trans), box-shadow var(--trans), background var(--trans);
      box-shadow: 0 6px 20px rgba(0,0,0,.08);
      user-select:none;
    }
    .btn:active{transform: scale(.98)}
    .btn.primary{background:var(--brand); color:white}
    .btn.secondary{background:#0f172a; color:white}
    .btn.ok{background:var(--green); color:white}
    .btn.warn{background:var(--amber); color:white}
    .btn.danger{background:var(--red); color:white}
    .btn.ghost{background:rgba(0,0,0,.06)}
    .btn:disabled{opacity:.6; pointer-events:none}

    .row{display:flex; gap:12px; flex-wrap:wrap}
    .row>.btn{flex:1}

    /* Summary */
    .summary-grid{display:grid; gap:14px; grid-template-columns: repeat(2,1fr)}
    @media (min-width:700px){.summary-grid{grid-template-columns: repeat(4,1fr)}}
    .stat{
      background: rgba(var(--panel)/.85);
      border:1px solid rgba(255,255,255,.4);
      border-radius:16px; padding:16px; text-align:center;
      box-shadow: var(--shadow-1);
    }
    .stat .num{font-weight:800; font-size:clamp(1.4rem,3vw,2rem); color:var(--brand)}
    .stat .label{opacity:.7; font-weight:600}

    /* Lists */
    .lists{display:grid; gap:16px}
    @media (min-width:900px){.lists{grid-template-columns: repeat(3,1fr)}}
    .list h3{margin:0 0 10px; font-size:1.05rem}
    .cards{display:grid; gap:10px}
    .card{
      padding:14px 16px; border-radius:14px; box-shadow: var(--shadow-1);
      background: rgba(var(--panel)/.86);
      border:1px solid rgba(255,255,255,.4);
      transition: transform var(--trans), box-shadow var(--trans);
    }
    .card:hover{transform:translateY(-2px); box-shadow: var(--shadow-2)}
    .card .meta{display:flex; justify-content:space-between; gap:12px; font-weight:700}
    .card .content{margin-top:6px; opacity:.85}

    .empty{opacity:.6; font-style:italic; padding:10px 2px}

    /* Floating PDF button (compact) */
    .fab{
      position:fixed; right:16px; bottom:16px; z-index:50;
      background: linear-gradient(90deg, #2563eb, #3b82f6); color:white;
      border-radius:22px; height:42px; padding:0 14px; display:flex; align-items:center; gap:8px;
      box-shadow: 0 10px 28px rgba(37,99,235,.28), 0 2px 6px rgba(0,0,0,.08);
    }
    @media (max-width:600px){ .fab span{display:none}}

    /* Search bar above lists */
    .search{margin: 4px 0 18px}
    .search .input{background: rgba(255,255,255,.95)}

    /* Motion safety */
    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important}
    }
  </style>
</head>
<body>
  <!-- Welcome splash -->
  <div class="welcome panel" id="welcome">
    <div class="welcome-inner">
      <div class="greeting" id="greeting">Hola üëã</div>
      <div style="opacity:.7">Bienvenido al sistema de registro de plataformas</div>
    </div>
  </div>

  <div class="app">
    <header class="panel header" id="header">
      <div class="wordmark"><span class="xpo">XPO</span> <span>Logistics</span></div>
      <h1>Registro de Plataformas</h1>
      <div class="date" id="currentDate">‚Äî</div>
    </header>

    <div class="grid">
      <!-- Form wizard -->
      <section class="panel">
        <div class="stepper">
          <div class="dot active" id="dot1"></div>
          <div class="dot" id="dot2"></div>
          <div class="dot" id="dot3"></div>
        </div>

        <!-- Paso 1 -->
        <div class="form" id="step1">
          <h2>Paso 1: Matr√≠cula de la Plataforma</h2>
          <input id="matriculaInput" class="input" placeholder="Introduce la matr√≠cula" autocomplete="off" />
          <button class="btn primary" id="btnContinuar">Continuar</button>
        </div>

        <!-- Paso 2 -->
        <div class="form" id="step2" hidden>
          <h2>Paso 2: Estado de la Plataforma</h2>
          <div class="panel" style="padding:12px; border-radius:14px">
            Matr√≠cula: <strong id="matriculaDisplay">‚Äî</strong>
          </div>
          <div class="row">
            <button class="btn danger"   data-estado="CARGADA">CARGADA</button>
            <button class="btn ok"       data-estado="VAC√çA">VAC√çA</button>
            <button class="btn warn"     data-estado="AVERIADA">üõ† AVERIADA</button>
          </div>
          <button class="btn secondary" id="btnVolver1">Volver</button>
        </div>

        <!-- Paso 3 -->
        <div class="form" id="step3" hidden>
          <h2>Paso 3: Contenido de la Plataforma</h2>
          <div class="panel" style="padding:12px; border-radius:14px">
            Matr√≠cula: <strong id="matriculaDisplay2">‚Äî</strong> ¬∑ Estado: <strong id="estadoDisplay">‚Äî</strong>
          </div>
          <textarea id="contenidoInput" class="textarea" placeholder="Describe qu√© contiene la plataforma o el problema‚Ä¶"></textarea>
          <div class="row">
            <button class="btn primary" id="btnRegistrar">Registrar</button>
            <button class="btn secondary" id="btnVolver2">Volver</button>
          </div>
        </div>
      </section>

      <!-- Summary -->
      <section class="panel">
        <h2 style="margin-top:0">Resumen del d√≠a</h2>
        <div class="summary-grid">
          <div class="stat"><div class="num" id="cargadasCount">0</div><div class="label">Plataformas cargadas</div></div>
          <div class="stat"><div class="num" id="vaciasCount">0</div><div class="label">Plataformas vac√≠as</div></div>
          <div class="stat"><div class="num" id="averiadasCount">0</div><div class="label">üõ† Averiadas</div></div>
          <div class="stat"><div class="num" id="totalCount">0</div><div class="label">Total</div></div>
        </div>
        <div class="row" style="margin-top:16px">
          <button class="btn ghost" id="btnLimpiar">üóë Limpiar registros</button>
        </div>
      </section>
    </div>

    <!-- Lists + search -->
    <section class="panel" style="margin-top:22px">
      <div class="search">
        <input id="searchInput" class="input" placeholder="üîç Buscar matr√≠cula en todas las listas‚Ä¶" />
      </div>
      <div class="lists">
        <div>
          <h3>Plataformas cargadas (<span id="cargadasListCount">0</span>)</h3>
          <div class="cards" id="cargadasList"><div class="empty">No hay plataformas cargadas registradas</div></div>
        </div>
        <div>
          <h3>Plataformas vac√≠as (<span id="vaciasListCount">0</span>)</h3>
          <div class="cards" id="vaciasList"><div class="empty">No hay plataformas vac√≠as registradas</div></div>
        </div>
        <div>
          <h3>üõ† Plataformas averiadas (<span id="averiadasListCount">0</span>)</h3>
          <div class="cards" id="averiadasList"><div class="empty">No hay plataformas averiadas registradas</div></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Floating PDF -->
  <button class="fab btn primary" id="btnPDF" title="Generar PDF">
    <svg viewBox="0 0 16 16" width="18" height="18" fill="currentColor" aria-hidden="true"><path d="M4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V6.5L9.5 0H4zm5 1.5L13.5 6H10a1 1 0 0 1-1-1V1.5zM4 15a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h4v4a2 2 0 0 0 2 2h4v7a1 1 0 0 1-1 1H4z"/></svg>
    <span>PDF</span>
  </button>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-/F2bM8Xk0l3cYcH2o1nqQmC3hX5c3x7a9i2n3rVqN3pJvFQ2H2mZ3mH1x0g1q2d5VQ8yQm1y+o0mQK3s2a2c1Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
  // ============== STATE ==============
  const $ = (s,scope=document)=>scope.querySelector(s);
  const $$ = (s,scope=document)=>[...scope.querySelectorAll(s)];

  let plataformas = [];
  let currentStep = 1;
  let currentMatricula = '';
  let currentEstado = '';

  const els = {
    greeting: $('#greeting'),
    welcome: $('#welcome'),
    currentDate: $('#currentDate'),
    dots: [$('#dot1'), $('#dot2'), $('#dot3')],
    step1: $('#step1'),
    step2: $('#step2'),
    step3: $('#step3'),
    matriculaInput: $('#matriculaInput'),
    matriculaDisplay: $('#matriculaDisplay'),
    matriculaDisplay2: $('#matriculaDisplay2'),
    estadoDisplay: $('#estadoDisplay'),
    contenidoInput: $('#contenidoInput'),
    counters: {
      cargadas: $('#cargadasCount'),
      vacias:   $('#vaciasCount'),
      averiadas:$('#averiadasCount'),
      total:    $('#totalCount')
    },
    lists: {
      cargadas: $('#cargadasList'),
      vacias:   $('#vaciasList'),
      averiadas:$('#averiadasList')
    },
    listCounts: {
      cargadas: $('#cargadasListCount'),
      vacias:   $('#vaciasListCount'),
      averiadas:$('#averiadasListCount')
    },
    search: $('#searchInput')
  };

  // ============== UTIL ==============
  const key = 'plataformas-global';
  const load = () => { try{ plataformas = JSON.parse(localStorage.getItem(key)) || [] }catch{ plataformas=[] } };
  const save = () => { try{ localStorage.setItem(key, JSON.stringify(plataformas)) }catch{} };

  const setStep = (n)=>{
    currentStep = n;
    [els.step1,els.step2,els.step3].forEach((el,i)=>{ el.hidden = (i+1)!==n; });
    els.dots.forEach((d,i)=>d.classList.toggle('active', i+1===n));
  };

  const vibrate = (ms=40)=>{ if(navigator.vibrate) navigator.vibrate(ms) };

  // Counters (simple bump animation)
  function setCount(el, val){
    if(el.textContent == val) return;
    el.textContent = val;
  }

  // Render helpers
  const listItem = (p)=>`
    <div class="card">
      <div class="meta">
        <span class="m">${p.matricula.toUpperCase()}</span>
        <span class="t" style="opacity:.7">${p.timestamp}</span>
      </div>
      ${p.contenido ? `<div class="content">${p.contenido}</div>` : ``}
    </div>`;

  function render(){
    const cargadas  = plataformas.filter(p=>p.estado==='CARGADA');
    const vacias    = plataformas.filter(p=>p.estado==='VAC√çA');
    const averiadas = plataformas.filter(p=>p.estado==='AVERIADA');

    setCount(els.counters.cargadas, cargadas.length);
    setCount(els.counters.vacias,   vacias.length);
    setCount(els.counters.averiadas,averiadas.length);
    setCount(els.counters.total,    plataformas.length);

    els.listCounts.cargadas.textContent = cargadas.length;
    els.listCounts.vacias.textContent   = vacias.length;
    els.listCounts.averiadas.textContent= averiadas.length;

    const fill = (container, arr, empty) =>{
      container.innerHTML = arr.length ? arr.map(listItem).join('') : `<div class="empty">${empty}</div>`;
    };
    fill(els.lists.cargadas,  cargadas,  'No hay plataformas cargadas registradas');
    fill(els.lists.vacias,    vacias,    'No hay plataformas vac√≠as registradas');
    fill(els.lists.averiadas, averiadas, 'No hay plataformas averiadas registradas');

    // Aplicar filtro de b√∫squeda actual si hay texto
    if(els.search.value.trim()) applySearch();
  }

  function applySearch(){
    const q = els.search.value.trim().toLowerCase();
    $$('.cards .card').forEach(card=>{
      const m = $('.m', card)?.textContent.toLowerCase() || '';
      card.style.display = m.includes(q) ? '' : 'none';
    });
  }

  // ============== PDF ==============
  function generatePDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'mm', format:'a4' });

    const today = new Date();
    const fecha = today.toLocaleDateString('es-ES', {weekday:'long', year:'numeric', month:'long', day:'numeric'}).toUpperCase();

    const cargadas  = plataformas.filter(p=>p.estado==='CARGADA');
    const vacias    = plataformas.filter(p=>p.estado==='VAC√çA');
    const averiadas = plataformas.filter(p=>p.estado==='AVERIADA');

    // Header
    doc.setFillColor(255,255,255); doc.roundedRect(10,8,190,28,4,4,'F');
    doc.setFont('helvetica','bold'); doc.setFontSize(18);
    doc.setTextColor(239,68,68); doc.text('XPO ', 15, 22);
    doc.setTextColor(0,0,0); doc.text('LOGISTICS', 32, 22);
    doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.setTextColor(120,120,130);
    doc.text(fecha, 200-10, 22, {align:'right'});

    // Summary badges
    doc.setFont('helvetica','bold'); doc.setFontSize(10);
    const badges = [
      {label:'CARGADAS', n:cargadas.length, c:[180,30,50]},
      {label:'VAC√çAS',   n:vacias.length,   c:[16,185,129]},
      {label:'AVERIADAS',n:averiadas.length,c:[200,110,20]},
    ];
    let x = 15, y= 40;
    badges.forEach(b=>{
      doc.setDrawColor(230,230,230); doc.roundedRect(x,y,58,10,2,2);
      doc.setTextColor(...b.c); doc.text(String(b.n), x+10, y+7);
      doc.setTextColor(60,60,70); doc.text(b.label, x+33, y+7, {align:'center'});
      x += 62;
    });

    // Tables
    let yy = 58;
    const line = (text, xx, yy)=>{ doc.text(text, xx, yy); };

    // Cargadas + Vac√≠as (2 cols)
    const left = {title:`PLATAFORMAS CARGADAS (${cargadas.length})`, data:cargadas};
    const right= {title:`PLATAFORMAS VAC√çAS (${vacias.length})`, data:vacias};

    doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.setTextColor(0,0,0);
    if(left.data.length){ doc.text(left.title, 15, yy); }
    if(right.data.length){ doc.text(right.title, 110, yy); }
    yy += 6;

    doc.setFont('helvetica','bold'); doc.setFontSize(9);
    if(left.data.length){ line('MATR√çCULA',15,yy); line('CONTENIDO',45,yy); }
    if(right.data.length){ line('MATR√çCULA',110,yy); }
    yy += 6;

    doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.setTextColor(20,20,20);
    const maxRows = Math.max(left.data.length, right.data.length);
    for(let i=0;i<maxRows;i++){
      if(left.data[i]){
        line(left.data[i].matricula.toUpperCase(),15,yy);
        const lines = doc.splitTextToSize(left.data[i].contenido||'', 50);
        doc.text(lines,45,yy);
      }
      if(right.data[i]){
        line(right.data[i].matricula.toUpperCase(),110,yy);
      }
      yy += 6;
      if(yy>260){ doc.addPage(); yy=20; }
    }
    yy += 6;

    if(averiadas.length){
      doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.setTextColor(0,0,0);
      doc.text(`PLATAFORMAS AVERIADAS (${averiadas.length})`, 15, yy); yy+=6;
      doc.setFont('helvetica','bold'); doc.setFontSize(9); line('MATR√çCULA',15,yy); line('DESCRIPCI√ìN',60,yy); yy+=6;
      doc.setFont('helvetica','normal'); doc.setFontSize(9);
      averiadas.forEach(p=>{
        line(p.matricula.toUpperCase(),15,yy);
        const lines = doc.splitTextToSize(p.contenido||'', 120);
        doc.text(lines,60,yy); yy += 6;
        if(yy>260){ doc.addPage(); yy=20; }
      });
    }

    const nameDate = today.toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'numeric'}).replace(/\//g,'-');
    doc.save(`reporte_plataformas_${nameDate}.pdf`);
  }

  // ============== ALERTS + SHORTCUTS ==============
  function notify(message, type='info'){
    const n = document.createElement('div');
    n.textContent = message;
    n.style.cssText = `
      position:fixed; top:18px; right:18px; z-index:10000;
      background:rgba(255,255,255,.95); border:1px solid rgba(0,0,0,.08);
      padding:12px 14px; border-radius:12px; box-shadow: var(--shadow-1);
      font-weight:600; color:#111827;
    `;
    if(type==='success') n.style.borderLeft = '4px solid var(--green)';
    if(type==='warning') n.style.borderLeft = '4px solid var(--amber)';
    if(type==='error')   n.style.borderLeft = '4px solid var(--red)';
    document.body.appendChild(n);
    setTimeout(()=>{ n.style.opacity='0'; n.style.transform='translateX(10px)'; setTimeout(()=>n.remove(),250)}, 2200);
  }

  function checkCustomAlerts(newPlat){
    const SPECIAL = ['URGENTE','PRIORITARIO','EMERGENCIA','SPECIAL','CRITICO'];
    const contentAlerts = [
      {p:'INCENDIO',   type:'error',   msg:'üö® ALERTA: Contenido peligroso detectado'},
      {p:'QU√çMIC',     type:'error',   msg:'‚ö†Ô∏è Material qu√≠mico detectado'},
      {p:'MEDICAMENTO',type:'warning', msg:'üíä Medicamentos especiales'},
      {p:'FR√ÅGIL',     type:'info',    msg:'üéØ Mercanc√≠a fr√°gil registrada'}
    ];
    const MU = newPlat.matricula.toUpperCase();
    const CU = (newPlat.contenido||'').toUpperCase();

    SPECIAL.forEach(s => { if(MU.includes(s)) notify(`üö® MATR√çCULA ESPECIAL: ${s}`, 'error') });
    contentAlerts.forEach(a => { if(CU.includes(a.p)) notify(a.msg, a.type) });

    const averiadasCount = plataformas.filter(p=>p.estado==='AVERIADA').length;
    if(newPlat.estado==='AVERIADA' && averiadasCount >= 3){
      notify('‚ö†Ô∏è Alto n√∫mero de plataformas averiadas', 'warning');
    }
  }

  // ============== EVENTS ==============
  function updateDateAndGreeting(){
    const d = new Date();
    els.currentDate.textContent = d.toLocaleDateString('es-ES',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    const h = d.getHours();
    els.greeting.textContent = h<12 ? 'Buenos d√≠as üëã' : h<20 ? 'Buenas tardes üåû' : 'Buenas noches üåô';
  }

  function goStep1(){ setStep(1); els.matriculaInput.focus(); }
  function goStep2(){
    const m = els.matriculaInput.value.trim().toUpperCase();
    if(!m){ notify('Introduce una matr√≠cula v√°lida','warning'); return }
    currentMatricula = m;
    els.matriculaDisplay.textContent = m;
    els.matriculaDisplay2.textContent = m;
    setStep(2);
  }
  function goStep3(estado){
    currentEstado = estado;
    els.estadoDisplay.textContent = estado;

    // Si es VAC√çA, registramos directo (sin contenido)
    if(estado==='VAC√çA'){
      // evitar duplicados VAC√çA con la misma matr√≠cula
      if(plataformas.some(p=>p.matricula===currentMatricula && p.estado==='VAC√çA')){
        notify('‚ö†Ô∏è Esta matr√≠cula ya fue registrada como VAC√çA','warning');
        return goStep1();
      }
      const np = {
        id: Date.now(),
        matricula: currentMatricula,
        estado,
        contenido: '',
        timestamp: new Date().toLocaleTimeString('es-ES')
      };
      plataformas.push(np); save(); render(); vibrate(); notify('Registrada como VAC√çA','success'); return goStep1();
    }

    // CARGADA / AVERIADA -> pedir contenido
    setStep(3);
    els.contenidoInput.focus();
  }

  function registrar(){
    const contenido = els.contenidoInput.value.trim();
    if(!contenido){ notify('Describe el contenido o el problema','warning'); return }
    const np = {
      id: Date.now(),
      matricula: currentMatricula,
      estado: currentEstado,
      contenido,
      timestamp: new Date().toLocaleTimeString('es-ES')
    };
    checkCustomAlerts(np);
    plataformas.push(np); save(); render(); vibrate(); notify('Plataforma registrada','success');
    els.contenidoInput.value=''; goStep1();
  }

  // Keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key==='s'){ e.preventDefault(); save(); notify('üíæ Datos guardados','success') }
    if(e.key==='Escape'){ goStep1(); notify('Formulario reseteado','warning') }
    if(currentStep===2 && !e.ctrlKey && !e.metaKey){
      if(e.key==='1') goStep3('CARGADA');
      if(e.key==='2') goStep3('VAC√çA');
      if(e.key==='3') goStep3('AVERIADA');
    }
    if(currentStep===1 && e.key==='Enter') goStep2();
    if(currentStep===3 && e.key==='Enter') registrar();
  });

  // Search
  function applySearchDebounced(){
    clearTimeout(applySearchDebounced.t); applySearchDebounced.t = setTimeout(applySearch, 80);
  }

  // Parallax header
  window.addEventListener('scroll', ()=>{
    const y = window.scrollY * 0.18;
    $('#header').style.transform = `translateY(${Math.min(y, 30)}px)`;
  }, {passive:true});

  // Persist on tab hide/unload
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden') save() });
  window.addEventListener('beforeunload', save);

  // Button bindings
  $('#btnContinuar').addEventListener('click', goStep2);
  $('#btnVolver1').addEventListener('click', goStep1);
  $('#btnVolver2').addEventListener('click', ()=>setStep(2));
  $('#btnRegistrar').addEventListener('click', registrar);
  $('#btnPDF').addEventListener('click', generatePDF);
  $('#btnLimpiar').addEventListener('click', ()=>{
    if(confirm('¬øLimpiar todos los registros?')){
      plataformas.length = 0; save(); render(); goStep1(); notify('Registros eliminados','warning');
    }
  });
  $('[data-estado="CARGADA"]').addEventListener('click', ()=>goStep3('CARGADA'));
  $('[data-estado="VAC√çA"]').addEventListener('click', ()=>goStep3('VAC√çA'));
  $('[data-estado="AVERIADA"]').addEventListener('click', ()=>goStep3('AVERIADA'));
  els.search.addEventListener('input', applySearchDebounced);

  // Boot
  (function init(){
    updateDateAndGreeting();
    load(); render();
    setStep(1);
    setTimeout(()=>{ $('#welcome')?.remove() }, 2600);
  })();
  </script>
</body>
</html>