<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
<title>XPO Logistics — Registro Móvil</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --bg:#f5f6f7;
    --card:#ffffff;
    --ink:#0f0f10;
    --muted:#6b7280;
    --line:#e5e7eb;
    --shadow:0 10px 28px rgba(0,0,0,.08);
    --radius:18px;
    --bezier:cubic-bezier(.24,.8,.25,1);
    /* Colores funcionales (INMUTABLES) */
    --cargada:#22c55e;
    --vacia:#3b82f6;
    --averiada:#ef4444;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:var(--bg); color:var(--ink); -webkit-tap-highlight-color: transparent;
  }
  /* Header */
  header{ position:sticky; top:0; z-index:10; background:linear-gradient(180deg,#fff, #f7f8fa);
    border-bottom:1px solid #ececec; padding:12px 0; backdrop-filter:blur(14px) saturate(140%); }
  .header-inner{ width:min(1100px,94%); margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:12px }
  .brand{ display:flex; gap:10px; align-items:center; padding:10px 14px; background:white; border-radius:14px; box-shadow:var(--shadow) }
  .code{ background:#111; color:#fff; padding:4px 10px; border-radius:12px; font-weight:800 }
  .xpo{ font-weight:800; color:#e11d48 }
  .actions{ display:flex; gap:8px; }

  main{ width:min(1100px,94%); margin:16px auto 96px; }

  .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px; margin-bottom:14px; animation:fade .35s var(--bezier) both }
  @keyframes fade{ from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)} }

  .progress{ display:flex; gap:8px; justify-content:center; margin-bottom:12px }
  .progress div{ width:10px; height:10px; border-radius:999px; background:#d1d5db; transition:.3s var(--bezier) }
  .progress .on{ background:#111; transform:scale(1.2) }

  .row{ display:flex; gap:12px; align-items:center; }
  @media(max-width:560px){ .row{ flex-direction:column } }

  input, textarea{
    width:100%; padding:16px; border-radius:16px; border:1px solid var(--line); background:#fafafa; font-size:17px;
    transition:.25s var(--bezier); -webkit-appearance:none; appearance:none;
  }
  input:focus, textarea:focus{ border-color:#c7d2fe; box-shadow:0 0 0 8px rgba(59,130,246,.12) }
  textarea{ min-height:120px; resize:vertical }

  .btn{ position:relative; overflow:hidden; border:0; border-radius:16px; padding:14px 18px; font-weight:800; background:#111; color:#fff; box-shadow:0 12px 30px rgba(0,0,0,.18); font-size:16px; touch-action:manipulation; }
  .btn:active{ transform:translateY(1px) scale(.99) }
  .btn.ghost{ background:#f1f2f3; color:#111; box-shadow:none }
  .btn.lg{ padding:16px 22px; font-size:17px }
  .ripple{ position:absolute; border-radius:50%; transform:scale(0); animation:rip .6s linear; background:rgba(255,255,255,.35); pointer-events:none }
  @keyframes rip{ to{ transform:scale(4); opacity:0 } }

  .chips{ display:flex; gap:10px; flex-wrap:wrap }
  .chip{ padding:12px 16px; border-radius:16px; background:white; border:1px solid var(--line); box-shadow:var(--shadow); font-weight:800; min-width:110px; text-align:center }
  .chip[data-e="CARGADA"]{ border-color: color-mix(in srgb, var(--cargada) 40%, #ddd) }
  .chip[data-e="VACÍA"]{ border-color: color-mix(in srgb, var(--vacia) 40%, #ddd) }
  .chip[data-e="AVERIADA"]{ border-color: color-mix(in srgb, var(--averiada) 40%, #ddd) }

  .stats{ display:grid; gap:10px; grid-template-columns:repeat(4,1fr) }
  @media(max-width:760px){ .stats{ grid-template-columns:repeat(2,1fr) } }
  .stat{ background:white; border-radius:16px; padding:12px 14px; box-shadow:var(--shadow) }
  .stat .label{ color:var(--muted); font-size:13px }
  .stat .value{ font-size:24px; font-weight:800 }
  .bounce{ animation:b .5s ease }
  @keyframes b{ 0%{transform:scale(1)} 35%{transform:scale(1.06)} 70%{transform:scale(.98)} 100%{transform:scale(1)} }

  .search{ margin:14px 0 }
  .lists{ display:grid; gap:12px; grid-template-columns:repeat(3,1fr) }
  @media(max-width:900px){ .lists{ grid-template-columns:1fr } }

  .panel{ background:white; border-radius:16px; box-shadow:var(--shadow); overflow:hidden }
  .panel h3{ margin:0; padding:12px 14px; border-bottom:1px solid #eee }
  .list{ display:flex; flex-direction:column }
  .item{ padding:14px 16px; display:grid; grid-template-columns:1fr auto; border-bottom:1px solid #f1f1f1; background:linear-gradient(0deg,#fff, #fdfdfd) }
  .pill{ font-size:12px; font-weight:900; color:#fff; padding:6px 10px; border-radius:999px; margin-left:8px }
  .pill[data-t="CARGADA"]{ background:var(--cargada) }
  .pill[data-t="VACÍA"]{ background:var(--vacia) }
  .pill[data-t="AVERIADA"]{ background:var(--averiada) }
  .meta{ color:var(--muted); font-size:12px; margin-top:4px }

  /* Acciones flotantes */
  .float{ position:fixed; right:16px; bottom:16px; display:flex; gap:10px; z-index:100 }
  .fab{ border:0; border-radius:999px; padding:14px 16px; background:#111; color:#fff; font-weight:900; box-shadow:0 12px 30px rgba(0,0,0,.25) }
  .fab .label{ display:inline }
  @media(max-width:520px){ .fab .label{ display:none } }

  /* Toasts */
  .toasts{ position:fixed; left:50%; transform:translateX(-50%); bottom:84px; display:flex; flex-direction:column; gap:8px; z-index:120 }
  .toast{ background:#111; color:#fff; padding:12px 16px; border-radius:16px; box-shadow:var(--shadow) }
  .toast a{ color:#93c5fd; text-decoration:underline }

  /* Estados de validación */
  .ok{ outline:0; box-shadow:0 0 0 8px rgba(34,197,94,.12) !important; border-color: color-mix(in srgb, var(--cargada) 55%, #bbb) !important }
  .bad{ outline:0; box-shadow:0 0 0 8px rgba(239,68,68,.12) !important; border-color: color-mix(in srgb, var(--averiada) 55%, #bbb) !important }
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="brand">
      <div class="code">CODE</div><div class="xpo">XPO Logistics</div>
    </div>
    <div class="actions">
      <button class="btn ghost" id="btnExport" aria-label="Exportar copia de seguridad">Exportar</button>
      <label class="btn ghost" for="fileImport" aria-label="Importar copia de seguridad">Importar<input id="fileImport" type="file" accept="application/json" hidden></label>
    </div>
  </div>
</header>

<main>
  <section class="card" aria-label="Flujo de registro">
    <div class="progress" role="progressbar" aria-valuemin="1" aria-valuemax="3" aria-valuenow="1"><div id="p1" class="on"></div><div id="p2"></div><div id="p3"></div></div>

    <!-- Paso 1 -->
    <div id="s1">
      <div class="row">
        <input id="mat" placeholder="Introduce matrícula (ej: 1234-ABC)" autocomplete="off" inputmode="latin-prose" aria-label="Matrícula">
        <button class="btn lg" id="go2">Continuar</button>
      </div>
      <div class="meta" style="margin-top:6px">Sugerencia: escribe sin guiones o espacios; se formatea automáticamente.</div>
    </div>

    <!-- Paso 2 -->
    <div id="s2" style="display:none">
      <div style="font-weight:900">Matrícula: <span id="matTxt"></span></div>
      <div class="chips" style="margin:12px 0">
        <button class="chip" data-e="CARGADA" aria-label="Marcar como CARGADA">CARGADA</button>
        <button class="chip" data-e="VACÍA" aria-label="Marcar como VACÍA">VACÍA</button>
        <button class="chip" data-e="AVERIADA" aria-label="Marcar como AVERIADA">AVERIADA</button>
      </div>
      <div class="meta">Elegir <b>VACÍA</b> registrará directamente sin pasar por el paso 3.</div>
      <div style="margin-top:10px"><button class="btn ghost" id="back1">Volver</button></div>
    </div>

    <!-- Paso 3 -->
    <div id="s3" style="display:none">
      <textarea id="cont" placeholder="Contenido / incidencia…" aria-label="Contenido"></textarea>
      <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap">
        <button class="btn" id="reg">Registrar</button>
        <button class="btn ghost" id="back2">Volver</button>
      </div>
    </div>
  </section>

  <section class="stats" aria-label="Resumen del día">
    <div class="stat" id="stTotal"><div class="label">Total</div><div class="value">0</div></div>
    <div class="stat" id="stC"><div class="label">Cargadas</div><div class="value">0</div></div>
    <div class="stat" id="stV"><div class="label">Vacías</div><div class="value">0</div></div>
    <div class="stat" id="stA"><div class="label">Averiadas</div><div class="value">0</div></div>
  </section>

  <div class="search"><input id="q" placeholder="Buscar por matrícula o contenido…" aria-label="Buscar"></div>

  <section class="lists" aria-label="Listas de plataformas">
    <article class="panel">
      <h3>Cargadas</h3>
      <div class="list" id="lc" aria-live="polite"></div>
    </article>
    <article class="panel">
      <h3>Vacías</h3>
      <div class="list" id="lv" aria-live="polite"></div>
    </article>
    <article class="panel">
      <h3>Averiadas</h3>
      <div class="list" id="la" aria-live="polite"></div>
    </article>
  </section>

  <div style="margin-top:12px; display:flex; justify-content:flex-end">
    <button class="btn ghost" id="clear">Limpiar registros</button>
  </div>
</main>

<div class="float">
  <button class="fab" id="pdf" title="Generar PDF">PDF <span class="label">diario</span></button>
</div>

<div class="toasts" id="toasts" aria-live="polite"></div>

<script>
(function(){
  const LS="plataformas-global";
  const $=s=>document.querySelector(s); const $$=s=>document.querySelectorAll(s);
  // Estado temporal
  let mat=""; let est=null;
  // Undo borrado
  let lastDeleted=null;

  // Haptics helper
  const buzz = ms => { if(navigator.vibrate) try{ navigator.vibrate(ms); }catch(_){} };

  // Ripple global
  document.addEventListener("click", e=>{
    const t=e.target.closest(".btn, .chip, .fab");
    if(!t) return;
    const r=document.createElement("span"); r.className="ripple";
    const rect=t.getBoundingClientRect(); const size=Math.max(rect.width, rect.height);
    r.style.width=r.style.height=size+'px';
    r.style.left=(e.clientX-rect.left-size/2)+'px';
    r.style.top=(e.clientY-rect.top-size/2)+'px';
    t.appendChild(r); setTimeout(()=>r.remove(), 600);
  }, {passive:true});

  // Utilidades LS
  const load = ()=>{ try{ return JSON.parse(localStorage.getItem(LS)||"[]")}catch(_){return[]} };
  const saveAll = a => { localStorage.setItem(LS, JSON.stringify(a)); bounce(); render(); };

  // Formato matrícula español básico (####-XXX o ####XXX) -> ####-XXX
  function formatMat(v){
    v = v.toUpperCase().replace(/[^A-Z0-9]/g,"");
    const nums = v.replace(/[^0-9]/g,"").slice(0,4);
    const letters = v.replace(/[^A-Z]/g,"").slice(0,3);
    return nums + (letters ? "-" + letters : "");
  }
  function isValidMat(v){
    return /^[0-9]{4}-[A-Z]{3}$/.test(v);
  }

  // Pasos
  const setStep = n => {
    $("#s1").style.display = n===1?"block":"none";
    $("#s2").style.display = n===2?"block":"none";
    $("#s3").style.display = n===3?"block":"none";
    $("#p1").classList.toggle("on", n>=1);
    $("#p2").classList.toggle("on", n>=2);
    $("#p3").classList.toggle("on", n>=3);
    $(".progress").setAttribute("aria-valuenow", String(n));
  };

  // Input matrícula con formato y validación live
  const matInput = $("#mat");
  matInput.addEventListener("input", ()=>{
    const cur = matInput.selectionStart;
    const before = matInput.value;
    const formatted = formatMat(before);
    matInput.value = formatted;
    // feedback
    matInput.classList.remove("ok","bad");
    if(formatted.length>=6){
      matInput.classList.add(isValidMat(formatted)?"ok":"bad");
    }
  });

  // Botones flujo
  $("#go2").addEventListener("click", ()=>{
    const v=matInput.value.trim().toUpperCase();
    if(!isValidMat(v)){ toast("Matrícula inválida (formato ####-XXX)"); matInput.focus(); buzz(15); return; }
    mat=v; $("#matTxt").textContent=mat; setStep(2); buzz(8);
  });
  $("#back1").addEventListener("click", ()=> { setStep(1); buzz(5); });
  $("#back2").addEventListener("click", ()=> { setStep(2); buzz(5); });

  // Selección de estado
  $$(".chip").forEach(ch=>{
    ch.addEventListener("click", ()=> choose(ch.dataset.e));
  });
  function choose(estado){
    est=estado;
    if(est==="VACÍA"){
      const arr=load();
      const dup=arr.some(x=>x.estado==="VACÍA" && x.matricula===mat);
      if(dup){ toast("Ya existe una VACÍA con esa matrícula"); buzz(30); return; }
      arr.unshift(item(mat,"VACÍA","—"));
      saveAll(arr);
      reset(true);
      toast("Registrada como VACÍA");
      buzz(10);
      return;
    }
    setStep(3);
    $("#cont").focus();
    buzz(8);
  }

  // Registrar (CARGADA / AVERIADA requieren contenido)
  $("#reg").addEventListener("click", ()=>{
    const text=$("#cont").value.trim();
    if(est!=="CARGADA" && est!=="AVERIADA"){ toast("Selecciona un estado"); buzz(20); return; }
    if(!text){ toast("Contenido requerido para "+est); $("#cont").focus(); buzz(20); return; }
    const arr=load();
    arr.unshift(item(mat, est, text));
    saveAll(arr);
    reset(true);
    toast("Registro guardado");
    buzz(10);
  });

  function item(matricula, estado, contenido){
    return { id:Date.now().toString(36)+Math.random().toString(36).slice(2,7),
      matricula, estado, contenido, timestamp:new Date().toISOString() };
  }
  function reset(clear){
    if(clear){ $("#mat").value=""; $("#cont").value=""; $("#mat").classList.remove("ok","bad"); }
    mat=""; est=null; setStep(1); $("#mat").focus();
  }

  // Render
  function render(){
    const q=$("#q").value.trim().toLowerCase();
    const a=load();
    const groups={
      CARGADA:a.filter(x=>x.estado==="CARGADA"),
      "VACÍA":a.filter(x=>x.estado==="VACÍA"),
      AVERIADA:a.filter(x=>x.estado==="AVERIADA")
    };
    const fil=x=> !q || x.matricula.toLowerCase().includes(q) || x.contenido.toLowerCase().includes(q);

    draw("#lc", groups.CARGADA.filter(fil));
    draw("#lv", groups["VACÍA"].filter(fil));
    draw("#la", groups.AVERIADA.filter(fil));

    $("#stTotal .value").textContent = a.length;
    $("#stC .value").textContent = groups.CARGADA.length;
    $("#stV .value").textContent = groups["VACÍA"].length;
    $("#stA .value").textContent = groups.AVERIADA.length;
  }
  function draw(sel, arr){
    const box=$(sel); box.innerHTML="";
    if(arr.length===0){ const m=document.createElement("div"); m.className="meta"; m.style.padding="10px"; m.textContent="Sin registros…"; box.appendChild(m); return; }
    arr.sort((a,b)=>b.timestamp.localeCompare(a.timestamp));
    arr.forEach(x=>{
      const row=document.createElement("div"); row.className="item"; row.dataset.id=x.id;
      const left=document.createElement("div");
      left.innerHTML = `<div><b>${x.matricula}</b><span class="pill" data-t="${x.estado}">${x.estado}</span></div>
                        <div class="meta">${x.contenido} • ${new Date(x.timestamp).toLocaleString()}</div>`;
      const right=document.createElement("div");
      const del=document.createElement("button"); del.className="btn ghost"; del.textContent="Eliminar"; del.setAttribute("aria-label", "Eliminar registro");
      del.addEventListener("click", ()=> deleteItem(x.id));
      right.appendChild(del);
      row.appendChild(left); row.appendChild(right);

      // Gestos swipe (solo móvil táctil)
      let startX=0, trans=0, swiping=false;
      row.addEventListener("touchstart", e=>{ startX=e.touches[0].clientX; row.classList.add("swiping"); }, {passive:true});
      row.addEventListener("touchmove", e=>{
        if(!startX) return;
        const dx=e.touches[0].clientX-startX;
        if(Math.abs(dx)>6){ swiping=true; trans=Math.min(Math.max(dx,-120),120); row.style.transform=`translateX(${trans}px)`; }
      }, {passive:true});
      row.addEventListener("touchend", ()=>{
        row.classList.remove("swiping");
        if(swiping && Math.abs(trans)>80){ deleteItem(x.id); }
        row.style.transform=""; startX=0; trans=0; swiping=false;
      });
      box.appendChild(row);
    });
  }

  function deleteItem(id){
    const arr=load();
    const idx=arr.findIndex(x=>x.id===id);
    if(idx<0) return;
    lastDeleted=arr[idx];
    arr.splice(idx,1);
    saveAll(arr);
    toast(`Registro eliminado • <a href="#" id="undo">Deshacer</a>`, 3500, true);
    buzz(15);
    setTimeout(()=>{
      const u=$("#undo"); if(u){ u.onclick=(e)=>{ e.preventDefault(); undoDelete(); }; }
    },0);
  }
  function undoDelete(){
    if(!lastDeleted) return;
    const arr=load();
    arr.unshift(lastDeleted);
    saveAll(arr);
    lastDeleted=null;
    toast("Restaurado");
  }

  function bounce(){
    ["#stTotal","#stC","#stV","#stA"].forEach(sel=>{
      const el=$(sel);
      el.classList.remove("bounce"); void el.offsetWidth; el.classList.add("bounce");
    });
    buzz(8);
  }

  // Buscador
  $("#q").addEventListener("input", render);

  // Limpiar
  $("#clear").addEventListener("click", ()=>{
    if(confirm("¿Seguro que quieres borrar todos los registros?")){
      localStorage.removeItem(LS); render(); toast("Registros eliminados"); buzz(20);
    }
  });

  // Exportar / Importar (Backup/Restore)
  $("#btnExport").addEventListener("click", ()=>{
    const blob = new Blob([localStorage.getItem(LS)||"[]"], {type:"application/json"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob);
    a.download="plataformas-backup-"+new Date().toISOString().slice(0,10)+".json";
    document.body.appendChild(a); a.click(); a.remove();
    toast("Backup exportado");
  });
  $("#fileImport").addEventListener("change", async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const text = await file.text();
    try{
      const arr=JSON.parse(text);
      if(!Array.isArray(arr)) throw new Error("Formato no válido");
      localStorage.setItem(LS, JSON.stringify(arr));
      render(); toast("Backup importado");
    }catch(_){ toast("Archivo inválido"); }
    e.target.value="";
  });

  // PDF (con opción de compartir si el navegador lo permite)
  $("#pdf").addEventListener("click", async ()=>{
    const data=load();
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt", format:"a4" });

    doc.setFont("helvetica","bold"); doc.setFontSize(18);
    doc.text("CODE", 40, 40); doc.setFontSize(14); doc.text("+ XPO Logistics", 100, 40);
    doc.setFontSize(10); doc.setTextColor(120); doc.text(new Date().toLocaleString(), 40, 58); doc.setTextColor(0);

    // Badges estadísticas
    const s=[
      ["Total", String(data.length)],
      ["Cargadas", String(data.filter(x=>x.estado==='CARGADA').length)],
      ["Vacías", String(data.filter(x=>x.estado==='VACÍA').length)],
      ["Averiadas", String(data.filter(x=>x.estado==='AVERIADA').length)],
    ];
    let x=40,y=80;
    s.forEach(([k,v])=>{ doc.setDrawColor(230); doc.roundedRect(x,y-14,120,22,6,6); doc.setFontSize(11); doc.setFont("helvetica","bold"); doc.text(`${k}: ${v}`, x+10, y); x+=130; });

    const sections=[
      { t:"CARGADAS", color:[34,197,94], rows:data.filter(x=>x.estado==="CARGADA") },
      { t:"VACÍAS", color:[59,130,246], rows:data.filter(x=>x.estado==="VACÍA") },
      { t:"AVERIADAS", color:[239,68,68], rows:data.filter(x=>x.estado==="AVERIADA") },
    ];
    let startY=130;
    sections.forEach(sec=>{
      doc.setTextColor(...sec.color); doc.setFontSize(13); doc.setFont("helvetica","bold"); doc.text(sec.t, 40, startY); doc.setTextColor(0);
      const body = sec.rows.map(r=>[r.matricula, r.contenido, new Date(r.timestamp).toLocaleString()]);
      doc.autoTable({ head:[["Matrícula","Contenido","Fecha/Hora"]], body, startY:startY+10, margin:{left:40, right:40}, styles:{font:"helvetica", fontSize:10}, headStyles:{ fillColor:sec.color }, theme:"striped" });
      startY = doc.lastAutoTable.finalY + 24;
      if(startY > 720){ doc.addPage(); startY = 60; }
    });
    const pages=doc.internal.getNumberOfPages();
    for(let i=1;i<=pages;i++){ doc.setPage(i); doc.setFontSize(9); doc.setTextColor(120);
      doc.text("Generado desde el registro local", 40, doc.internal.pageSize.getHeight()-30);
      doc.text(String(i)+" / "+String(pages), doc.internal.pageSize.getWidth()-60, doc.internal.pageSize.getHeight()-30);
    }

    const blob = doc.output("blob");
    const file = new File([blob], "registro-plataformas.pdf", {type:"application/pdf"});
    // Intentar compartir
    if(navigator.canShare && navigator.canShare({ files:[file] })){
      try{ await navigator.share({ files:[file], title:"Registro plataformas", text:"PDF generado" }); }
      catch(_){ /* usuario canceló */ }
    }else{
      // Fallback: descarga
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download=file.name; a.click(); URL.revokeObjectURL(url);
      toast("PDF descargado");
    }
  });

  // Toasts
  function toast(msg, t=1800, html=false){
    const box=$("#toasts");
    const el=document.createElement("div"); el.className="toast";
    if(html){ el.innerHTML=msg; } else { el.textContent=msg; }
    box.appendChild(el);
    setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(6px)"; setTimeout(()=> el.remove(), 280); }, t);
  }

  // PWA básico (manifest + service worker en runtime)
  try{
    const manifest = {
      name: "Registro XPO (local)",
      short_name: "Registro XPO",
      start_url: ".",
      display: "standalone",
      background_color: "#ffffff",
      theme_color: "#ffffff",
      icons: []
    };
    const link=document.createElement("link");
    link.rel="manifest";
    const blob=new Blob([JSON.stringify(manifest)], {type:"application/json"});
    link.href=URL.createObjectURL(blob);
    document.head.appendChild(link);

    if("serviceWorker" in navigator){
      const swCode = `
        const CACHE='xpo-cache-v1';
        const ASSETS = ['.'];
        self.addEventListener('install', e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS))); self.skipWaiting(); });
        self.addEventListener('activate', e=>{ e.waitUntil(self.clients.claim()); });
        self.addEventListener('fetch', e=>{
          e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request).then(res=>{
            const copy=res.clone(); caches.open(CACHE).then(c=> c.put(e.request, copy)).catch(()=>{});
            return res;
          }).catch(()=> r )));
        });
      `;
      const swBlob = new Blob([swCode], {type:"text/javascript"});
      const swUrl = URL.createObjectURL(swBlob);
      navigator.serviceWorker.register(swUrl).catch(()=>{});
    }
  }catch(_){}

  // Init
  render();
  $("#mat").focus({preventScroll:true});
})();
</script>

</body>
</html>
